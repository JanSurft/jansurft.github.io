<?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom" ><generator uri="https://jekyllrb.com/" version="3.8.5">Jekyll</generator><link href="https://blog.hermes-technology.de/feed.xml" rel="self" type="application/atom+xml" /><link href="https://blog.hermes-technology.de/" rel="alternate" type="text/html" /><updated>2020-03-29T13:11:15+02:00</updated><id>https://blog.hermes-technology.de/feed.xml</id><title type="html">Hermes Technology Blog</title><subtitle>This is a blog about technology. I will write about the experiences I encounter, when working on my server infrastructure, building roboter(s), or developing any kind of software on the way.
</subtitle><entry><title type="html">Running Docker on an Alpine VM</title><link href="https://blog.hermes-technology.de/openbsd/server/virtualmachine/docker/alpine/2020/03/25/my-open-bsdserver-5-running-docker-on-alpine-vm.html" rel="alternate" type="text/html" title="Running Docker on an Alpine VM" /><published>2020-03-25T15:00:00+01:00</published><updated>2020-03-25T15:00:00+01:00</updated><id>https://blog.hermes-technology.de/openbsd/server/virtualmachine/docker/alpine/2020/03/25/my-open-bsdserver-5-running-docker-on-alpine-vm</id><content type="html" xml:base="https://blog.hermes-technology.de/openbsd/server/virtualmachine/docker/alpine/2020/03/25/my-open-bsdserver-5-running-docker-on-alpine-vm.html">&lt;div id=&quot;toc&quot;&gt;

&lt;/div&gt;
&lt;h2 id=&quot;intro&quot;&gt;Intro&lt;/h2&gt;
&lt;p&gt;Meanwhile I have update my OpenBSD Server to version 6.6, so some commands look different from before (&lt;code&gt;vmctl&lt;/code&gt; uses a different ordering of arguments). All in all the whole &lt;code&gt;vmd&lt;/code&gt; interactions feel a lot more stable and mature than before.&lt;/p&gt;
&lt;h2 id=&quot;create-an-alpine-vm&quot;&gt;Create an Alpine VM&lt;/h2&gt;
&lt;h3 id=&quot;create-the-disk-and-start-the-installation&quot;&gt;Create the disk and start the installation&lt;/h3&gt;
&lt;p&gt;The procedure is similar to what I described in my other post about creating virtual machines, though as mentioned before the &lt;code&gt;vmctl&lt;/code&gt; has a slightly different syntax now.&lt;/p&gt;
&lt;p&gt;Note also that the last command in the code-block below uses the virtual network called &lt;code&gt;localnet&lt;/code&gt; which I set up for the VM network in a &lt;a href=&quot;/openbsd/server/virtualmachine/network/2017/06/12/vmd-for-a-virtual-server-network.html&quot;&gt;previous post&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;The &lt;code&gt;vmctl start&lt;/code&gt; command in the end means the following:&lt;/p&gt;
&lt;ol type=&quot;1&quot;&gt;
&lt;li&gt;&lt;code&gt;-c&lt;/code&gt;: Connect to a virtual console after starting&lt;/li&gt;
&lt;li&gt;&lt;code&gt;-B cdrom&lt;/code&gt;: Boot from a supplied cdrom iso if exists&lt;/li&gt;
&lt;li&gt;&lt;code&gt;-r alpine-virt-3.11.5-x86_64.iso&lt;/code&gt;: Use the supplied iso as cdrom data&lt;/li&gt;
&lt;li&gt;&lt;code&gt;-d alpine.drive&lt;/code&gt;: Use the raw disk drive we created&lt;/li&gt;
&lt;li&gt;&lt;code&gt;-m 2G&lt;/code&gt;: With 2 Gigabyte of virtual ram&lt;/li&gt;
&lt;li&gt;&lt;code&gt;-n localnet&lt;/code&gt;: Connecting to the virtual bridge network called &lt;code&gt;localnet&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;alpine-vm&lt;/code&gt;: Name the VM &amp;quot;alpine-vm&amp;quot;&lt;/li&gt;
&lt;/ol&gt;
&lt;div class=&quot;sourceCode&quot;&gt;&lt;pre class=&quot;sourceCode sh&quot;&gt;&lt;code class=&quot;sourceCode bash&quot;&gt;
&lt;span class=&quot;co&quot;&gt;# replace v3.11 with the latest version of alpine&lt;/span&gt;

&lt;span class=&quot;ex&quot;&gt;doas&lt;/span&gt; ftp https://nl.alpinelinux.org/alpine/v3.11/releases/x86_64/alpine-virt-3.11.5-x86_64.iso
&lt;span class=&quot;ex&quot;&gt;doas&lt;/span&gt; ftp https://nl.alpinelinux.org/alpine/v3.11/releases/x86_64/alpine-virt-3.11.5-x86_64.iso.sha256

&lt;span class=&quot;co&quot;&gt;# verify correct signature&lt;/span&gt;
&lt;span class=&quot;fu&quot;&gt;diff&lt;/span&gt; &lt;span class=&quot;op&quot;&gt;&amp;lt;(&lt;/span&gt;&lt;span class=&quot;ex&quot;&gt;sha256&lt;/span&gt; -q alpine-virt-3.11.5-x86_64.iso&lt;span class=&quot;op&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;op&quot;&gt;&amp;lt;(&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;cat&lt;/span&gt; alpine-virt-3.11.5-x86_64.iso.sha256&lt;span class=&quot;op&quot;&gt;)&lt;/span&gt;

&lt;span class=&quot;co&quot;&gt;# create the raw disk file for alpine to install on&lt;/span&gt;
&lt;span class=&quot;ex&quot;&gt;doas&lt;/span&gt; vmctl create -s 8G alpine.drive

&lt;span class=&quot;co&quot;&gt;# start the vm with boot rom&lt;/span&gt;
&lt;span class=&quot;ex&quot;&gt;doas&lt;/span&gt; vmctl start -c -B cdrom -r alpine-virt-3.11.5-x86_64.iso -d alpine.drive -m 2G -n localnet alpine-vm&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3 id=&quot;installation-of-the-alpine-os-inside-the-alpine-vm&quot;&gt;Installation of the alpine os inside the Alpine-VM&lt;/h3&gt;
&lt;p&gt;After the booting-process I logged into the VM as &lt;code&gt;root&lt;/code&gt; user (without any password), and set up the network interfaces, for accessing online package resources during the installation.&lt;/p&gt;
&lt;p&gt;The setting of IP-Addresses, gateways, nameserver all is oriented at a &lt;a href=&quot;/openbsd/server/virtualmachine/network/2017/06/12/vmd-for-a-virtual-server-network.html&quot;&gt;previous post&lt;/a&gt;, in which I set up the VM-network that I use on my server.&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot;&gt;&lt;pre class=&quot;sourceCode sh&quot;&gt;&lt;code class=&quot;sourceCode bash&quot;&gt;
&lt;span class=&quot;co&quot;&gt;# set up the network interfaces itself&lt;/span&gt;
&lt;span class=&quot;ex&quot;&gt;localhost&lt;/span&gt;:~# setup-interfaces

&lt;span class=&quot;ex&quot;&gt;Available&lt;/span&gt; interfaces are: eth0.
&lt;span class=&quot;ex&quot;&gt;Enter&lt;/span&gt; &lt;span class=&quot;st&quot;&gt;&amp;#39;?&amp;#39;&lt;/span&gt; for help on bridges, bonding and vlans.
&lt;span class=&quot;ex&quot;&gt;Which&lt;/span&gt; one do you want to initialize? (or &lt;span class=&quot;st&quot;&gt;&amp;#39;?&amp;#39;&lt;/span&gt; or &lt;span class=&quot;st&quot;&gt;&amp;#39;done&amp;#39;&lt;/span&gt;) [&lt;span class=&quot;ex&quot;&gt;eth0&lt;/span&gt;]

&lt;span class=&quot;ex&quot;&gt;Ip&lt;/span&gt; address for eth0? (or &lt;span class=&quot;st&quot;&gt;&amp;#39;dhcp&amp;#39;&lt;/span&gt;, &lt;span class=&quot;st&quot;&gt;&amp;#39;none&amp;#39;&lt;/span&gt;, &lt;span class=&quot;st&quot;&gt;&amp;#39;?&amp;#39;&lt;/span&gt;) [&lt;span class=&quot;ex&quot;&gt;dhcp&lt;/span&gt;] 192.168.30.6

&lt;span class=&quot;ex&quot;&gt;Netmask?&lt;/span&gt; [255.255.255.0]

&lt;span class=&quot;ex&quot;&gt;Gateway?&lt;/span&gt; (or &lt;span class=&quot;st&quot;&gt;&amp;#39;none&amp;#39;&lt;/span&gt;) [&lt;span class=&quot;ex&quot;&gt;none&lt;/span&gt;] 192.168.30.1

&lt;span class=&quot;ex&quot;&gt;Configuration&lt;/span&gt; for eth0:
  &lt;span class=&quot;va&quot;&gt;type=&lt;/span&gt;static
  &lt;span class=&quot;va&quot;&gt;address=&lt;/span&gt;192.168.30.6
  &lt;span class=&quot;va&quot;&gt;netmask=&lt;/span&gt;255.255.255.0
  &lt;span class=&quot;va&quot;&gt;gateway=&lt;/span&gt;192.168.30.1

&lt;span class=&quot;ex&quot;&gt;Do&lt;/span&gt; you want to do any manual network configuration? [no]&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;div class=&quot;sourceCode&quot;&gt;&lt;pre class=&quot;sourceCode sh&quot;&gt;&lt;code class=&quot;sourceCode bash&quot;&gt;&lt;span class=&quot;co&quot;&gt;# set up the nameserver&lt;/span&gt;
&lt;span class=&quot;ex&quot;&gt;localhost&lt;/span&gt;:~# setup-dns

&lt;span class=&quot;ex&quot;&gt;DNS&lt;/span&gt; domain name? (e.g &lt;span class=&quot;st&quot;&gt;&amp;#39;bar.com&amp;#39;&lt;/span&gt;) [] &lt;span class=&quot;ex&quot;&gt;hermes-technology.de&lt;/span&gt;

&lt;span class=&quot;ex&quot;&gt;DNS&lt;/span&gt; nameserver(s)&lt;span class=&quot;ex&quot;&gt;?&lt;/span&gt; [] 192.168.30.1&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;After I was making sure that my networking was working (via a &lt;code&gt;ping google.com&lt;/code&gt;), I just started the installation choosing the commands shown below.&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot;&gt;&lt;pre class=&quot;sourceCode sh&quot;&gt;&lt;code class=&quot;sourceCode bash&quot;&gt;
&lt;span class=&quot;ex&quot;&gt;localhost&lt;/span&gt;:~# setup-alpine
&lt;span class=&quot;ex&quot;&gt;Available&lt;/span&gt; keyboard layouts:
&lt;span class=&quot;ex&quot;&gt;af&lt;/span&gt;     be     cn     fi     hu     it     lk     mm     pl     sy     uz
&lt;span class=&quot;ex&quot;&gt;al&lt;/span&gt;     bg     cz     fo     id     jp     lt     mt     pt     th     vn
&lt;span class=&quot;ex&quot;&gt;am&lt;/span&gt;     br     de     fr     ie     ke     lv     my     ro     tj
&lt;span class=&quot;ex&quot;&gt;ara&lt;/span&gt;    brai   dk     gb     il     kg     ma     ng     rs     tm
&lt;span class=&quot;ex&quot;&gt;at&lt;/span&gt;     by     dz     ge     in     kr     md     nl     ru     tr
&lt;span class=&quot;ex&quot;&gt;az&lt;/span&gt;     ca     ee     gh     iq     kz     me     no     se     tw
&lt;span class=&quot;ex&quot;&gt;ba&lt;/span&gt;     ch     epo    gr     ir     la     mk     ph     si     ua
&lt;span class=&quot;ex&quot;&gt;bd&lt;/span&gt;     cm     es     hr     is     latam  ml     pk     sk     us
&lt;span class=&quot;ex&quot;&gt;Select&lt;/span&gt; keyboard layout [none]: de
&lt;span class=&quot;ex&quot;&gt;Available&lt;/span&gt; variants: de-T3 de-deadacute de-deadgraveacute de-deadtilde de-dsb de-dsb_qwertz de-dvorak de-mac de-mac_nodeadkeys de-neo de-nodeadkeys de-qwerty de-ro de-ro_nodeadkeys de-ru de-sundeadkeys de-tr de
&lt;span class=&quot;ex&quot;&gt;Select&lt;/span&gt; variant []: de
 &lt;span class=&quot;ex&quot;&gt;*&lt;/span&gt; Caching service dependencies ...
&lt;span class=&quot;bu&quot;&gt; [&lt;/span&gt; ok&lt;span class=&quot;bu&quot;&gt; ]&lt;/span&gt;
 &lt;span class=&quot;ex&quot;&gt;*&lt;/span&gt; Setting keymap ...
&lt;span class=&quot;bu&quot;&gt; [&lt;/span&gt; ok&lt;span class=&quot;bu&quot;&gt; ]&lt;/span&gt;
&lt;span class=&quot;ex&quot;&gt;Enter&lt;/span&gt; system hostname (short form, e.g. &lt;span class=&quot;st&quot;&gt;&amp;#39;foo&amp;#39;&lt;/span&gt;) [&lt;span class=&quot;ex&quot;&gt;localhost&lt;/span&gt;]: services
&lt;span class=&quot;ex&quot;&gt;Available&lt;/span&gt; interfaces are: eth0.
&lt;span class=&quot;ex&quot;&gt;Enter&lt;/span&gt; &lt;span class=&quot;st&quot;&gt;&amp;#39;?&amp;#39;&lt;/span&gt; for help on bridges, bonding and vlans.
&lt;span class=&quot;ex&quot;&gt;Which&lt;/span&gt; one do you want to initialize? (or &lt;span class=&quot;st&quot;&gt;&amp;#39;?&amp;#39;&lt;/span&gt; or &lt;span class=&quot;st&quot;&gt;&amp;#39;done&amp;#39;&lt;/span&gt;) [&lt;span class=&quot;ex&quot;&gt;eth0&lt;/span&gt;]
&lt;span class=&quot;ex&quot;&gt;Ip&lt;/span&gt; address for eth0? (or &lt;span class=&quot;st&quot;&gt;&amp;#39;dhcp&amp;#39;&lt;/span&gt;, &lt;span class=&quot;st&quot;&gt;&amp;#39;none&amp;#39;&lt;/span&gt;, &lt;span class=&quot;st&quot;&gt;&amp;#39;?&amp;#39;&lt;/span&gt;) [&lt;span class=&quot;ex&quot;&gt;192.168.30.6&lt;/span&gt;]
&lt;span class=&quot;ex&quot;&gt;Netmask?&lt;/span&gt; [255.255.255.0]
&lt;span class=&quot;ex&quot;&gt;Gateway?&lt;/span&gt; (or &lt;span class=&quot;st&quot;&gt;&amp;#39;none&amp;#39;&lt;/span&gt;) [&lt;span class=&quot;ex&quot;&gt;192.168.30.1&lt;/span&gt;]
&lt;span class=&quot;ex&quot;&gt;Configuration&lt;/span&gt; for eth0:
  &lt;span class=&quot;va&quot;&gt;type=&lt;/span&gt;static
  &lt;span class=&quot;va&quot;&gt;address=&lt;/span&gt;192.168.30.6
  &lt;span class=&quot;va&quot;&gt;netmask=&lt;/span&gt;255.255.255.0
  &lt;span class=&quot;va&quot;&gt;gateway=&lt;/span&gt;192.168.30.1
&lt;span class=&quot;ex&quot;&gt;Do&lt;/span&gt; you want to do any manual network configuration? [no]
&lt;span class=&quot;ex&quot;&gt;ifup&lt;/span&gt;: interface eth0 already configured
&lt;span class=&quot;ex&quot;&gt;DNS&lt;/span&gt; domain name? (e.g &lt;span class=&quot;st&quot;&gt;&amp;#39;bar.com&amp;#39;&lt;/span&gt;) [] &lt;span class=&quot;ex&quot;&gt;hermes-technology.de&lt;/span&gt;
&lt;span class=&quot;ex&quot;&gt;DNS&lt;/span&gt; nameserver(s)&lt;span class=&quot;ex&quot;&gt;?&lt;/span&gt; [192.168.30.1 ]
&lt;span class=&quot;ex&quot;&gt;Changing&lt;/span&gt; password for root
&lt;span class=&quot;ex&quot;&gt;New&lt;/span&gt; password:
&lt;span class=&quot;ex&quot;&gt;Retype&lt;/span&gt; password:
&lt;span class=&quot;ex&quot;&gt;passwd&lt;/span&gt;: password for root changed by root
&lt;span class=&quot;ex&quot;&gt;Which&lt;/span&gt; timezone are you in? (&lt;span class=&quot;st&quot;&gt;&amp;#39;?&amp;#39;&lt;/span&gt; for list) [&lt;span class=&quot;ex&quot;&gt;UTC&lt;/span&gt;] Europe/Berlin
 &lt;span class=&quot;ex&quot;&gt;*&lt;/span&gt; Starting busybox acpid ...
&lt;span class=&quot;bu&quot;&gt; [&lt;/span&gt; ok&lt;span class=&quot;bu&quot;&gt; ]&lt;/span&gt;
 &lt;span class=&quot;ex&quot;&gt;*&lt;/span&gt; Starting busybox crond ...
&lt;span class=&quot;bu&quot;&gt; [&lt;/span&gt; ok&lt;span class=&quot;bu&quot;&gt; ]&lt;/span&gt;
&lt;span class=&quot;ex&quot;&gt;HTTP/FTP&lt;/span&gt; proxy URL? (e.g. &lt;span class=&quot;st&quot;&gt;&amp;#39;http://proxy:8080&amp;#39;&lt;/span&gt;, or &lt;span class=&quot;st&quot;&gt;&amp;#39;none&amp;#39;&lt;/span&gt;) [&lt;span class=&quot;ex&quot;&gt;none&lt;/span&gt;]
&lt;span class=&quot;ex&quot;&gt;Which&lt;/span&gt; NTP client to run? (&lt;span class=&quot;st&quot;&gt;&amp;#39;busybox&amp;#39;&lt;/span&gt;, &lt;span class=&quot;st&quot;&gt;&amp;#39;openntpd&amp;#39;&lt;/span&gt;, &lt;span class=&quot;st&quot;&gt;&amp;#39;chrony&amp;#39;&lt;/span&gt; or &lt;span class=&quot;st&quot;&gt;&amp;#39;none&amp;#39;&lt;/span&gt;) [&lt;span class=&quot;ex&quot;&gt;chrony&lt;/span&gt;]
 &lt;span class=&quot;ex&quot;&gt;*&lt;/span&gt; service chronyd added to runlevel default
 &lt;span class=&quot;ex&quot;&gt;*&lt;/span&gt; Caching service dependencies ...
&lt;span class=&quot;bu&quot;&gt; [&lt;/span&gt; ok&lt;span class=&quot;bu&quot;&gt; ]&lt;/span&gt;
 &lt;span class=&quot;ex&quot;&gt;*&lt;/span&gt; Starting chronyd ...
&lt;span class=&quot;bu&quot;&gt; [&lt;/span&gt; ok&lt;span class=&quot;bu&quot;&gt; ]&lt;/span&gt;

&lt;span class=&quot;ex&quot;&gt;Available&lt;/span&gt; mirrors:
&lt;span class=&quot;ex&quot;&gt;1&lt;/span&gt;) &lt;span class=&quot;ex&quot;&gt;dl-cdn.alpinelinux.org&lt;/span&gt;
&lt;span class=&quot;ex&quot;&gt;2&lt;/span&gt;) &lt;span class=&quot;ex&quot;&gt;uk.alpinelinux.org&lt;/span&gt;
&lt;span class=&quot;ex&quot;&gt;3&lt;/span&gt;) &lt;span class=&quot;ex&quot;&gt;dl-2.alpinelinux.org&lt;/span&gt;
&lt;span class=&quot;ex&quot;&gt;4&lt;/span&gt;) &lt;span class=&quot;ex&quot;&gt;dl-4.alpinelinux.org&lt;/span&gt;
&lt;span class=&quot;ex&quot;&gt;5&lt;/span&gt;) &lt;span class=&quot;ex&quot;&gt;dl-5.alpinelinux.org&lt;/span&gt;
&lt;span class=&quot;ex&quot;&gt;6&lt;/span&gt;) &lt;span class=&quot;ex&quot;&gt;dl-8.alpinelinux.org&lt;/span&gt;
&lt;span class=&quot;ex&quot;&gt;7&lt;/span&gt;) &lt;span class=&quot;ex&quot;&gt;mirror.yandex.ru&lt;/span&gt;
&lt;span class=&quot;ex&quot;&gt;8&lt;/span&gt;) &lt;span class=&quot;ex&quot;&gt;mirrors.gigenet.com&lt;/span&gt;
&lt;span class=&quot;ex&quot;&gt;9&lt;/span&gt;) &lt;span class=&quot;ex&quot;&gt;mirror1.hs-esslingen.de&lt;/span&gt;
&lt;span class=&quot;ex&quot;&gt;10&lt;/span&gt;) &lt;span class=&quot;ex&quot;&gt;mirror.leaseweb.com&lt;/span&gt;
&lt;span class=&quot;ex&quot;&gt;11&lt;/span&gt;) &lt;span class=&quot;ex&quot;&gt;mirror.fit.cvut.cz&lt;/span&gt;
&lt;span class=&quot;ex&quot;&gt;12&lt;/span&gt;) &lt;span class=&quot;ex&quot;&gt;alpine.mirror.far.fi&lt;/span&gt;
&lt;span class=&quot;ex&quot;&gt;13&lt;/span&gt;) &lt;span class=&quot;ex&quot;&gt;alpine.mirror.wearetriple.com&lt;/span&gt;
&lt;span class=&quot;ex&quot;&gt;14&lt;/span&gt;) &lt;span class=&quot;ex&quot;&gt;mirror.clarkson.edu&lt;/span&gt;
&lt;span class=&quot;ex&quot;&gt;15&lt;/span&gt;) &lt;span class=&quot;ex&quot;&gt;linorg.usp.br&lt;/span&gt;
&lt;span class=&quot;ex&quot;&gt;16&lt;/span&gt;) &lt;span class=&quot;ex&quot;&gt;ftp.yzu.edu.tw&lt;/span&gt;
&lt;span class=&quot;ex&quot;&gt;17&lt;/span&gt;) &lt;span class=&quot;ex&quot;&gt;mirror.aarnet.edu.au&lt;/span&gt;
&lt;span class=&quot;ex&quot;&gt;18&lt;/span&gt;) &lt;span class=&quot;ex&quot;&gt;speglar.siminn.is&lt;/span&gt;
&lt;span class=&quot;ex&quot;&gt;19&lt;/span&gt;) &lt;span class=&quot;ex&quot;&gt;mirrors.dotsrc.org&lt;/span&gt;
&lt;span class=&quot;ex&quot;&gt;20&lt;/span&gt;) &lt;span class=&quot;ex&quot;&gt;ftp.halifax.rwth-aachen.de&lt;/span&gt;
&lt;span class=&quot;ex&quot;&gt;21&lt;/span&gt;) &lt;span class=&quot;ex&quot;&gt;mirrors.tuna.tsinghua.edu.cn&lt;/span&gt;
&lt;span class=&quot;ex&quot;&gt;22&lt;/span&gt;) &lt;span class=&quot;ex&quot;&gt;mirrors.ustc.edu.cn&lt;/span&gt;
&lt;span class=&quot;ex&quot;&gt;23&lt;/span&gt;) &lt;span class=&quot;ex&quot;&gt;mirrors.xjtu.edu.cn&lt;/span&gt;
&lt;span class=&quot;ex&quot;&gt;24&lt;/span&gt;) &lt;span class=&quot;ex&quot;&gt;mirrors.nju.edu.cn&lt;/span&gt;
&lt;span class=&quot;ex&quot;&gt;25&lt;/span&gt;) &lt;span class=&quot;ex&quot;&gt;mirror.lzu.edu.cn&lt;/span&gt;
&lt;span class=&quot;ex&quot;&gt;26&lt;/span&gt;) &lt;span class=&quot;ex&quot;&gt;ftp.acc.umu.se&lt;/span&gt;
&lt;span class=&quot;ex&quot;&gt;27&lt;/span&gt;) &lt;span class=&quot;ex&quot;&gt;mirror.xtom.com.hk&lt;/span&gt;
&lt;span class=&quot;ex&quot;&gt;28&lt;/span&gt;) &lt;span class=&quot;ex&quot;&gt;mirror.csclub.uwaterloo.ca&lt;/span&gt;
&lt;span class=&quot;ex&quot;&gt;29&lt;/span&gt;) &lt;span class=&quot;ex&quot;&gt;alpinelinux.mirror.iweb.com&lt;/span&gt;
&lt;span class=&quot;ex&quot;&gt;30&lt;/span&gt;) &lt;span class=&quot;ex&quot;&gt;mirror.neostrada.nl&lt;/span&gt;
&lt;span class=&quot;ex&quot;&gt;31&lt;/span&gt;) &lt;span class=&quot;ex&quot;&gt;pkg.adfinis-sygroup.ch&lt;/span&gt;
&lt;span class=&quot;ex&quot;&gt;32&lt;/span&gt;) &lt;span class=&quot;ex&quot;&gt;mirror.ps.kz&lt;/span&gt;
&lt;span class=&quot;ex&quot;&gt;33&lt;/span&gt;) &lt;span class=&quot;ex&quot;&gt;mirror.rise.ph&lt;/span&gt;
&lt;span class=&quot;ex&quot;&gt;34&lt;/span&gt;) &lt;span class=&quot;ex&quot;&gt;mirror.operationtulip.com&lt;/span&gt;
&lt;span class=&quot;ex&quot;&gt;35&lt;/span&gt;) &lt;span class=&quot;ex&quot;&gt;mirrors.ircam.fr&lt;/span&gt;
&lt;span class=&quot;ex&quot;&gt;36&lt;/span&gt;) &lt;span class=&quot;ex&quot;&gt;alpine.42.fr&lt;/span&gt;
&lt;span class=&quot;ex&quot;&gt;37&lt;/span&gt;) &lt;span class=&quot;ex&quot;&gt;mirror.math.princeton.edu&lt;/span&gt;
&lt;span class=&quot;ex&quot;&gt;38&lt;/span&gt;) &lt;span class=&quot;ex&quot;&gt;mirrors.sjtug.sjtu.edu.cn&lt;/span&gt;
&lt;span class=&quot;ex&quot;&gt;39&lt;/span&gt;) &lt;span class=&quot;ex&quot;&gt;alpine.mirror.didstopia.com&lt;/span&gt;
&lt;span class=&quot;ex&quot;&gt;40&lt;/span&gt;) &lt;span class=&quot;ex&quot;&gt;ftp.icm.edu.pl&lt;/span&gt;
&lt;span class=&quot;ex&quot;&gt;41&lt;/span&gt;) &lt;span class=&quot;ex&quot;&gt;mirror.ungleich.ch&lt;/span&gt;
&lt;span class=&quot;ex&quot;&gt;42&lt;/span&gt;) &lt;span class=&quot;ex&quot;&gt;alpine.mirror.vexxhost.ca&lt;/span&gt;
&lt;span class=&quot;ex&quot;&gt;43&lt;/span&gt;) &lt;span class=&quot;ex&quot;&gt;sjc.edge.kernel.org&lt;/span&gt;
&lt;span class=&quot;ex&quot;&gt;44&lt;/span&gt;) &lt;span class=&quot;ex&quot;&gt;ewr.edge.kernel.org&lt;/span&gt;
&lt;span class=&quot;ex&quot;&gt;45&lt;/span&gt;) &lt;span class=&quot;ex&quot;&gt;ams.edge.kernel.org&lt;/span&gt;
&lt;span class=&quot;ex&quot;&gt;46&lt;/span&gt;) &lt;span class=&quot;ex&quot;&gt;download.nus.edu.sg&lt;/span&gt;

&lt;span class=&quot;ex&quot;&gt;r&lt;/span&gt;) &lt;span class=&quot;ex&quot;&gt;Add&lt;/span&gt; random from the above list
&lt;span class=&quot;ex&quot;&gt;f&lt;/span&gt;) &lt;span class=&quot;ex&quot;&gt;Detect&lt;/span&gt; and add fastest mirror from above list
&lt;span class=&quot;ex&quot;&gt;e&lt;/span&gt;) &lt;span class=&quot;ex&quot;&gt;Edit&lt;/span&gt; /etc/apk/repositories with text editor

&lt;span class=&quot;ex&quot;&gt;Enter&lt;/span&gt; mirror number (1-46) &lt;span class=&quot;ex&quot;&gt;or&lt;/span&gt; URL to add (or r/f/e/done) [&lt;span class=&quot;ex&quot;&gt;1&lt;/span&gt;]:
&lt;span class=&quot;ex&quot;&gt;Added&lt;/span&gt; mirror dl-cdn.alpinelinux.org
&lt;span class=&quot;ex&quot;&gt;Updating&lt;/span&gt; repository indexes... done.
&lt;span class=&quot;ex&quot;&gt;Which&lt;/span&gt; SSH server? (&lt;span class=&quot;st&quot;&gt;&amp;#39;openssh&amp;#39;&lt;/span&gt;, &lt;span class=&quot;st&quot;&gt;&amp;#39;dropbear&amp;#39;&lt;/span&gt; or &lt;span class=&quot;st&quot;&gt;&amp;#39;none&amp;#39;&lt;/span&gt;) [&lt;span class=&quot;ex&quot;&gt;openssh&lt;/span&gt;]
 &lt;span class=&quot;ex&quot;&gt;*&lt;/span&gt; service sshd added to runlevel default
 &lt;span class=&quot;ex&quot;&gt;*&lt;/span&gt; Caching service dependencies ...
&lt;span class=&quot;bu&quot;&gt; [&lt;/span&gt; ok&lt;span class=&quot;bu&quot;&gt; ]&lt;/span&gt;
&lt;span class=&quot;ex&quot;&gt;ssh-keygen&lt;/span&gt;: generating new host keys: RSA DSA ECDSA ED25519
 &lt;span class=&quot;ex&quot;&gt;*&lt;/span&gt; Starting sshd ...
&lt;span class=&quot;bu&quot;&gt; [&lt;/span&gt; ok&lt;span class=&quot;bu&quot;&gt; ]&lt;/span&gt;
&lt;span class=&quot;ex&quot;&gt;Available&lt;/span&gt; disks are:
  &lt;span class=&quot;ex&quot;&gt;vda&lt;/span&gt;   (8.6 GB 0x0b5d )
&lt;span class=&quot;ex&quot;&gt;Which&lt;/span&gt; disk(s) &lt;span class=&quot;ex&quot;&gt;would&lt;/span&gt; you like to use? (or &lt;span class=&quot;st&quot;&gt;&amp;#39;?&amp;#39;&lt;/span&gt; for help or &lt;span class=&quot;st&quot;&gt;&amp;#39;none&amp;#39;&lt;/span&gt;) [&lt;span class=&quot;ex&quot;&gt;none&lt;/span&gt;] vda
&lt;span class=&quot;ex&quot;&gt;The&lt;/span&gt; following disk is selected:
  &lt;span class=&quot;ex&quot;&gt;vda&lt;/span&gt;   (8.6 GB 0x0b5d )
&lt;span class=&quot;ex&quot;&gt;How&lt;/span&gt; would you like to use it? (&lt;span class=&quot;st&quot;&gt;&amp;#39;sys&amp;#39;&lt;/span&gt;, &lt;span class=&quot;st&quot;&gt;&amp;#39;data&amp;#39;&lt;/span&gt;, &lt;span class=&quot;st&quot;&gt;&amp;#39;lvm&amp;#39;&lt;/span&gt; or &lt;span class=&quot;st&quot;&gt;&amp;#39;?&amp;#39;&lt;/span&gt; for help) [&lt;span class=&quot;ex&quot;&gt;?&lt;/span&gt;] sys
&lt;span class=&quot;ex&quot;&gt;WARNING&lt;/span&gt;: The following disk(s) &lt;span class=&quot;ex&quot;&gt;will&lt;/span&gt; be erased:
  &lt;span class=&quot;ex&quot;&gt;vda&lt;/span&gt;   (8.6 GB 0x0b5d )
&lt;span class=&quot;ex&quot;&gt;WARNING&lt;/span&gt;: Erase the above disk(s) &lt;span class=&quot;ex&quot;&gt;and&lt;/span&gt; continue? [y/N]: y
&lt;span class=&quot;ex&quot;&gt;Creating&lt;/span&gt; file systems...
&lt;span class=&quot;ex&quot;&gt;Installing&lt;/span&gt; system on /dev/vda3:
&lt;span class=&quot;ex&quot;&gt;/mnt/boot&lt;/span&gt; is device /dev/vda1
&lt;span class=&quot;ex&quot;&gt;100%&lt;/span&gt; &lt;span class=&quot;co&quot;&gt;############################################==&amp;gt; initramfs: creating /boot/initramfs-virt&lt;/span&gt;
&lt;span class=&quot;ex&quot;&gt;/boot&lt;/span&gt; is device /dev/vda1

&lt;span class=&quot;ex&quot;&gt;Installation&lt;/span&gt; is complete. Please reboot.&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Running &lt;code&gt;poweroff&lt;/code&gt; in the terminal should shutdown the vm and end the connection to the virtual terminal.&lt;/p&gt;
&lt;p&gt;As an alternative you can run &lt;code&gt;exit&lt;/code&gt; and hit &lt;code&gt;~^D&lt;/code&gt; to exit the virtual terminal, afterwards shutting down the vm via &lt;code&gt;doas vmctl stop alpine-vm&lt;/code&gt;.&lt;/p&gt;
&lt;h3 id=&quot;create-separate-data-disk-and-modify-vm.conf-and-restart-vmd&quot;&gt;Create separate data disk and Modify &lt;em&gt;vm.conf&lt;/em&gt; and restart &lt;em&gt;vmd&lt;/em&gt;&lt;/h3&gt;
&lt;p&gt;At first I created a 20 Gigabyte raw disk drive for system-independent data storage of the virtual machine.&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot;&gt;&lt;pre class=&quot;sourceCode sh&quot;&gt;&lt;code class=&quot;sourceCode bash&quot;&gt;&lt;span class=&quot;ex&quot;&gt;doas&lt;/span&gt; vmctl create -s 20G /mnt/data/vm-drives/alpine-data.img&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Afterwards I modified the &lt;code&gt;/etc/vm.conf&lt;/code&gt; to include the new virtual machine and feed the correct disk data to the &lt;code&gt;alpine-vm&lt;/code&gt;.&lt;/p&gt;
&lt;pre class=&quot;hocon&quot;&gt;&lt;code&gt;files=  /home/web-spider/vm/

data=   /mnt/data/vm-drives/

vm host-vm {
    memory 2g
    disk $files host.drive
    interface tap { lladdr 00:00:00:00:00:02 switch localnet }
}

vm alpine-vm {
    memory 2g
    interface tap { lladdr 00:00:00:00:00:06 switch localnet }
    disk &amp;quot;/mnt/data/vm-drives/alpine.drive&amp;quot; format raw
    disk &amp;quot;/mnt/data/vm-drives/alpine-data.img&amp;quot; format raw
}


switch localnet {
    interface bridge0
}&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Restart &lt;code&gt;vmd&lt;/code&gt; for the changes to be effective.&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot;&gt;&lt;pre class=&quot;sourceCode sh&quot;&gt;&lt;code class=&quot;sourceCode bash&quot;&gt;&lt;span class=&quot;ex&quot;&gt;doas&lt;/span&gt; rcctl restart vmd&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3 id=&quot;kernel-booting-modifications&quot;&gt;Kernel booting modifications&lt;/h3&gt;
&lt;p&gt;For the virtual machine to work more stable and quick with &lt;code&gt;vmd&lt;/code&gt;, I did some recommended changes to the booting parameters.&lt;/p&gt;
&lt;ol type=&quot;1&quot;&gt;
&lt;li&gt;Connect to alpine-vm via &lt;code&gt;doas vmctl console alpine-vm&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;Update config file &lt;code&gt;/boot/extlinux.conf&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;Reboot and reconnect to vm&lt;/li&gt;
&lt;/ol&gt;
&lt;div class=&quot;important&quot;&gt;
&lt;table&gt;
&lt;colgroup&gt;
&lt;col style=&quot;width: 100%&quot; /&gt;
&lt;/colgroup&gt;
&lt;thead&gt;
&lt;tr class=&quot;header&quot;&gt;
&lt;th&gt;&lt;strong&gt;Important&lt;/strong&gt;&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr class=&quot;odd&quot;&gt;
&lt;td&gt;&lt;code&gt;&amp;lt;uuid&amp;gt;&lt;/code&gt; and &lt;code&gt;&amp;lt;dist&amp;gt;&lt;/code&gt; must be substituted by your specific values, in mycase &lt;code&gt;&amp;lt;dist&amp;gt;&lt;/code&gt; was &lt;code&gt;virt&lt;/code&gt; and &lt;code&gt;&amp;lt;uuid&amp;gt;&lt;/code&gt; was &lt;code&gt;001c5e4f-af70-4f6f-bdbc-ceff9d23c6f3&lt;/code&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;div class=&quot;sourceCode&quot;&gt;&lt;pre class=&quot;sourceCode ini&quot;&gt;&lt;code class=&quot;sourceCode ini&quot;&gt;&lt;span class=&quot;dt&quot;&gt;SERIAL 0 115200&lt;/span&gt;
&lt;span class=&quot;dt&quot;&gt;DEFAULT &amp;lt;dist&amp;gt;&lt;/span&gt;
&lt;span class=&quot;dt&quot;&gt;PROMPT 0&lt;/span&gt;
&lt;span class=&quot;dt&quot;&gt;LABEL &amp;lt;dist&amp;gt;&lt;/span&gt;
&lt;span class=&quot;dt&quot;&gt;  MENU LABEL Linux &amp;lt;dist&amp;gt;&lt;/span&gt;
&lt;span class=&quot;dt&quot;&gt;  LINUX vmlinuz-&amp;lt;dist&amp;gt;&lt;/span&gt;
&lt;span class=&quot;dt&quot;&gt;  INITRD initramfs-&amp;lt;dist&amp;gt;&lt;/span&gt;
&lt;span class=&quot;dt&quot;&gt;  APPEND root&lt;/span&gt;&lt;span class=&quot;ot&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;UUID=&amp;lt;uuid&amp;gt; modules=sd-mod,usb-storage,ext4 rootfstype=ext4 console=ttyS0,&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;115200&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;My configuration looked like this in the end:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot;&gt;&lt;pre class=&quot;sourceCode ini&quot;&gt;&lt;code class=&quot;sourceCode ini&quot;&gt;&lt;span class=&quot;dt&quot;&gt;SERIAL 0 115200&lt;/span&gt;
&lt;span class=&quot;dt&quot;&gt;DEFAULT virt&lt;/span&gt;
&lt;span class=&quot;dt&quot;&gt;PROMPT 0&lt;/span&gt;
&lt;span class=&quot;dt&quot;&gt;LABEL virt&lt;/span&gt;
&lt;span class=&quot;dt&quot;&gt;  MENU LABEL Linux virt&lt;/span&gt;
&lt;span class=&quot;dt&quot;&gt;  LINUX vmlinuz-virt&lt;/span&gt;
&lt;span class=&quot;dt&quot;&gt;  INITRD initramfs-virt&lt;/span&gt;
&lt;span class=&quot;dt&quot;&gt;  APPEND root&lt;/span&gt;&lt;span class=&quot;ot&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;UUID=001c5e4f-af70-4f6f-bdbc-ceff9d23c6f3 modules=sd-mod,usb-storage,ext4 rootfstype=ext4 console=ttyS0,&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;115200&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3 id=&quot;enable-ssh-access-to-the-alpine-vm&quot;&gt;Enable SSH-Access to the alpine-vm&lt;/h3&gt;
&lt;p&gt;For a more comfortable and generally better user experience, I enabled ssh access to the VM. To enable ssh access with the possibility to execute root commands, I installed &lt;code&gt;sudo&lt;/code&gt;, created a user and configured &lt;code&gt;openssh&lt;/code&gt; accordingly.&lt;/p&gt;
&lt;p&gt;The procedure was as follows&lt;/p&gt;
&lt;ol type=&quot;1&quot;&gt;
&lt;li&gt;Add user and groups, configure &lt;code&gt;sudo&lt;/code&gt; for group &lt;code&gt;wheel&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;Modify &lt;code&gt;/etc/ssh/sshd_config&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;Add the desired public-key from the workstation&lt;/li&gt;
&lt;li&gt;Restart &lt;code&gt;sshd&lt;/code&gt; or reboot the VM&lt;/li&gt;
&lt;li&gt;Connect to the vm via &lt;code&gt;ssh&lt;/code&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;div class=&quot;sourceCode&quot;&gt;&lt;pre class=&quot;sourceCode sh&quot;&gt;&lt;code class=&quot;sourceCode bash&quot;&gt;&lt;span class=&quot;co&quot;&gt;# add some user e.g. named &amp;quot;general&amp;quot;&lt;/span&gt;
&lt;span class=&quot;ex&quot;&gt;adduser&lt;/span&gt; general

&lt;span class=&quot;co&quot;&gt;# add a groups that will be gained ssh access privileges&lt;/span&gt;
&lt;span class=&quot;ex&quot;&gt;addgroup&lt;/span&gt; ssh-user

&lt;span class=&quot;co&quot;&gt;# install sudo package&lt;/span&gt;
&lt;span class=&quot;ex&quot;&gt;apk&lt;/span&gt; add sudo

&lt;span class=&quot;co&quot;&gt;# add user to groups&lt;/span&gt;
&lt;span class=&quot;kw&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;ex&quot;&gt;u&lt;/span&gt; in &lt;span class=&quot;va&quot;&gt;$(&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;ls&lt;/span&gt; /home&lt;span class=&quot;va&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;kw&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;kw&quot;&gt;do&lt;/span&gt; &lt;span class=&quot;kw&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;ex&quot;&gt;g&lt;/span&gt; in ssh-user disk lp floppy audio cdrom dialout video netdev games users wheel&lt;span class=&quot;kw&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;kw&quot;&gt;do&lt;/span&gt; &lt;span class=&quot;ex&quot;&gt;addgroup&lt;/span&gt; &lt;span class=&quot;va&quot;&gt;$u&lt;/span&gt; &lt;span class=&quot;va&quot;&gt;$g&lt;/span&gt;&lt;span class=&quot;kw&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;kw&quot;&gt;done&lt;/span&gt;;&lt;span class=&quot;kw&quot;&gt;done&lt;/span&gt;

&lt;span class=&quot;co&quot;&gt;# edit sudoers file to allow users of group wheel&lt;/span&gt;
&lt;span class=&quot;fu&quot;&gt;sed&lt;/span&gt; -i &lt;span class=&quot;st&quot;&gt;&amp;#39;s/# %wheel ALL=(ALL) ALL/%wheel ALL=(ALL) ALL/g&amp;#39;&lt;/span&gt; /etc
&lt;span class=&quot;ex&quot;&gt;/sudoers&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;My configuration file for the open ssh daemon looks like the one below, for a better security I also referred an earlier post on &lt;a href=&quot;/2017/06/21/my-openbsd-server-3-making-ssh-more-secure.html&quot;&gt;how to make ssh configuration more secure&lt;/a&gt;.&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; startFrom=&quot;1&quot;&gt;&lt;table class=&quot;sourceCode ini numberLines&quot;&gt;&lt;tr class=&quot;sourceCode&quot;&gt;&lt;td class=&quot;lineNumbers&quot;&gt;&lt;pre&gt;1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;sourceCode&quot;&gt;&lt;pre&gt;&lt;code class=&quot;sourceCode ini&quot;&gt;&lt;span class=&quot;co&quot;&gt;# /etc/ssh/sshd_config&lt;/span&gt;

&lt;span class=&quot;co&quot;&gt;# Make sure that ssh protocol version 2 is used only!&lt;/span&gt;
&lt;span class=&quot;dt&quot;&gt;Protocol 2&lt;/span&gt;

&lt;span class=&quot;co&quot;&gt;# Set the hostkeys that will be used for server authentication at the client&lt;/span&gt;
&lt;span class=&quot;co&quot;&gt;# first preferred one:&lt;/span&gt;
&lt;span class=&quot;dt&quot;&gt;HostKey /etc/ssh/ssh_host_ed25519_key&lt;/span&gt;
&lt;span class=&quot;co&quot;&gt;# fallback:&lt;/span&gt;
&lt;span class=&quot;dt&quot;&gt;HostKey /etc/ssh/ssh_host_rsa_key&lt;/span&gt;

&lt;span class=&quot;co&quot;&gt;# Chose a port that is not &amp;quot;standard&amp;quot; so default port scanning on low ports fail&lt;/span&gt;
&lt;span class=&quot;co&quot;&gt;# The port number can be a 16bit Integer. So the maximum is 65535&lt;/span&gt;
&lt;span class=&quot;dt&quot;&gt;Port 13423&lt;/span&gt;

&lt;span class=&quot;co&quot;&gt;# Tell sshd which key exchange algorithms it is allowed to use. The resource by stribka at&lt;/span&gt;
&lt;span class=&quot;co&quot;&gt;# https://stribika.github.io/2015/01/04/secure-secure-shell.html is explaining why these two (curve25519 and diffie-hellman sha256)&lt;/span&gt;
&lt;span class=&quot;co&quot;&gt;# are the only chosen ones&lt;/span&gt;
&lt;span class=&quot;dt&quot;&gt;KexAlgorithms curve25519-sha256@libssh.org,diffie-hellman-group-exchange-sha256&lt;/span&gt;

&lt;span class=&quot;co&quot;&gt;# Only allow strong symmetric cyphers (see stribka&amp;#39;s resource for detailed information)&lt;/span&gt;
&lt;span class=&quot;dt&quot;&gt;Ciphers chacha20-poly1305@openssh.com,aes256-gcm@openssh.com,aes128-gcm@openssh.com,aes256-ctr,aes192-ctr,aes128-ctr&lt;/span&gt;

&lt;span class=&quot;co&quot;&gt;# Only allow strong hmacs for message integrity (see stribka&amp;#39;s resource for detailed information)&lt;/span&gt;
&lt;span class=&quot;dt&quot;&gt;MACs hmac-sha2-512-etm@openssh.com,hmac-sha2-256-etm@openssh.com,hmac-ripemd160-etm@openssh.com,umac-128-etm@openssh.com,hmac-sha2-512,hmac-sha2-256,hmac-ripemd160,umac-128@openssh.com&lt;/span&gt;

&lt;span class=&quot;co&quot;&gt;# I do not want to permit root login for ssh in general&lt;/span&gt;
&lt;span class=&quot;co&quot;&gt;# If I would like to do that later I would choose to do it in a Match rule for specific addresses for example&lt;/span&gt;
&lt;span class=&quot;dt&quot;&gt;PermitRootLogin no&lt;/span&gt;

&lt;span class=&quot;co&quot;&gt;# The default is to check both .ssh/authorized_keys and .ssh/authorized_keys2&lt;/span&gt;
&lt;span class=&quot;co&quot;&gt;# but this is overridden so installations will only check .ssh/authorized_keys&lt;/span&gt;
&lt;span class=&quot;dt&quot;&gt;AuthorizedKeysFile      .ssh/authorized_keys&lt;/span&gt;

&lt;span class=&quot;co&quot;&gt;# Generally I want to disalow any kind of access&lt;/span&gt;
&lt;span class=&quot;co&quot;&gt;# and handle it in user or address specific match rules&lt;/span&gt;
&lt;span class=&quot;co&quot;&gt;# so disable pubkey authentication at first&lt;/span&gt;
&lt;span class=&quot;dt&quot;&gt;PubkeyAuthentication no&lt;/span&gt;

&lt;span class=&quot;co&quot;&gt;# To disable tunneled clear text passwords:&lt;/span&gt;
&lt;span class=&quot;dt&quot;&gt;PasswordAuthentication no&lt;/span&gt;

&lt;span class=&quot;co&quot;&gt;# We do not want to permit empty passwords in any case:&lt;/span&gt;
&lt;span class=&quot;dt&quot;&gt;PermitEmptyPasswords no&lt;/span&gt;

&lt;span class=&quot;co&quot;&gt;# Generally disallow tcp forwarding&lt;/span&gt;
&lt;span class=&quot;dt&quot;&gt;AllowTcpForwarding no&lt;/span&gt;

&lt;span class=&quot;co&quot;&gt;# override default of no subsystems&lt;/span&gt;
&lt;span class=&quot;dt&quot;&gt;Subsystem   sftp    /usr/lib/ssh/sftp-server&lt;/span&gt;

&lt;span class=&quot;co&quot;&gt;# only allow ssh sessions for members of the ssh-user group&lt;/span&gt;
&lt;span class=&quot;dt&quot;&gt;AllowGroups ssh-user&lt;/span&gt;

&lt;span class=&quot;co&quot;&gt;# then when its a member of the group ssh-user (like my user jan-server will be) to be logged in, do some specific actions:&lt;/span&gt;
&lt;span class=&quot;dt&quot;&gt;Match Group ssh-user &lt;/span&gt;
&lt;span class=&quot;dt&quot;&gt;        &lt;/span&gt;
&lt;span class=&quot;dt&quot;&gt;        &lt;/span&gt;&lt;span class=&quot;co&quot;&gt;# And allow pubkey authentication, so my generated pubkey can be used&lt;/span&gt;
&lt;span class=&quot;dt&quot;&gt;    PubkeyAuthentication yes&lt;/span&gt;

&lt;span class=&quot;dt&quot;&gt;        AuthenticationMethods publickey&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;
&lt;p&gt;add authorized keys from your workstation (e.g. copy and paste it)&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot;&gt;&lt;pre class=&quot;sourceCode sh&quot;&gt;&lt;code class=&quot;sourceCode bash&quot;&gt;&lt;span class=&quot;bu&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;st&quot;&gt;&amp;quot;ssh-ed25519 SD323f928392i31sadfklsjdf37824 someone@some-workstation&amp;quot;&lt;/span&gt; &lt;span class=&quot;op&quot;&gt;&amp;gt;&lt;/span&gt; authorized_keys

&lt;span class=&quot;co&quot;&gt;# restart the sshd service&lt;/span&gt;
&lt;span class=&quot;ex&quot;&gt;rc-service&lt;/span&gt; sshd restart&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;I logged in to the alpine machine from my workstation via ssh which was more comfortable. I did this by using my server as a jumphost into the vm. I covered the configuration of such an entry in a &lt;a href=&quot;/2017/06/21/my-openbsd-server-3-making-ssh-more-secure.html#access-virtual-machines-via-ssh-on-my-workstation&quot;&gt;previous post&lt;/a&gt;.&lt;/p&gt;
&lt;h3 id=&quot;create-a-new-filesystem-and-mount-the-data-disk&quot;&gt;Create a new filesystem and mount the data disk&lt;/h3&gt;
&lt;p&gt;Modify the repositories in &lt;code&gt;/etc/apk/repositories&lt;/code&gt; to include the &lt;code&gt;community&lt;/code&gt; packages and update them afterwards via &lt;code&gt;apk update&lt;/code&gt;. I used &lt;code&gt;comminity&lt;/code&gt; to check the available disks via &lt;code&gt;lsblk&lt;/code&gt; command.&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot;&gt;&lt;pre class=&quot;sourceCode sh&quot;&gt;&lt;code class=&quot;sourceCode bash&quot;&gt;&lt;span class=&quot;co&quot;&gt;#/etc/apk/repositories&lt;/span&gt;

&lt;span class=&quot;co&quot;&gt;#/media/cdrom/apks&lt;/span&gt;
&lt;span class=&quot;ex&quot;&gt;http&lt;/span&gt;://dl-cdn.alpinelinux.org/alpine/v3.11/main
&lt;span class=&quot;ex&quot;&gt;http&lt;/span&gt;://dl-cdn.alpinelinux.org/alpine/v3.11/community
&lt;span class=&quot;co&quot;&gt;#http://dl-cdn.alpinelinux.org/alpine/edge/main&lt;/span&gt;
&lt;span class=&quot;co&quot;&gt;#http://dl-cdn.alpinelinux.org/alpine/edge/community&lt;/span&gt;
&lt;span class=&quot;co&quot;&gt;#http://dl-cdn.alpinelinux.org/alpine/edge/testing&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;ol start=&quot;5&quot; type=&quot;1&quot;&gt;
&lt;li&gt;update repos&lt;/li&gt;
&lt;/ol&gt;
&lt;div class=&quot;sourceCode&quot;&gt;&lt;pre class=&quot;sourceCode sh&quot;&gt;&lt;code class=&quot;sourceCode bash&quot;&gt;&lt;span class=&quot;co&quot;&gt;# change to root&lt;/span&gt;
&lt;span class=&quot;fu&quot;&gt;sudo&lt;/span&gt; -s

&lt;span class=&quot;co&quot;&gt;# install linux utils (for lsblk)&lt;/span&gt;
&lt;span class=&quot;ex&quot;&gt;apk&lt;/span&gt; add util-linux

&lt;span class=&quot;co&quot;&gt;# check the disks&lt;/span&gt;
&lt;span class=&quot;ex&quot;&gt;lsblk&lt;/span&gt;

&lt;span class=&quot;co&quot;&gt;# use parted, so install it&lt;/span&gt;
&lt;span class=&quot;ex&quot;&gt;apk&lt;/span&gt; add parted

&lt;span class=&quot;co&quot;&gt;# execute parted (in my case with device vdb)&lt;/span&gt;
&lt;span class=&quot;ex&quot;&gt;parted&lt;/span&gt; vdb

&lt;span class=&quot;co&quot;&gt;## now inside the parted-shell:&lt;/span&gt;
&lt;span class=&quot;co&quot;&gt;# configure new gpt label&lt;/span&gt;
&lt;span class=&quot;kw&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;ex&quot;&gt;parted&lt;/span&gt;&lt;span class=&quot;kw&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;ex&quot;&gt;mklabel&lt;/span&gt; gpt

&lt;span class=&quot;co&quot;&gt;# set unit size&lt;/span&gt;
&lt;span class=&quot;kw&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;ex&quot;&gt;parted&lt;/span&gt;&lt;span class=&quot;kw&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;ex&quot;&gt;unit&lt;/span&gt; MiB

&lt;span class=&quot;co&quot;&gt;# make new ext4 partition&lt;/span&gt;
&lt;span class=&quot;kw&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;ex&quot;&gt;parted&lt;/span&gt;&lt;span class=&quot;kw&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;ex&quot;&gt;mkpart&lt;/span&gt; 1 ext4 1 20479

&lt;span class=&quot;co&quot;&gt;# check optimal alignment&lt;/span&gt;
&lt;span class=&quot;kw&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;ex&quot;&gt;parted&lt;/span&gt;&lt;span class=&quot;kw&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;ex&quot;&gt;align-check&lt;/span&gt; opt

&lt;span class=&quot;co&quot;&gt;# name partition e.g. &amp;quot;data&amp;quot;&lt;/span&gt;
&lt;span class=&quot;kw&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;ex&quot;&gt;parted&lt;/span&gt;&lt;span class=&quot;kw&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;ex&quot;&gt;name&lt;/span&gt; 1 data

&lt;span class=&quot;co&quot;&gt;# quit&lt;/span&gt;
&lt;span class=&quot;kw&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;ex&quot;&gt;parted&lt;/span&gt;&lt;span class=&quot;kw&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;ex&quot;&gt;quit&lt;/span&gt;

&lt;span class=&quot;co&quot;&gt;# make new filesystem&lt;/span&gt;
&lt;span class=&quot;ex&quot;&gt;mkfs.ext4&lt;/span&gt; /dev/vdb1

&lt;span class=&quot;co&quot;&gt;# not the partition UUID that mkfs reports, copy it&lt;/span&gt;
&lt;span class=&quot;va&quot;&gt;DATA_UUID=&lt;/span&gt;&lt;span class=&quot;op&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;ex&quot;&gt;your&lt;/span&gt; partition uuid that you copied&lt;span class=&quot;op&quot;&gt;&amp;gt;&lt;/span&gt;

&lt;span class=&quot;co&quot;&gt;# create mount point directory&lt;/span&gt;
&lt;span class=&quot;fu&quot;&gt;mkdir&lt;/span&gt; /data

&lt;span class=&quot;co&quot;&gt;# add mounting into fstab&lt;/span&gt;
&lt;span class=&quot;bu&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;st&quot;&gt;&amp;quot;UUID=&lt;/span&gt;&lt;span class=&quot;va&quot;&gt;$DATA_UUID&lt;/span&gt;&lt;span class=&quot;st&quot;&gt; /data ext4 rw,relatime,user 0 0&amp;quot;&lt;/span&gt; &lt;span class=&quot;op&quot;&gt;&amp;gt;&amp;gt;&lt;/span&gt; /etc/fstab 

&lt;span class=&quot;co&quot;&gt;# mount it&lt;/span&gt;
&lt;span class=&quot;fu&quot;&gt;mount&lt;/span&gt; /data&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h2 id=&quot;install-docker-and-make-it-use-the-data-disk&quot;&gt;Install Docker and make it use the data-disk&lt;/h2&gt;
&lt;p&gt;Install Docker&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot;&gt;&lt;pre class=&quot;sourceCode sh&quot;&gt;&lt;code class=&quot;sourceCode bash&quot;&gt;&lt;span class=&quot;fu&quot;&gt;sudo&lt;/span&gt; apk add docker

&lt;span class=&quot;fu&quot;&gt;sudo&lt;/span&gt; adduser general docker&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Modify &lt;code&gt;DOCKER_OPTS&lt;/code&gt; in &lt;code&gt;/etc/conf.d/docker&lt;/code&gt;&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot;&gt;&lt;pre class=&quot;sourceCode sh&quot;&gt;&lt;code class=&quot;sourceCode bash&quot;&gt;
&lt;span class=&quot;co&quot;&gt;# any other random options you want to pass to docker&lt;/span&gt;
&lt;span class=&quot;va&quot;&gt;DOCKER_OPTS=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&amp;quot;--data-root /data/docker&amp;quot;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Restart Docker via &lt;code&gt;rc-service docker restart&lt;/code&gt;&lt;/p&gt;</content><author><name></name></author><summary type="html">I wanted to run docker-services on an alpine-vm on OpenBSD 6.6</summary></entry><entry><title type="html">Use local images in minikube with podman - 3 methods</title><link href="https://blog.hermes-technology.de/minikube/kubernetes/podman/2020/03/23/use-local-images-in-minikube-3-methods.html" rel="alternate" type="text/html" title="Use local images in minikube with podman - 3 methods" /><published>2020-03-23T12:04:00+01:00</published><updated>2020-03-23T12:04:00+01:00</updated><id>https://blog.hermes-technology.de/minikube/kubernetes/podman/2020/03/23/use-local-images-in-minikube-3-methods</id><content type="html" xml:base="https://blog.hermes-technology.de/minikube/kubernetes/podman/2020/03/23/use-local-images-in-minikube-3-methods.html">&lt;p&gt;I wanted to to do some kubernetes tests locally with minikube and found out that I couldn't use locally built images. There where three methods depending on the use case that worked for me:&lt;/p&gt;
&lt;ol type=&quot;1&quot;&gt;
&lt;li&gt;Use podman env&lt;/li&gt;
&lt;li&gt;Use a local registry on host and pull from that in minikube&lt;/li&gt;
&lt;li&gt;Use a registry in minikube and push into that from the host&lt;/li&gt;
&lt;/ol&gt;
&lt;h1 id=&quot;method-1---use-podman-env&quot;&gt;Method 1 - Use podman env&lt;/h1&gt;
&lt;div class=&quot;sourceCode&quot;&gt;&lt;pre class=&quot;sourceCode sh&quot;&gt;&lt;code class=&quot;sourceCode bash&quot;&gt;
&lt;span class=&quot;co&quot;&gt;# start minikube with podman&lt;/span&gt;
&lt;span class=&quot;ex&quot;&gt;minikube&lt;/span&gt; start --container-runtime=crio-o

&lt;span class=&quot;co&quot;&gt;# wait until minikube is ready&lt;/span&gt;
&lt;span class=&quot;bu&quot;&gt;eval&lt;/span&gt; &lt;span class=&quot;va&quot;&gt;$(&lt;/span&gt;&lt;span class=&quot;ex&quot;&gt;minikube&lt;/span&gt; podman-env&lt;span class=&quot;va&quot;&gt;)&lt;/span&gt;

&lt;span class=&quot;co&quot;&gt;# use podman-remote in the same terminal using a local Dockerfile on host, e.g.:&lt;/span&gt;
&lt;span class=&quot;ex&quot;&gt;podman-remote&lt;/span&gt; build -f Dockerfile example:latest .

&lt;span class=&quot;co&quot;&gt;# images are then accessible in minikube podman via:&lt;/span&gt;
&lt;span class=&quot;ex&quot;&gt;podman-remote&lt;/span&gt; run --image localhost/example:latest&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h1 id=&quot;method-2---use-a-local-registry-on-the-host&quot;&gt;Method 2 - Use a local registry on the host&lt;/h1&gt;
&lt;p&gt;Make name resolution of &lt;code&gt;registry.local&lt;/code&gt; point to your host&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot;&gt;&lt;pre class=&quot;sourceCode sh&quot;&gt;&lt;code class=&quot;sourceCode bash&quot;&gt;&lt;span class=&quot;co&quot;&gt;# update /etc/hosts&lt;/span&gt;
&lt;span class=&quot;bu&quot;&gt;printf&lt;/span&gt; &lt;span class=&quot;st&quot;&gt;&amp;#39;%s\t%s\n&amp;#39;&lt;/span&gt; &lt;span class=&quot;st&quot;&gt;&amp;#39;127.0.0.1&amp;#39;&lt;/span&gt; &lt;span class=&quot;st&quot;&gt;&amp;#39;registry.local&amp;#39;&lt;/span&gt; &lt;span class=&quot;kw&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;sudo&lt;/span&gt; tee -a /etc/hosts&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Change the insecure registries entry in your container config file:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot;&gt;&lt;pre class=&quot;sourceCode ini&quot;&gt;&lt;code class=&quot;sourceCode ini&quot;&gt;&lt;span class=&quot;co&quot;&gt;# /etc/containers/registries.conf&lt;/span&gt;

&lt;span class=&quot;kw&quot;&gt;[registries.search]&lt;/span&gt;
&lt;span class=&quot;dt&quot;&gt;registries &lt;/span&gt;&lt;span class=&quot;ot&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt; [&amp;#39;docker.io&amp;#39;, &amp;#39;registry.fedoraproject.org&amp;#39;, &amp;#39;quay.io&amp;#39;, &amp;#39;registry.access.redhat.com&amp;#39;, &amp;#39;registry.centos.org&amp;#39;]&lt;/span&gt;

&lt;span class=&quot;co&quot;&gt;# If you need to access insecure registries, add the registry&amp;#39;s fully-qualified name.&lt;/span&gt;
&lt;span class=&quot;co&quot;&gt;# An insecure registry is one that does not have a valid SSL certificate or only does HTTP.&lt;/span&gt;
&lt;span class=&quot;kw&quot;&gt;[registries.insecure]&lt;/span&gt;
&lt;span class=&quot;dt&quot;&gt;registries &lt;/span&gt;&lt;span class=&quot;ot&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt; [&amp;#39;registry.local&amp;#39;]&lt;/span&gt;


&lt;span class=&quot;co&quot;&gt;# If you need to block pull access from a registry, uncomment the section below&lt;/span&gt;
&lt;span class=&quot;co&quot;&gt;# and add the registries fully-qualified name.&lt;/span&gt;
&lt;span class=&quot;co&quot;&gt;#&lt;/span&gt;
&lt;span class=&quot;co&quot;&gt;# Docker only&lt;/span&gt;
&lt;span class=&quot;kw&quot;&gt;[registries.block]&lt;/span&gt;
&lt;span class=&quot;dt&quot;&gt;registries &lt;/span&gt;&lt;span class=&quot;ot&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt; []&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Run the local registry and push to it&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot;&gt;&lt;pre class=&quot;sourceCode sh&quot;&gt;&lt;code class=&quot;sourceCode bash&quot;&gt;&lt;span class=&quot;co&quot;&gt;# run a local registry on the host&lt;/span&gt;
&lt;span class=&quot;ex&quot;&gt;podman&lt;/span&gt; run -d -p 5000:5000 --restart=always --name registry registry:2
&lt;span class=&quot;co&quot;&gt;# or start it if you already did that before&lt;/span&gt;
&lt;span class=&quot;ex&quot;&gt;podman&lt;/span&gt; start registry

&lt;span class=&quot;co&quot;&gt;# if you alread have an image tag it correctly&lt;/span&gt;
&lt;span class=&quot;ex&quot;&gt;podman&lt;/span&gt; tag localhost/example registry.local:5000/example

&lt;span class=&quot;co&quot;&gt;# push image to local registry&lt;/span&gt;
&lt;span class=&quot;ex&quot;&gt;podman&lt;/span&gt; push registry.local:5000/example

&lt;span class=&quot;co&quot;&gt;# start minikube&lt;/span&gt;
&lt;span class=&quot;ex&quot;&gt;minikube&lt;/span&gt; start --container-runtime=cri-o --insecure-registry=&lt;span class=&quot;st&quot;&gt;&amp;quot;registry.local:5000&amp;quot;&lt;/span&gt;

&lt;span class=&quot;co&quot;&gt;# ssh into minikube and change host as well:&lt;/span&gt;
&lt;span class=&quot;ex&quot;&gt;minikube&lt;/span&gt; ssh -- eval &lt;span class=&quot;st&quot;&gt;&amp;quot;printf \&amp;#39;&amp;#39;%s\t%s\n&amp;#39;\&amp;#39; \&amp;#39;&amp;#39;127.0.0.1&amp;#39;\&amp;#39; \&amp;#39;&amp;#39;registry.local&amp;#39;\&amp;#39; | sudo tee -a /etc/hosts&amp;quot;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;ssh into minikube and add the insecure registry:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot;&gt;&lt;pre class=&quot;sourceCode ini&quot;&gt;&lt;code class=&quot;sourceCode ini&quot;&gt;&lt;span class=&quot;co&quot;&gt;# /etc/containers/registries.conf on minikube vm&lt;/span&gt;

&lt;span class=&quot;kw&quot;&gt;[registries.search]&lt;/span&gt;
&lt;span class=&quot;dt&quot;&gt;registries &lt;/span&gt;&lt;span class=&quot;ot&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt; [&amp;#39;docker.io&amp;#39;]&lt;/span&gt;

&lt;span class=&quot;kw&quot;&gt;[registries.insecure]&lt;/span&gt;
&lt;span class=&quot;dt&quot;&gt;registries &lt;/span&gt;&lt;span class=&quot;ot&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt; [&amp;#39;registry.local&amp;#39;]&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h1 id=&quot;method-3---use-a-registry-in-minikube&quot;&gt;Method 3 - Use a registry in minikube&lt;/h1&gt;
&lt;p&gt;Change the insecure registries entry in your container config file:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot;&gt;&lt;pre class=&quot;sourceCode ini&quot;&gt;&lt;code class=&quot;sourceCode ini&quot;&gt;&lt;span class=&quot;co&quot;&gt;# /etc/containers/registries.conf&lt;/span&gt;

&lt;span class=&quot;kw&quot;&gt;[registries.search]&lt;/span&gt;
&lt;span class=&quot;dt&quot;&gt;registries &lt;/span&gt;&lt;span class=&quot;ot&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt; [&amp;#39;docker.io&amp;#39;, &amp;#39;registry.fedoraproject.org&amp;#39;, &amp;#39;quay.io&amp;#39;, &amp;#39;registry.access.redhat.com&amp;#39;, &amp;#39;registry.centos.org&amp;#39;]&lt;/span&gt;

&lt;span class=&quot;co&quot;&gt;# If you need to access insecure registries, add the registry&amp;#39;s fully-qualified name.&lt;/span&gt;
&lt;span class=&quot;co&quot;&gt;# An insecure registry is one that does not have a valid SSL certificate or only does HTTP.&lt;/span&gt;
&lt;span class=&quot;kw&quot;&gt;[registries.insecure]&lt;/span&gt;
&lt;span class=&quot;dt&quot;&gt;registries &lt;/span&gt;&lt;span class=&quot;ot&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt; [&amp;#39;registry.local&amp;#39;, &amp;#39;registry.kube&amp;#39;]&lt;/span&gt;


&lt;span class=&quot;co&quot;&gt;# If you need to block pull access from a registry, uncomment the section below&lt;/span&gt;
&lt;span class=&quot;co&quot;&gt;# and add the registries fully-qualified name.&lt;/span&gt;
&lt;span class=&quot;co&quot;&gt;#&lt;/span&gt;
&lt;span class=&quot;co&quot;&gt;# Docker only&lt;/span&gt;
&lt;span class=&quot;kw&quot;&gt;[registries.block]&lt;/span&gt;
&lt;span class=&quot;dt&quot;&gt;registries &lt;/span&gt;&lt;span class=&quot;ot&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt; []&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;div class=&quot;sourceCode&quot;&gt;&lt;pre class=&quot;sourceCode sh&quot;&gt;&lt;code class=&quot;sourceCode bash&quot;&gt;
&lt;span class=&quot;co&quot;&gt;# start minikube with registry addon&lt;/span&gt;
&lt;span class=&quot;ex&quot;&gt;minikube&lt;/span&gt; start --container-runtime=crio-o --addons registry

&lt;span class=&quot;co&quot;&gt;# podman tag localhost/example $(minikube ip):5000/example&lt;/span&gt;

&lt;span class=&quot;bu&quot;&gt;printf&lt;/span&gt; &lt;span class=&quot;st&quot;&gt;&amp;#39;%s\t%s\n&amp;#39;&lt;/span&gt; &lt;span class=&quot;st&quot;&gt;&amp;quot;&lt;/span&gt;&lt;span class=&quot;va&quot;&gt;$(&lt;/span&gt;&lt;span class=&quot;ex&quot;&gt;minikube&lt;/span&gt; ip&lt;span class=&quot;va&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&amp;quot;&lt;/span&gt; &lt;span class=&quot;st&quot;&gt;&amp;#39;registry.kube&amp;#39;&lt;/span&gt; &lt;span class=&quot;kw&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;sudo&lt;/span&gt; tee -a /etc/hosts

&lt;span class=&quot;ex&quot;&gt;podman&lt;/span&gt; push localhost/example &lt;span class=&quot;va&quot;&gt;$(&lt;/span&gt;&lt;span class=&quot;ex&quot;&gt;minikube&lt;/span&gt; ip&lt;span class=&quot;va&quot;&gt;)&lt;/span&gt;:5000/example&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;</content><author><name></name></author><summary type="html">Playing around with minikube and podman</summary></entry><entry><title type="html">Let me introduce you</title><link href="https://blog.hermes-technology.de/arduino/robot/maker/udooneo/2017/08/01/let-me-introduce-you.html" rel="alternate" type="text/html" title="Let me introduce you" /><published>2017-08-01T18:11:00+02:00</published><updated>2017-08-01T18:11:00+02:00</updated><id>https://blog.hermes-technology.de/arduino/robot/maker/udooneo/2017/08/01/let-me-introduce-you</id><content type="html" xml:base="https://blog.hermes-technology.de/arduino/robot/maker/udooneo/2017/08/01/let-me-introduce-you.html">&lt;p&gt;And now for something completely different - Number 1... the larch.&lt;/p&gt;
&lt;figure&gt;
&lt;img src=&quot;/assets/the-larch.jpg&quot; title=&quot;the larch&quot; alt=&quot;The larch&quot; /&gt;&lt;figcaption&gt;The larch&lt;/figcaption&gt;
&lt;/figure&gt;
&lt;p&gt;... Number 3... the robot.&lt;/p&gt;
&lt;p&gt;Hello dear reader,&lt;/p&gt;
&lt;p&gt;I will now write about something completely different. It's not about a larch, but I would like to build a robot! For backing up my explanations I include a figure that shows a rough overview on what this project is about, and how I would like to achieve my goals:&lt;/p&gt;
&lt;figure&gt;
&lt;figcaption&gt;
&lt;i&gt;Figure 1: Rob's concept&lt;/i&gt;
&lt;/figcaption&gt;
&lt;img src=&quot;https://blog.hermes-technology.de/assets/rob-the-robot-env.svg.png&quot; title=&quot;Figure 1: Robs concept&quot; alt=&quot;Robs concept&quot; /&gt;
&lt;/figure&gt;
&lt;p&gt;I decided to distinguish between three ability domains for Rob:&lt;/p&gt;
&lt;p&gt;Firstly, there is the &lt;strong&gt;Arduino microcontoller&lt;/strong&gt; (ARM Cortex-M4), which is responsible for all critical controlling that has to be done in real time. I also added the &lt;strong&gt;Adafruit Motorshield&lt;/strong&gt; on my Udoo Neo board for an easy way to control any kind of motor that I want to integrate for the robot. Examples for those critical tasks would be a balancing controller or an automatic halt-system that fires before hitting walls or falling into an abyss. The balancing controller will, as soon as the robot will be running on two wheels, stabilize R.O.B. in real-time. For those tasks I will add specific parts like an array of ultrasonic sensors for distance queries or use existing components on the board like the magnetometer, accelerometer and the gyroscope.&lt;/p&gt;
&lt;p&gt;Secondly, also on the Udoo Neo board, there is the &lt;strong&gt;ARM Cortex-A9&lt;/strong&gt;. The software running on there will perform simple computations and provide an interface for interactions with Rob. By way of example I could think about path finding algorithms and simple data storage and retrieval. It will enable the possibility to interact with the robot via WLAN or bluetooth. The Cortex-M4 and Cortex-A9 can communicate via an i²c bus.&lt;/p&gt;
&lt;p&gt;At last I will also integrate the &lt;strong&gt;server&lt;/strong&gt;. So while being on this project I will also need the functionality of my server that I'm building in the &amp;quot;My OpenBSD Server&amp;quot; project. The server will be performing more expensive computations that include the establishment of neuronal networks for voice or face recognition.&lt;/p&gt;
&lt;p&gt;So all in all the basic mechanical and sensor functionality will run on the microcontroller, more sophisticated operations and WLAN interfacing will be done with the arm, and the server provides some kind of AI.&lt;/p&gt;
&lt;p&gt;While working on this project, the server I built is not out of my focus, I will continue to add more functionality and document my configurations in this blog. At the moment I also have to work on two non-private projects that consume a lot of resources, so I will be a little bit thwarted on the OpenBSD server and robot project for the next two month.&lt;/p&gt;
&lt;p&gt;So I hope to write to you soon, until next post.&lt;/p&gt;</content><author><name></name></author><summary type="html">I've always wanted to build a robot, but yet I did not build one! In this introduction I will shortly write about what I want to do about this dilemma and the components I have in mind to solve it.</summary></entry><entry><title type="html">Making ssh more secure (UPDATE!)</title><link href="https://blog.hermes-technology.de/2017/06/21/my-openbsd-server-3-making-ssh-more-secure.html" rel="alternate" type="text/html" title="Making ssh more secure (UPDATE!)" /><published>2017-06-21T00:00:00+02:00</published><updated>2017-06-21T00:00:00+02:00</updated><id>https://blog.hermes-technology.de/2017/06/21/my-openbsd-server-3-making-ssh-more-secure</id><content type="html" xml:base="https://blog.hermes-technology.de/2017/06/21/my-openbsd-server-3-making-ssh-more-secure.html">&lt;p&gt;UPDATE: I upgraded the whole ssh setup on client and server to be much more secure, thanks to PengouinBSD's comment!&lt;/p&gt;
&lt;p&gt;Hello again,&lt;/p&gt;
&lt;p&gt;as I wrote in my &lt;a href=&quot;/openbsd/server/virtualmachine/network/2017/06/12/vmd-for-a-virtual-server-network.html#outlook&quot;&gt;last post&lt;/a&gt; I want to take care a bit about ssh connection and its security. So today's task will be:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Create an ssh-key on my workstation and add the public key to the server's authorized keys&lt;/li&gt;
&lt;li&gt;Configure the ssh daemon (sshd) on the server (no root permit, no password permit, only public key)&lt;/li&gt;
&lt;li&gt;Do the same for each virtual machine&lt;/li&gt;
&lt;li&gt;Enable a &lt;code&gt;fail2ban&lt;/code&gt; like functionality via &lt;code&gt;pf&lt;/code&gt;, banning specific IP addresses that tried to connect too often or too fast&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;A short outline for jumping around:&lt;/p&gt;
&lt;div id=&quot;toc&quot;&gt;

&lt;/div&gt;
&lt;h2 id=&quot;intro&quot;&gt;Intro&lt;/h2&gt;
&lt;p&gt;Establishing an ssh connection to the server is great if you want to remotely sanitize the system and do some maintenance work on the server. But of course by opening a new way to access the server for yourself you are also opening a new way for potential attacks on your server.&lt;/p&gt;
&lt;!--Upon roaming through the net and looking for information I often stumbled across the people saying &quot;most secure way is to disallow ssh from the internet as a total&quot; and while that's true--&gt;
&lt;p&gt;But as usual there are ways to make this connection more secure than default.&lt;/p&gt;
&lt;h2 id=&quot;my-scenario&quot;&gt;My Scenario&lt;/h2&gt;
&lt;p&gt;I had a server setup operating openssh on OpenBSD 6.1 that was disallowing root login totally and only allowing users to login ssh via their passwords. SSH service is running on port 22. This configuration is the default if you enabled ssh and chose not to permit root login for ssh during the installation process of OpenBSD. As I did for example do in &lt;a href=&quot;/openbsd/server/virtualmachine/network/2017/06/12/vmd-for-a-virtual-server-network.html#guided-installation-of-openbsd-for-the-host-vm&quot;&gt;this installation guide&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;I want to change that into only allowing the user to login with public keys and the Google Authenticator App as a second factor.&lt;/p&gt;
&lt;h2 id=&quot;ssh---public-key-authentication-for-the-server-and-each-vm&quot;&gt;SSH - Public key authentication for the server and each VM&lt;/h2&gt;
&lt;p&gt;In this section I will write how I set up the ssh public key connection for my workstations and the server with the VMs running on it. This will include some paranoid precaution, the creation of the keys, the transferral of the public keys to the servers (main server and VMs) and setting up the ssh config on the workstation for establishing easy connections.&lt;/p&gt;
&lt;p&gt;This section will be completely updated as for the comment of PengouinBSD. As I read by his resources, the public key setup that I chose was not really secure (at least it can be much more secure). At first I want to share those resources that PengouinBSD shared at the top of this new section:&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://martin.kleppmann.com/2013/05/24/improving-security-of-ssh-private-keys.html&quot;&gt;Key derivation: Improving the security of your SSH private key files by Martin Kleppman&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;http://www.tedunangst.com/flak/post/new-openssh-key-format-and-bcrypt-pbkdf&quot;&gt;Key derivation: new openssh key format and bcrypt pbkdf by Ted Unangst&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://stribika.github.io/2015/01/04/secure-secure-shell.html&quot;&gt;Client/Server authentication: Secure Secure Shell by stribika&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;The resource by Martin Kleppmann is showing how you can implement a key derivation for ssh private keys. In the header of his post he is pointing out that his article is not relevant for newer versions of OpenSSH anymore as those are supporting the &lt;code&gt;-o&lt;/code&gt; Option mentioned by PengouinBSD which integrates a new stronger format with key derivation.&lt;/p&gt;
&lt;p&gt;The second resource by Ted Unangst is about a new OpenSSH key format. The keyformat is using stronger key derivation functions which are enabled by default for keys using ed25519 signatures. Also he mentions how to upgrade the old keyformat to the new one.&lt;/p&gt;
&lt;p&gt;In the last resource stribika provides a profound explanation on how to setup your server/client key authentication. I will mainly follow his setup and make my access security much better.&lt;/p&gt;
&lt;h3 id=&quot;taking-precaution&quot;&gt;Taking precaution&lt;/h3&gt;
&lt;p&gt;For setting up all the ssh configurations I disconnected my server and my workstation from the internet (not from the LAN) so there could not be any interceptions to the internal traffic when I setup the public key authentication.&lt;/p&gt;
&lt;h3 id=&quot;create-an-ssh-key&quot;&gt;Create an ssh-key&lt;/h3&gt;
&lt;p&gt;On the workstation I wanted to be able to reach my server from, I created an ssh-key:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot;&gt;&lt;pre class=&quot;sourceCode bash&quot;&gt;&lt;code class=&quot;sourceCode bash&quot;&gt;&lt;span class=&quot;fu&quot;&gt;ssh-keygen&lt;/span&gt; -t ed25519 -f ~/.ssh/id_ed25519 -o -a 64&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3 id=&quot;copy-the-key-to-the-server&quot;&gt;Copy the key to the server&lt;/h3&gt;
&lt;p&gt;Copying the key to the server for public key authentication of ssh sessions is easy.&lt;/p&gt;
&lt;p&gt;Whenever I have the chance to use &lt;code&gt;ssh-copy-id&lt;/code&gt;, I use &lt;a href=&quot;/2017/06/21/my-openbsd-server-3-making-ssh-more-secure.html#with-ssh-copy-id&quot;&gt;that method&lt;/a&gt;. In other cases I do a variation of the &lt;a href=&quot;/2017/06/21/my-openbsd-server-3-making-ssh-more-secure.html#without-ssh-copy-id&quot;&gt;second method&lt;/a&gt;.&lt;/p&gt;
&lt;h4 id=&quot;with-ssh-copy-id&quot;&gt;With ssh-copy-id&lt;/h4&gt;
&lt;p&gt;After generating the key I needed to transfer it to my server.&lt;/p&gt;
&lt;p&gt;There are several ways to do this. The first thing to try out is using &lt;code&gt;ssh-copy-id&lt;/code&gt; like so (the server's IP is at 192.168.1.250 with the user &lt;code&gt;jan-server&lt;/code&gt;):&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot;&gt;&lt;pre class=&quot;sourceCode bash&quot;&gt;&lt;code class=&quot;sourceCode bash&quot;&gt;&lt;span class=&quot;ex&quot;&gt;ssh-copy-id&lt;/span&gt; -i ~/.ssh/id_ed25519 -p 22 jan-server@192.168.1.250&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h4 id=&quot;without-ssh-copy-id&quot;&gt;Without ssh-copy-id&lt;/h4&gt;
&lt;p&gt;There were cases when I couldn't use &lt;code&gt;ssh-copy-id&lt;/code&gt;, what I usually did then was:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Opening an ssh session in a terminal to the ssh public key receiver via &lt;code&gt;ssh -p 22 myuser@192.168.1.250&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;Open another terminal and copy the content of the public key file to the clipboard (&lt;strong&gt;Do not&lt;/strong&gt; use the file &lt;code&gt;~/.ssh/id_ed25519&lt;/code&gt; that is the private key file which should never leave your workstation but the file &lt;code&gt;~/.ssh/id_ed25519.pub&lt;/code&gt; the public key file belonging to that key)&lt;/li&gt;
&lt;/ul&gt;
&lt;div class=&quot;sourceCode&quot;&gt;&lt;pre class=&quot;sourceCode bash&quot;&gt;&lt;code class=&quot;sourceCode bash&quot;&gt;&lt;span class=&quot;fu&quot;&gt;cat&lt;/span&gt; ~/.ssh/id_ed25519.pub &lt;span class=&quot;kw&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;ex&quot;&gt;xclip&lt;/span&gt; -selection clipboard&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;This last command needs &lt;code&gt;xclip&lt;/code&gt; on your workstation (on a Debian like system install it via &lt;code&gt;sudo apt install xclip&lt;/code&gt;).&lt;/p&gt;
&lt;p&gt;Append the clipboard content to the authorized-keys file like so (pasting in the terminal &lt;code&gt;Ctrl-Shift-V&lt;/code&gt; or with an editor of your choice like vim):&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot;&gt;&lt;pre class=&quot;sourceCode bash&quot;&gt;&lt;code class=&quot;sourceCode bash&quot;&gt;&lt;span class=&quot;bu&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;st&quot;&gt;&amp;quot;ssh-ed25519 AAF23409SLFKJE02394FFTtlksdfowie3422DKdcweoDweoDFJwode99973fdOdjf9WT jan@jans-workstation&amp;quot;&lt;/span&gt; &lt;span class=&quot;op&quot;&gt;&amp;gt;&amp;gt;&lt;/span&gt; ~/.ssh/authorized_keys&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3 id=&quot;changing-ssh-configuration-on-client-and-server&quot;&gt;Changing ssh configuration on client and server&lt;/h3&gt;
&lt;p&gt;There are a lot of things to consider when changing the clients' and servers' configuration for OpenSSH.&lt;/p&gt;
&lt;p&gt;For most of the configurations (nearly all), I followed &lt;a href=&quot;https://stribika.github.io/2015/01/04/secure-secure-shell.html&quot;&gt;the documentation by stribika&lt;/a&gt;. Thank you for this great setup!&lt;/p&gt;
&lt;p&gt;Additionally I also set up a two factor authentication with the Google Authenticator App on my android device.&lt;/p&gt;
&lt;h3 id=&quot;setting-up-client-and-server&quot;&gt;Setting up (client and server)&lt;/h3&gt;
&lt;p&gt;Stribika proposed to change or generate the &lt;code&gt;/etc/ssh/moduli&lt;/code&gt; file. Because mine already existed, I modified my &lt;code&gt;/etc/ssh/moduli&lt;/code&gt; file like so (&lt;a href=&quot;https://stribika.github.io/2015/01/04/secure-secure-shell.html&quot;&gt;explained here&lt;/a&gt;):&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; startFrom=&quot;1&quot;&gt;&lt;table class=&quot;sourceCode bash numberLines&quot;&gt;&lt;tr class=&quot;sourceCode&quot;&gt;&lt;td class=&quot;lineNumbers&quot;&gt;&lt;pre&gt;1
2
3
4
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;sourceCode&quot;&gt;&lt;pre&gt;&lt;code class=&quot;sourceCode bash&quot;&gt;&lt;span class=&quot;fu&quot;&gt;awk&lt;/span&gt; &lt;span class=&quot;st&quot;&gt;&amp;#39;$5 &amp;gt; 2000&amp;#39;&lt;/span&gt; /etc/ssh/moduli &lt;span class=&quot;op&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;st&quot;&gt;&amp;quot;&lt;/span&gt;&lt;span class=&quot;va&quot;&gt;${HOME}&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;/moduli&amp;quot;&lt;/span&gt;
&lt;span class=&quot;fu&quot;&gt;wc&lt;/span&gt; -l &lt;span class=&quot;st&quot;&gt;&amp;quot;&lt;/span&gt;&lt;span class=&quot;va&quot;&gt;${HOME}&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;/moduli&amp;quot;&lt;/span&gt; &lt;span class=&quot;co&quot;&gt;# make sure there is something left&lt;/span&gt;
&lt;span class=&quot;fu&quot;&gt;sudo&lt;/span&gt; cp /etc/ssh/moduli /etc/ssh/moduli.bak
&lt;span class=&quot;fu&quot;&gt;sudo&lt;/span&gt; mv &lt;span class=&quot;st&quot;&gt;&amp;quot;&lt;/span&gt;&lt;span class=&quot;va&quot;&gt;${HOME}&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;/moduli&amp;quot;&lt;/span&gt; /etc/ssh/moduli&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;
&lt;ul&gt;
&lt;li&gt;&lt;em&gt;Line 1&lt;/em&gt;: Get all lines from &lt;code&gt;/etc/ssh/moduli&lt;/code&gt; that have a fifth column of a value greater than 2000 and copy them into a file in &lt;code&gt;~/moduli&lt;/code&gt;.&lt;/li&gt;
&lt;li&gt;&lt;em&gt;Line 2&lt;/em&gt;: Make sure that there are still lines left in the generated file.&lt;/li&gt;
&lt;li&gt;&lt;em&gt;Line 3&lt;/em&gt;: Make a backup of &lt;code&gt;moduli&lt;/code&gt; in case something goes wrong in the future.&lt;/li&gt;
&lt;li&gt;&lt;em&gt;Line 4&lt;/em&gt;: Copy the generated file over the existing one.&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&quot;ssh-configuration-server&quot;&gt;SSH configuration (server)&lt;/h3&gt;
&lt;h4 id=&quot;the-sshd_config&quot;&gt;The sshd_config&lt;/h4&gt;
&lt;p&gt;To alter the configuration of my ssh daemon on the server, I had to manipulate the file &lt;code&gt;/etc/ssh/sshd_config&lt;/code&gt; as shown below.&lt;/p&gt;
&lt;p&gt;The code snippet below shows the configuration that I definitely set for my sshd service (comments point out the different functionalities):&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; startFrom=&quot;1&quot;&gt;&lt;table class=&quot;sourceCode ini numberLines&quot;&gt;&lt;tr class=&quot;sourceCode&quot;&gt;&lt;td class=&quot;lineNumbers&quot;&gt;&lt;pre&gt;1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;sourceCode&quot;&gt;&lt;pre&gt;&lt;code class=&quot;sourceCode ini&quot;&gt;&lt;span class=&quot;co&quot;&gt;# /etc/ssh/sshd_config&lt;/span&gt;

&lt;span class=&quot;co&quot;&gt;# Make sure that ssh protocol version 2 is used only!&lt;/span&gt;
&lt;span class=&quot;dt&quot;&gt;Protocol 2&lt;/span&gt;

&lt;span class=&quot;co&quot;&gt;# Set the hostkeys that will be used for server authentication at the client&lt;/span&gt;
&lt;span class=&quot;co&quot;&gt;# first preferred one:&lt;/span&gt;
&lt;span class=&quot;dt&quot;&gt;HostKey /etc/ssh/ssh_host_ed25519_key&lt;/span&gt;
&lt;span class=&quot;co&quot;&gt;# fallback:&lt;/span&gt;
&lt;span class=&quot;dt&quot;&gt;HostKey /etc/ssh/ssh_host_rsa_key&lt;/span&gt;

&lt;span class=&quot;co&quot;&gt;# Chose a port that is not &amp;quot;standard&amp;quot; so default port scanning on low ports fail&lt;/span&gt;
&lt;span class=&quot;co&quot;&gt;# The port number can be a 16bit Integer. So the maximum is 65535&lt;/span&gt;
&lt;span class=&quot;dt&quot;&gt;Port 13423&lt;/span&gt;

&lt;span class=&quot;co&quot;&gt;# Tell sshd which key exchange algorithms it is allowed to use. The resource by stribka at&lt;/span&gt;
&lt;span class=&quot;co&quot;&gt;# https://stribika.github.io/2015/01/04/secure-secure-shell.html is explaining why these two (curve25519 and diffie-hellman sha256)&lt;/span&gt;
&lt;span class=&quot;co&quot;&gt;# are the only chosen ones&lt;/span&gt;
&lt;span class=&quot;dt&quot;&gt;KexAlgorithms curve25519-sha256@libssh.org,diffie-hellman-group-exchange-sha256&lt;/span&gt;

&lt;span class=&quot;co&quot;&gt;# Only allow strong symmetric cyphers (see stribka&amp;#39;s resource for detailed information)&lt;/span&gt;
&lt;span class=&quot;dt&quot;&gt;Ciphers chacha20-poly1305@openssh.com,aes256-gcm@openssh.com,aes128-gcm@openssh.com,aes256-ctr,aes192-ctr,aes128-ctr&lt;/span&gt;

&lt;span class=&quot;co&quot;&gt;# Only allow strong hmacs for message integrity (see stribka&amp;#39;s resource for detailed information)&lt;/span&gt;
&lt;span class=&quot;dt&quot;&gt;MACs hmac-sha2-512-etm@openssh.com,hmac-sha2-256-etm@openssh.com,hmac-ripemd160-etm@openssh.com,umac-128-etm@openssh.com,hmac-sha2-512,hmac-sha2-256,hmac-ripemd160,umac-128@openssh.com&lt;/span&gt;

&lt;span class=&quot;co&quot;&gt;# I do not want to permit root login for ssh in general&lt;/span&gt;
&lt;span class=&quot;co&quot;&gt;# If I would like to do that later I would choose to do it in a Match rule for specific addresses for example&lt;/span&gt;
&lt;span class=&quot;dt&quot;&gt;PermitRootLogin no&lt;/span&gt;

&lt;span class=&quot;co&quot;&gt;# The default is to check both .ssh/authorized_keys and .ssh/authorized_keys2&lt;/span&gt;
&lt;span class=&quot;co&quot;&gt;# but this is overridden so installations will only check .ssh/authorized_keys&lt;/span&gt;
&lt;span class=&quot;dt&quot;&gt;AuthorizedKeysFile      .ssh/authorized_keys&lt;/span&gt;

&lt;span class=&quot;co&quot;&gt;# Generally I want to disalow any kind of access&lt;/span&gt;
&lt;span class=&quot;co&quot;&gt;# and handle it in user or address specific match rules&lt;/span&gt;
&lt;span class=&quot;co&quot;&gt;# so disable pubkey authentication at first&lt;/span&gt;
&lt;span class=&quot;dt&quot;&gt;PubkeyAuthentication no&lt;/span&gt;

&lt;span class=&quot;co&quot;&gt;# To disable tunneled clear text passwords:&lt;/span&gt;
&lt;span class=&quot;dt&quot;&gt;PasswordAuthentication no&lt;/span&gt;

&lt;span class=&quot;co&quot;&gt;# allow challenge reponse authentication for 2 factor authentication with google authenticator&lt;/span&gt;
&lt;span class=&quot;dt&quot;&gt;ChallengeResponseAuthentication yes&lt;/span&gt;

&lt;span class=&quot;co&quot;&gt;# We do not want to permit empty passwords in any case:&lt;/span&gt;
&lt;span class=&quot;dt&quot;&gt;PermitEmptyPasswords no&lt;/span&gt;

&lt;span class=&quot;co&quot;&gt;# Generally disallow tcp forwarding&lt;/span&gt;
&lt;span class=&quot;dt&quot;&gt;AllowTcpForwarding no&lt;/span&gt;

&lt;span class=&quot;co&quot;&gt;# override default of no subsystems&lt;/span&gt;
&lt;span class=&quot;dt&quot;&gt;Subsystem       sftp    /usr/libexec/sftp-server&lt;/span&gt;

&lt;span class=&quot;co&quot;&gt;# only allow ssh sessions for members of the ssh-user group&lt;/span&gt;
&lt;span class=&quot;dt&quot;&gt;AllowGroups ssh-user&lt;/span&gt;

&lt;span class=&quot;co&quot;&gt;# then when its a member of the group ssh-user (like my user jan-server will be) to be logged in, do some specific actions:&lt;/span&gt;
&lt;span class=&quot;dt&quot;&gt;Match Group ssh-user &lt;/span&gt;
&lt;span class=&quot;dt&quot;&gt;        &lt;/span&gt;
&lt;span class=&quot;dt&quot;&gt;        &lt;/span&gt;&lt;span class=&quot;co&quot;&gt;# Allow tcp forwarding for the user jan-server (for enabling ssh session forwarding to my virtual machines)&lt;/span&gt;
&lt;span class=&quot;dt&quot;&gt;        AllowTcpForwarding yes&lt;/span&gt;
&lt;span class=&quot;dt&quot;&gt;        &lt;/span&gt;
&lt;span class=&quot;dt&quot;&gt;        &lt;/span&gt;&lt;span class=&quot;co&quot;&gt;# Allow password authentication (for allowing google authenticator OTP&amp;#39;s) &lt;/span&gt;
&lt;span class=&quot;dt&quot;&gt;        PasswordAuthentication yes&lt;/span&gt;
&lt;span class=&quot;dt&quot;&gt;        &lt;/span&gt;
&lt;span class=&quot;dt&quot;&gt;        &lt;/span&gt;&lt;span class=&quot;co&quot;&gt;# And allow pubkey authentication, so my generated pubkey can be used&lt;/span&gt;
&lt;span class=&quot;dt&quot;&gt;        PubkeyAuthentication yes&lt;/span&gt;

&lt;span class=&quot;dt&quot;&gt;        &lt;/span&gt;&lt;span class=&quot;co&quot;&gt;# Prompt for authentication in the following order: first ask for authenticaton of the public key then prompt for the two factor key on google-authenticator&lt;/span&gt;
&lt;span class=&quot;dt&quot;&gt;        AuthenticationMethods publickey,password&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;
&lt;h4 id=&quot;new-user-groups-and-keyfiles&quot;&gt;New user groups and keyfiles&lt;/h4&gt;
&lt;p&gt;After changing the configuration file I created a group called &lt;code&gt;ssh-user&lt;/code&gt; on the server:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot;&gt;&lt;pre class=&quot;sourceCode bash&quot;&gt;&lt;code class=&quot;sourceCode bash&quot;&gt;&lt;span class=&quot;ex&quot;&gt;doas&lt;/span&gt; groupadd ssh-user&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;and added my local user &lt;code&gt;jan-server&lt;/code&gt; to that group:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot;&gt;&lt;pre class=&quot;sourceCode bash&quot;&gt;&lt;code class=&quot;sourceCode bash&quot;&gt;&lt;span class=&quot;ex&quot;&gt;doas&lt;/span&gt; user mod -G ssh-user jan-server&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Then I deleted all host key files on the server and generated new ones:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot;&gt;&lt;pre class=&quot;sourceCode bash&quot;&gt;&lt;code class=&quot;sourceCode bash&quot;&gt;&lt;span class=&quot;bu&quot;&gt;cd&lt;/span&gt; /etc/ssh

&lt;span class=&quot;co&quot;&gt;# delete the host key files existing:&lt;/span&gt;
&lt;span class=&quot;fu&quot;&gt;rm&lt;/span&gt; ssh_host_*key*

&lt;span class=&quot;co&quot;&gt;# generate new ones that we use (only those two mentioned in the sshd_config)&lt;/span&gt;
&lt;span class=&quot;fu&quot;&gt;ssh-keygen&lt;/span&gt; -t ed25519 -f ssh_host_ed25519_key -N &lt;span class=&quot;st&quot;&gt;&amp;quot;&amp;quot;&lt;/span&gt; &lt;span class=&quot;op&quot;&gt;&amp;lt;&lt;/span&gt; /dev/null
&lt;span class=&quot;fu&quot;&gt;ssh-keygen&lt;/span&gt; -t rsa -b 4096 -f ssh_host_rsa_key -N &lt;span class=&quot;st&quot;&gt;&amp;quot;&amp;quot;&lt;/span&gt; &lt;span class=&quot;op&quot;&gt;&amp;lt;&lt;/span&gt; /dev/null&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h4 id=&quot;google-authenticator-integration&quot;&gt;Google authenticator integration&lt;/h4&gt;
&lt;p&gt;As an additional instance of security I wanted to integrate Google Authenticator as a second factor. I chose that because I already had it installed on my Android device. It is also &lt;a href=&quot;https://github.com/google/google-authenticator&quot;&gt;open source&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;Google Authenticator supports the &lt;a href=&quot;https://de.wikipedia.org/wiki/HMAC-based_One-time_Password_Algorithmus&quot;&gt;HMAC-based One-time Password Algorithm&lt;/a&gt; (OATH-HOTP) as of &lt;a href=&quot;https://tools.ietf.org/html/rfc4226&quot;&gt;RFC 4226&lt;/a&gt;.&lt;/p&gt;
&lt;h5 id=&quot;pre-requisites&quot;&gt;Pre-Requisites&lt;/h5&gt;
&lt;p&gt;I installed the following packages:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot;&gt;&lt;pre class=&quot;sourceCode bash&quot;&gt;&lt;code class=&quot;sourceCode bash&quot;&gt;&lt;span class=&quot;ex&quot;&gt;doas&lt;/span&gt; pkg_add login_oath
&lt;span class=&quot;ex&quot;&gt;doas&lt;/span&gt; pkg_add node&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;ul&gt;
&lt;li&gt;&lt;p&gt;&lt;code&gt;login_oath&lt;/code&gt; is used for using the time based one time password compatible to the google authenticator.&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;&lt;code&gt;node&lt;/code&gt; is used for installing a convenient wrapper for setting up the key-file for the one-time-password service.&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Afterwards I installed a tool for creating the keyfile for the Google Authenticator, I read the sourcecode beforehand to be sure its safe.:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot;&gt;&lt;pre class=&quot;sourceCode bash&quot;&gt;&lt;code class=&quot;sourceCode bash&quot;&gt;&lt;span class=&quot;ex&quot;&gt;npm&lt;/span&gt; install  -g https://github.com/WIZARDISHUNGRY/totp-util&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h5 id=&quot;set-up-the-key-file-and-give-it-to-my-android-device&quot;&gt;Set up the key file and give it to my Android device&lt;/h5&gt;
&lt;p&gt;On the server I then set up the keyfile by running &lt;code&gt;totp-util&lt;/code&gt; as the user I would like to be able to log in with (in my case that user was &lt;code&gt;jan-server&lt;/code&gt;).&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot;&gt;&lt;pre class=&quot;sourceCode bash&quot;&gt;&lt;code class=&quot;sourceCode bash&quot;&gt;&lt;span class=&quot;ex&quot;&gt;totp-util&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;I scanned the QR-code appearing on the console with my google authenticator app on my android phone.&lt;/p&gt;
&lt;h5 id=&quot;configure-login.conf-for-the-otp-integration&quot;&gt;Configure login.conf for the OTP integration&lt;/h5&gt;
&lt;p&gt;I added a new login class to &lt;code&gt;/etc/login.conf&lt;/code&gt; at the end of the file (appending) like so:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; startFrom=&quot;1&quot;&gt;&lt;table class=&quot;sourceCode bash numberLines&quot;&gt;&lt;tr class=&quot;sourceCode&quot;&gt;&lt;td class=&quot;lineNumbers&quot;&gt;&lt;pre&gt;1
2
3
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;sourceCode&quot;&gt;&lt;pre&gt;&lt;code class=&quot;sourceCode bash&quot;&gt;&lt;span class=&quot;ex&quot;&gt;totppw&lt;/span&gt;:\
    :auth-ssh=-totp,skey:\
    :tc=default:&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;
&lt;ul&gt;
&lt;li&gt;&lt;em&gt;Line 1&lt;/em&gt;: the name of the new login class.&lt;/li&gt;
&lt;li&gt;&lt;em&gt;Line 2&lt;/em&gt;: specifying the allowed login methods for ssh authentication to -totp (timebased one-time-password) and skey.&lt;/li&gt;
&lt;li&gt;&lt;em&gt;Line 3&lt;/em&gt;: use the defaults for everything else.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;I then recompiled the &lt;code&gt;login.conf&lt;/code&gt; file:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot;&gt;&lt;pre class=&quot;sourceCode bash&quot;&gt;&lt;code class=&quot;sourceCode bash&quot;&gt;&lt;span class=&quot;ex&quot;&gt;doas&lt;/span&gt; cap_mkd /etc/login.conf&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;And changed my user's login class to the newly generated &lt;code&gt;totppw&lt;/code&gt;:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot;&gt;&lt;pre class=&quot;sourceCode bash&quot;&gt;&lt;code class=&quot;sourceCode bash&quot;&gt;&lt;span class=&quot;ex&quot;&gt;doas&lt;/span&gt; usermod -L totppw jan-server&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h4 id=&quot;at-the-end-of-the-server-configuration&quot;&gt;At the end of the server configuration&lt;/h4&gt;
&lt;p&gt;I needed to reload the configuration file for the service:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot;&gt;&lt;pre class=&quot;sourceCode bash&quot;&gt;&lt;code class=&quot;sourceCode bash&quot;&gt;&lt;span class=&quot;ex&quot;&gt;doas&lt;/span&gt; rcctl reload sshd&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3 id=&quot;ssh-configuration-client&quot;&gt;SSH configuration (client)&lt;/h3&gt;
&lt;p&gt;The configuration for the client is done in &lt;code&gt;/etc/ssh/ssh_config&lt;/code&gt; and corresponds with the configurations that I chose for the server:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;Host *
    PasswordAuthentication yes
    
    ChallengeResponseAuthentication yes

    PubkeyAuthentication yes

    # this will choose the following algorithms for hostkey, ciphers and hmacs in the order from left to right (see Stribika&amp;#39;s documentation for more info):
    HostKeyAlgorithms ssh-ed25519-cert-v01@openssh.com,ssh-rsa-cert-v01@openssh.com,ssh-ed25519,ssh-rsa

    Ciphers chacha20-poly1305@openssh.com,aes256-gcm@openssh.com,aes128-gcm@openssh.com,aes256-ctr,aes192-ctr,aes128-ctr
    
    MACs hmac-sha2-512-etm@openssh.com,hmac-sha2-256-etm@openssh.com,hmac-ripemd160-etm@openssh.com,umac-128-etm@openssh.com,hmac-sha2-512,hmac-sha2-256,hmac-ripemd160,umac-128@openssh.com&lt;/code&gt;&lt;/pre&gt;
&lt;h3 id=&quot;thats-what-i-can-do-now&quot;&gt;That's what I can do now&lt;/h3&gt;
&lt;p&gt;Now when I do &lt;code&gt;ssh -p 13423 -i ~/.ssh/id_ed25519 jan-server@192.168.1.250&lt;/code&gt;, I am able to connect to my server via public key authentication and google authenticator like so (password are of course not shown in terminal input but I included them for better presentation):&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot;&gt;&lt;pre class=&quot;sourceCode bash&quot;&gt;&lt;code class=&quot;sourceCode bash&quot;&gt;&lt;span class=&quot;fu&quot;&gt;ssh&lt;/span&gt; -p 13423 -i ~/.ssh/id_ed25519 jan-server@192.168.1.250
&lt;span class=&quot;ex&quot;&gt;Enter&lt;/span&gt; passphrase for key &lt;span class=&quot;st&quot;&gt;&amp;#39;.ssh/id_ed25519&amp;#39;&lt;/span&gt;: mypubkeypasswd
&lt;span class=&quot;ex&quot;&gt;Authenticated&lt;/span&gt; with partial success.
&lt;span class=&quot;ex&quot;&gt;user@192.168.1.13&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&amp;#39;s password: 123456&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;For my convenience I also added these lines into my workstation's &lt;code&gt;~/.ssh/config&lt;/code&gt; file:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot;&gt;&lt;pre class=&quot;sourceCode bash&quot;&gt;&lt;code class=&quot;sourceCode bash&quot;&gt;&lt;span class=&quot;co&quot;&gt;# ~/.ssh/config&lt;/span&gt;

&lt;span class=&quot;ex&quot;&gt;Host&lt;/span&gt; server-local
    &lt;span class=&quot;ex&quot;&gt;Port&lt;/span&gt; 13423
    &lt;span class=&quot;ex&quot;&gt;HostName&lt;/span&gt; 192.168.1.250
    &lt;span class=&quot;ex&quot;&gt;User&lt;/span&gt; jan-server
    &lt;span class=&quot;ex&quot;&gt;IdentityFile&lt;/span&gt; ~/.ssh/id_ed25519

&lt;span class=&quot;ex&quot;&gt;Host&lt;/span&gt; server-remote
    &lt;span class=&quot;ex&quot;&gt;Port&lt;/span&gt; 13423
    &lt;span class=&quot;ex&quot;&gt;HostName&lt;/span&gt; hermes-technology.de
    &lt;span class=&quot;ex&quot;&gt;User&lt;/span&gt; jan-server
    &lt;span class=&quot;ex&quot;&gt;IdentityFile&lt;/span&gt; ~/.ssh/id_ed25519&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Now I can just do &lt;code&gt;ssh server-local&lt;/code&gt; when I want to connect to my server from the local network or &lt;code&gt;ssh server-remote&lt;/code&gt; when I want to connect from a remote place.&lt;/p&gt;
&lt;h3 id=&quot;configure-the-ssh-daemon-sshd-on-the-virtual-machines&quot;&gt;Configure the ssh daemon (sshd) on the virtual machines&lt;/h3&gt;
&lt;p&gt;As you may have noticed from my last posts: I have a server infrastructure, where different subdomain requests are forwarded to virtual machines on the main server.&lt;/p&gt;
&lt;p&gt;So for being able to do the same convenient ssh maintenance on my virtual machines, without ssh'ing to my main server and then connecting to the VMs via &lt;code&gt;vmctl&lt;/code&gt; &lt;a href=&quot;/openbsd/server/virtualmachine/network/2017/06/12/vmd-for-a-virtual-server-network.html#installing-and-configuring-nginx-on-the-host-vm&quot;&gt;as explained here&lt;/a&gt;, I have to configure the ssh daemons on the virtual machines as well and enable the public key authentication.&lt;/p&gt;
&lt;p&gt;I will explain how I did it on the &lt;code&gt;host-vm&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;Because OpenBSD on the &lt;code&gt;host-vm&lt;/code&gt; was installed as explained in the &lt;a href=&quot;/openbsd/server/virtualmachine/network/2017/06/12/vmd-for-a-virtual-server-network.html#guided-installation-of-openbsd-for-the-host-vm&quot;&gt;installation guide in my last post&lt;/a&gt;, the ssh daemon is enabled by default and root login is prohibited.&lt;/p&gt;
&lt;p&gt;On my workstation I logged in via ssh into my main server:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot;&gt;&lt;pre class=&quot;sourceCode bash&quot;&gt;&lt;code class=&quot;sourceCode bash&quot;&gt;&lt;span class=&quot;fu&quot;&gt;ssh&lt;/span&gt; server-local&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Then I logged into the &lt;code&gt;foo-vm&lt;/code&gt;:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot;&gt;&lt;pre class=&quot;sourceCode bash&quot;&gt;&lt;code class=&quot;sourceCode bash&quot;&gt;&lt;span class=&quot;ex&quot;&gt;vmctl&lt;/span&gt; console host-vm&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;To copy the ssh public key &lt;a href=&quot;/2017/06/21/my-openbsd-server-3-making-ssh-more-secure.html#create-an-ssh-key&quot;&gt;that I generated on my workstation&lt;/a&gt;, I chose the manual method without &lt;code&gt;ssh-copy-id&lt;/code&gt; as explained &lt;a href=&quot;/2017/06/21/my-openbsd-server-3-making-ssh-more-secure.html#without-ssh-copy-id&quot;&gt;here&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;Thereafter I first configured the &lt;code&gt;/etc/ssh/moduli&lt;/code&gt; file as explained &lt;a href=&quot;/2017/06/21/my-openbsd-server-3-making-ssh-more-secure.html#setting-up-client-and-server&quot;&gt;here&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;Then I followed &lt;a href=&quot;/2017/06/21/my-openbsd-server-3-making-ssh-more-secure.html#ssh-configuration-server&quot;&gt;the sshd configrations on the server&lt;/a&gt; and did some modifications in the &lt;code&gt;sshd_config&lt;/code&gt; file:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;On &lt;code&gt;line 14&lt;/code&gt; I changed the ssh Port to 22 (Nobody can access the ssh service on my virtual machine without reaching my main server, so if the attacker is already on the main server nothing matters anymore :-D).&lt;/li&gt;
&lt;li&gt;I also &lt;strong&gt;deleted&lt;/strong&gt; &lt;code&gt;line 62&lt;/code&gt; about allowing tcp forwarding (&lt;code&gt;AllowTcpForwarding yes&lt;/code&gt;), because it is unlikely that I will have nested VMs in the near future so I don't need to forward ssh requests to somebody else.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Of course I also changed the user &lt;code&gt;jan-server&lt;/code&gt; to &lt;code&gt;host&lt;/code&gt; as this is my username on the &lt;code&gt;host-vm&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;I followed the creation of the user group &lt;code&gt;ssh-user&lt;/code&gt; for allowing ssh login and integrated the Google Authenticator setup thereafter.&lt;/p&gt;
&lt;p&gt;At the end I had to reload the &lt;code&gt;sshd&lt;/code&gt; config: &lt;code&gt;doas rcctl reload sshd&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;Now also the &lt;code&gt;host-vm&lt;/code&gt; accepts the same ssh-key that was generated for the main server.&lt;/p&gt;
&lt;h3 id=&quot;access-virtual-machines-via-ssh-on-my-workstation&quot;&gt;Access virtual machines via ssh on my workstation&lt;/h3&gt;
&lt;p&gt;For an easy connection to my virtual machines from my workstation I added some lines to my &lt;code&gt;~/.ssh/config&lt;/code&gt; file (for each vm):&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; startFrom=&quot;1&quot;&gt;&lt;table class=&quot;sourceCode bash numberLines&quot;&gt;&lt;tr class=&quot;sourceCode&quot;&gt;&lt;td class=&quot;lineNumbers&quot;&gt;&lt;pre&gt;1
2
3
4
5
6
7
8
9
10
11
12
13
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;sourceCode&quot;&gt;&lt;pre&gt;&lt;code class=&quot;sourceCode bash&quot;&gt;&lt;span class=&quot;co&quot;&gt;# This block is for ssh connection when I&amp;#39;m in the local network:&lt;/span&gt;
&lt;span class=&quot;ex&quot;&gt;Host&lt;/span&gt; host-vm-local
    &lt;span class=&quot;ex&quot;&gt;Port&lt;/span&gt; 22
    &lt;span class=&quot;ex&quot;&gt;HostName&lt;/span&gt; 192.168.30.2
    &lt;span class=&quot;ex&quot;&gt;ProxyCommand&lt;/span&gt; ssh -A jan-server@192.168.1.250 -p 13423 -W %h:%p
    &lt;span class=&quot;ex&quot;&gt;User&lt;/span&gt; host 

&lt;span class=&quot;co&quot;&gt;# This block is for ssh connection when I&amp;#39;m at a remote place:&lt;/span&gt;
&lt;span class=&quot;ex&quot;&gt;Host&lt;/span&gt; host-vm-remote
    &lt;span class=&quot;ex&quot;&gt;Port&lt;/span&gt; 22
    &lt;span class=&quot;ex&quot;&gt;HostName&lt;/span&gt; 192.168.30.2
    &lt;span class=&quot;ex&quot;&gt;ProxyCommand&lt;/span&gt; ssh -A jan-server@hermes-technology.de -p 13423 -W %h:%p
    &lt;span class=&quot;ex&quot;&gt;User&lt;/span&gt; host &lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;
&lt;ul&gt;
&lt;li&gt;&lt;em&gt;Line 3&lt;/em&gt;: The ssh port on the virtual machine.&lt;/li&gt;
&lt;li&gt;&lt;em&gt;Line 4&lt;/em&gt;: The local IP of the virtual machine as reachable from the main server.&lt;/li&gt;
&lt;li&gt;&lt;em&gt;Line 5&lt;/em&gt;: Enables the forwarding of the ssh request to the virtual machine.&lt;/li&gt;
&lt;li&gt;&lt;em&gt;Line 6&lt;/em&gt;: The user on the virtual machine.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Logging in to virtual machines from my workstation now can easily be done by executing e.g. &lt;code&gt;ssh host-vm-local&lt;/code&gt;.&lt;/p&gt;
&lt;h2 id=&quot;make-pf-ban-ips-that-do-malicious-ssh-attempts&quot;&gt;Make PF ban IPs that do malicious ssh attempts&lt;/h2&gt;
&lt;p&gt;I wanted to block certain IPs from reconnecting via ssh if there were too many attempts with wrong credentials or if those attempts have a frequency that exceeded a certain limitation.&lt;/p&gt;
&lt;p&gt;So in short I wanted to react to brute force attackers like &lt;code&gt;fail2ban&lt;/code&gt; does.&lt;/p&gt;
&lt;p&gt;In addition I want those addresses to expire after a certain amount of time.&lt;/p&gt;
&lt;h3 id=&quot;enable-blocking-of-bruteforcers&quot;&gt;Enable blocking of bruteforcers&lt;/h3&gt;
&lt;p&gt;For this task I had to modify the &lt;code&gt;/etc/pf.conf&lt;/code&gt; and reload the firewall configuration.&lt;/p&gt;
&lt;p&gt;I added a table that is persistent and can be updated with new members:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot;&gt;&lt;pre class=&quot;sourceCode bash&quot;&gt;&lt;code class=&quot;sourceCode bash&quot;&gt;&lt;span class=&quot;ex&quot;&gt;table&lt;/span&gt; &lt;span class=&quot;op&quot;&gt;&amp;lt;&lt;/span&gt;bruters&lt;span class=&quot;op&quot;&gt;&amp;gt;&lt;/span&gt; persist&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;I told &lt;code&gt;pf&lt;/code&gt; that IPs listed in this list should be blocked by the server (this rule should be inserted early in your ruleset):&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot;&gt;&lt;pre class=&quot;sourceCode bash&quot;&gt;&lt;code class=&quot;sourceCode bash&quot;&gt;&lt;span class=&quot;ex&quot;&gt;block&lt;/span&gt; quick from &lt;span class=&quot;op&quot;&gt;&amp;lt;&lt;/span&gt;bruters&lt;span class=&quot;op&quot;&gt;&amp;gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Then I created a rule to update the brutes table for general connection attempts (not only ssh):&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot;&gt;&lt;pre class=&quot;sourceCode bash&quot;&gt;&lt;code class=&quot;sourceCode bash&quot;&gt;&lt;span class=&quot;ex&quot;&gt;pass&lt;/span&gt; inet proto tcp from any to &lt;span class=&quot;va&quot;&gt;$localnet&lt;/span&gt; port &lt;span class=&quot;va&quot;&gt;$services&lt;/span&gt; \
    flags S/SA keep state \
    (max-src-conn 80, max-src-conn-rate 15/5, \
    overload &lt;span class=&quot;op&quot;&gt;&amp;lt;&lt;/span&gt;bruters&lt;span class=&quot;op&quot;&gt;&amp;gt;&lt;/span&gt; flush global)&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;max-src-conn 80&lt;/code&gt; limits the maximum number of simultaneous TCP connections on my tcp services to 80.&lt;/li&gt;
&lt;li&gt;&lt;code&gt;max-src-conn-rate 15/5&lt;/code&gt; limits the rate of new connections over a time interval to 15 connections in 5 seconds.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;This will allow 80 connections from the same source and a connection rate of 15 connections in 5 seconds. Connections exceeding this limit will be added to the &lt;code&gt;bruters&lt;/code&gt; table and are blocked from any connection to my server until they are removed from the &lt;code&gt;bruters&lt;/code&gt; table.&lt;/p&gt;
&lt;p&gt;Then I added another rule early in my ruleset that specifically blocks ssh bruteforcers. This rule is a little bit stricter on its limits:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;pass quick proto tcp from any to any port 13423 \
        flags S/SA keep state \
        (max-src-conn 5, max-src-conn-rate 5/3, \
        overload &amp;lt;bruters&amp;gt; flush global)&lt;/code&gt;&lt;/pre&gt;
&lt;h3 id=&quot;enable-expiration-of-bruterforcers-over-time&quot;&gt;Enable expiration of bruterforcers over time&lt;/h3&gt;
&lt;p&gt;For expiring IP addresses in the &lt;code&gt;bruters&lt;/code&gt; table I added a cron job into the crontab file:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot;&gt;&lt;pre class=&quot;sourceCode bash&quot;&gt;&lt;code class=&quot;sourceCode bash&quot;&gt;&lt;span class=&quot;co&quot;&gt;# /etc/crontab&lt;/span&gt;
&lt;span class=&quot;ex&quot;&gt;@daily&lt;/span&gt; root pfctl -t brutes -T expire 86400&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;This cronjob will be executed daily and remove entries in the &lt;code&gt;bruters&lt;/code&gt; table that exceed the duration of presence for 86400 seconds (24 hours).&lt;/p&gt;
&lt;h2 id=&quot;conclusion&quot;&gt;Conclusion&lt;/h2&gt;
&lt;p&gt;Now I'm able to login to ssh sessions from my workstation, only using my ed25519 key and the Google Authenticator prompt as second factor.&lt;/p&gt;
&lt;p&gt;SSH sessions can be opened as easy as:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot;&gt;&lt;pre class=&quot;sourceCode bash&quot;&gt;&lt;code class=&quot;sourceCode bash&quot;&gt;&lt;span class=&quot;co&quot;&gt;# for server from local network&lt;/span&gt;
&lt;span class=&quot;fu&quot;&gt;ssh&lt;/span&gt; server-local

&lt;span class=&quot;co&quot;&gt;# for server from remote network&lt;/span&gt;
&lt;span class=&quot;fu&quot;&gt;ssh&lt;/span&gt; server-remote

&lt;span class=&quot;co&quot;&gt;# for vms from local network (exchange &amp;lt;vm&amp;gt; with e.g. host-vm as showed above)&lt;/span&gt;
&lt;span class=&quot;fu&quot;&gt;ssh&lt;/span&gt; &lt;span class=&quot;op&quot;&gt;&amp;lt;&lt;/span&gt;vm&lt;span class=&quot;op&quot;&gt;&amp;gt;&lt;/span&gt;-local

&lt;span class=&quot;co&quot;&gt;# for vms from remote network&lt;/span&gt;
&lt;span class=&quot;fu&quot;&gt;ssh&lt;/span&gt; &lt;span class=&quot;op&quot;&gt;&amp;lt;&lt;/span&gt;vm&lt;span class=&quot;op&quot;&gt;&amp;gt;&lt;/span&gt;-remote&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&amp;quot;Insecure&amp;quot; plain password connections are not supported anymore.&lt;/p&gt;
&lt;p&gt;Failing ssh connections will remembered and according IPs will be banned for the specified amounts of time as presented in the last section of this post.&lt;/p&gt;
&lt;h2 id=&quot;outlook&quot;&gt;Outlook&lt;/h2&gt;
&lt;p&gt;I'm not sure yet what I will be writing about in my next post. Maybe I will find out how to use &lt;code&gt;relayd&lt;/code&gt; as a substitute of &lt;code&gt;nginx&lt;/code&gt; &lt;a href=&quot;/openbsd/server/virtualmachine/network/2017/06/12/vmd-for-a-virtual-server-network.html#installing-and-configuring-nginx-on-the-host-vm&quot;&gt;for redirecting subdomain requests&lt;/a&gt; to my local VM IPs, then I will probably be writing about that (there is also &lt;a href=&quot;https://serverfault.com/questions/856807/openbsd-how-to-use-relayd-and-httpd-for-redirecting-subdomain-requests&quot;&gt;an open question&lt;/a&gt; for this on stack exchange). Maybe I will also write about a backup utility that I set up as a cronjob for doing frequent backups of my main-server and the VMs.&lt;/p&gt;
&lt;p&gt;But until then I'm happy about comments and any suggestions that you have for me, &amp;quot;see&amp;quot; you soon.&lt;/p&gt;
&lt;p&gt;Jan&lt;/p&gt;</content><author><name></name></author><summary type="html">I wanted my server's ssh access to be much more secure than default. This includes choosing strong algorithms for authentication, integrity and encription as well as setting up a two-factor login via Google Authenticator.</summary></entry><entry><title type="html">A virtualized network with OpenBSD’s vmm</title><link href="https://blog.hermes-technology.de/openbsd/server/virtualmachine/network/2017/06/12/vmd-for-a-virtual-server-network.html" rel="alternate" type="text/html" title="A virtualized network with OpenBSD's vmm" /><published>2017-06-12T01:00:00+02:00</published><updated>2017-06-12T01:00:00+02:00</updated><id>https://blog.hermes-technology.de/openbsd/server/virtualmachine/network/2017/06/12/vmd-for-a-virtual-server-network</id><content type="html" xml:base="https://blog.hermes-technology.de/openbsd/server/virtualmachine/network/2017/06/12/vmd-for-a-virtual-server-network.html">&lt;p&gt;&lt;strong&gt;UPDATE:&lt;/strong&gt; As I already suggested in the outlook of my last post, I wanted to exchange &lt;code&gt;nginx&lt;/code&gt; with &lt;code&gt;relayd&lt;/code&gt; for redirection. I did this now, thanks to &lt;a href=&quot;https://serverfault.com/questions/856807/openbsd-how-to-use-relayd-and-httpd-for-redirecting-subdomain-requests/858849#858849&quot;&gt;an answered question on stackoverflow&lt;/a&gt;. See the new section: &lt;a href=&quot;/openbsd/server/virtualmachine/network/2017/06/12/vmd-for-a-virtual-server-network.html#configuring-relayd-on-the-host-vm&quot;&gt;Configuring relayd on the host-vm&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;Hello dear reader,&lt;/p&gt;
&lt;p&gt;in my last post I described the setup of a http server which is reachable through a public domain on OpenBSD. This time I would like to go a little bit further and extend the server with a network of virtual machines, where each machine can be reached by the name of the subdomain it should represent.&lt;/p&gt;
&lt;h2 id=&quot;intro&quot;&gt;Intro&lt;/h2&gt;
&lt;p&gt;For this setup to work, I needed to download two files from the OpenBSD site:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;The installation file of the most recent OpenBSD system (at the time it was 6.1)&lt;/li&gt;
&lt;li&gt;The boot file (bsd.rd)&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Afterwards I had to install the VM, configure it, duplicate it for the virtual network.&lt;/p&gt;
&lt;p&gt;Then I had to configure the main server and everything worked like a charm in the end.&lt;/p&gt;
&lt;p&gt;For better explenation I will include a similar figure as show in my last two posts.&lt;/p&gt;
&lt;figure&gt;
&lt;figcaption&gt;
&lt;i&gt;Figure 1: Virtual Network on my server&lt;/i&gt;
&lt;/figcaption&gt;
&lt;img src=&quot;https://blog.hermes-technology.de/assets/server-sketch-foo-bar.svg.png&quot; title=&quot;Figure 1: Virtual Network on my server&quot; alt=&quot;Server Infrastructure&quot; /&gt;
&lt;/figure&gt;
&lt;p&gt;You can see that there are serveral components to be configured for the virtual network to work as desired in the end:&lt;/p&gt;
&lt;p&gt;I need to...:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;...configure &lt;code&gt;pf&lt;/code&gt; for redirection and NAT&lt;/li&gt;
&lt;li&gt;...configure &lt;code&gt;unbound&lt;/code&gt; for acting as a DNS server&lt;/li&gt;
&lt;li&gt;...create three different VMs (host-vm, foo-vm, bar-vm)&lt;/li&gt;
&lt;li&gt;...connect the VMs to a virtual switch called &amp;quot;localnet&amp;quot;&lt;/li&gt;
&lt;li&gt;...configure &lt;code&gt;relayd&lt;/code&gt; on the host-vm for redirection of subdomain requests&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&quot;outline&quot;&gt;Outline&lt;/h3&gt;
&lt;p&gt;Here a short outline to jump back and forth (turn off &lt;code&gt;noscript&lt;/code&gt; for a second to see it :-) ):&lt;/p&gt;
&lt;div id=&quot;toc&quot;&gt;

&lt;/div&gt;
&lt;h2 id=&quot;create-the-vms&quot;&gt;Create the VMs&lt;/h2&gt;
&lt;p&gt;This section will deal about creating a raw disk image and installing OpenBSD on it via the OpenBSD included &lt;code&gt;vmd&lt;/code&gt; framework. This includes downloading some necessary resources and creating and installing a VM with the application called &lt;code&gt;vmctl&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;Afterwards the created installation will be duplicated and set up for the different VMs.&lt;/p&gt;
&lt;h3 id=&quot;create-the-host-vm&quot;&gt;Create the Host VM&lt;/h3&gt;
&lt;h4 id=&quot;choose-my-mirror-to-download-from&quot;&gt;Choose my mirror to download from&lt;/h4&gt;
&lt;p&gt;There are many mirrors that I could choose from: listed &lt;a href=&quot;https://www.openbsd.org/ftp.html&quot;&gt;here&lt;/a&gt; on the OpenBSD website.&lt;/p&gt;
&lt;h4 id=&quot;download-the-files&quot;&gt;Download the files&lt;/h4&gt;
&lt;p&gt;At first I located the necessary files in a webbrowser on my system. I chose the mirror in Frankfurt, so the main url was &lt;a href=&quot;https://ftp.hostserver.de/pub/OpenBSD/&quot; class=&quot;uri&quot;&gt;https://ftp.hostserver.de/pub/OpenBSD/&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;There I chose the most recent OpenBSD version 6.1 and navigated to the directory for amd64 ending here: &lt;a href=&quot;https://ftp.hostserver.de/pub/OpenBSD/6.1/amd64/&quot; class=&quot;uri&quot;&gt;https://ftp.hostserver.de/pub/OpenBSD/6.1/amd64/&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;The necessary files are:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;install61.fs&lt;/code&gt; the OpenBSD installation image, that I already downloaded when I created a bootable USB Stick for my OpenBSD Installation.&lt;/li&gt;
&lt;li&gt;&lt;code&gt;bsd.rd&lt;/code&gt; the boot image of OpenBSD.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;I opened an ssh-session to the server and downloaded those files via &lt;code&gt;ftp&lt;/code&gt; (I'm using &lt;code&gt;ftp&lt;/code&gt; now and not &lt;code&gt;wget&lt;/code&gt;, as it is in base, thank you for the comment Raf):&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot;&gt;&lt;pre class=&quot;sourceCode bash&quot;&gt;&lt;code class=&quot;sourceCode bash&quot;&gt;&lt;span class=&quot;bu&quot;&gt;cd&lt;/span&gt; ~
&lt;span class=&quot;fu&quot;&gt;mkdir&lt;/span&gt; vm-network
&lt;span class=&quot;bu&quot;&gt;cd&lt;/span&gt; vm-network
&lt;span class=&quot;fu&quot;&gt;ftp&lt;/span&gt; https://ftp.hostserver.de/pub/OpenBSD/6.1/amd64/install61.fs
&lt;span class=&quot;fu&quot;&gt;ftp&lt;/span&gt; https://ftp.hostserver.de/pub/OpenBSD/6.1/amd64/bsd.rd&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;As PengouinBSD correctly suggested in the comments, I should also check the downloaded files:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;cd vm-network
ftp https://ftp.hostserver.de/pub/OpenBSD/6.1/amd64/SHA256.sig
signify -Cp /etc/signify/openbsd-61-base.pub -x SHA256.sig install61.fs bsd.rd&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;From now on I assume you also have a folder called &lt;code&gt;vm-network&lt;/code&gt; in your user's home directory.&lt;/p&gt;
&lt;h4 id=&quot;create-a-raw-disk-file-and-start-the-installation&quot;&gt;Create a raw disk file and start the installation&lt;/h4&gt;
&lt;p&gt;I'm located in my dedicated folder &lt;code&gt;vm-network&lt;/code&gt;, where the previously downloaded files &lt;code&gt;install61.fs&lt;/code&gt; and &lt;code&gt;bsd.rd&lt;/code&gt; are located.&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot;&gt;&lt;pre class=&quot;sourceCode bash&quot;&gt;&lt;code class=&quot;sourceCode bash&quot;&gt;&lt;span class=&quot;bu&quot;&gt;cd&lt;/span&gt; ~/vm-network&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Within this folder I created a raw disk image called &lt;code&gt;host.drive&lt;/code&gt; with 8GB:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot;&gt;&lt;pre class=&quot;sourceCode bash&quot;&gt;&lt;code class=&quot;sourceCode bash&quot;&gt;&lt;span class=&quot;ex&quot;&gt;doas&lt;/span&gt; vmctl create host.drive -s 8G&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;And started installing on this disk interactively with a console:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot;&gt;&lt;pre class=&quot;sourceCode bash&quot;&gt;&lt;code class=&quot;sourceCode bash&quot;&gt;&lt;span class=&quot;ex&quot;&gt;doas&lt;/span&gt; vmctl start &lt;span class=&quot;st&quot;&gt;&amp;quot;host-vm&amp;quot;&lt;/span&gt; -c -b bsd.rd -m 2G -i 1 -d host.drive -d install61.fs&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;The options that are provided to &lt;code&gt;vmctl&lt;/code&gt; mean the following:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;start &amp;quot;host-vm&amp;quot;&lt;/code&gt;: start the virtual machine, naming it &amp;quot;host-vm&amp;quot;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;-c&lt;/code&gt;: immediately connect the console of the vm into the current shell&lt;/li&gt;
&lt;li&gt;&lt;code&gt;-b bsd.rd&lt;/code&gt;: choose the specified image as boot kernel&lt;/li&gt;
&lt;li&gt;&lt;code&gt;-m 2G&lt;/code&gt;: start the virtual machine with two gigabytes of memory&lt;/li&gt;
&lt;li&gt;&lt;code&gt;-i 1&lt;/code&gt;: create a virtual network interface connected to that virtual machine&lt;/li&gt;
&lt;li&gt;&lt;code&gt;-d host.drive&lt;/code&gt;: attach the raw disk file where to install OpenBSD on&lt;/li&gt;
&lt;li&gt;&lt;code&gt;-d install61.fs&lt;/code&gt;: attach the image with the OpenBSD 6.1 installation files&lt;/li&gt;
&lt;/ul&gt;
&lt;div class=&quot;tip&quot;&gt;
&lt;table&gt;
&lt;colgroup&gt;
&lt;col style=&quot;width: 100%&quot; /&gt;
&lt;/colgroup&gt;
&lt;thead&gt;
&lt;tr class=&quot;header&quot;&gt;
&lt;th&gt;&lt;strong&gt;A TIP TO PREVENT FUTURE HEADACHES&lt;/strong&gt;&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr class=&quot;odd&quot;&gt;
&lt;td&gt;&lt;p&gt;If you ever run into the problem of this annoying Error when running the command &lt;code&gt;vmctl start ...&lt;/code&gt;:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot;&gt;&lt;pre class=&quot;sourceCode bash&quot;&gt;&lt;code class=&quot;sourceCode bash&quot;&gt;&lt;span class=&quot;ex&quot;&gt;doas&lt;/span&gt; vmctl start &lt;span class=&quot;st&quot;&gt;&amp;quot;myvm&amp;quot;&lt;/span&gt; -i 1 -d xyz.drive
&lt;span class=&quot;ex&quot;&gt;vmctl&lt;/span&gt;: start vm command failed: No such file or directory&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;then you're probably missing the device file for the taps in &lt;code&gt;/dev&lt;/code&gt;. The installer creates 4 by default, so you'll have to run...&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot;&gt;&lt;pre class=&quot;sourceCode bash&quot;&gt;&lt;code class=&quot;sourceCode bash&quot;&gt;&lt;span class=&quot;bu&quot;&gt;cd&lt;/span&gt; /dev&lt;span class=&quot;kw&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;sh&lt;/span&gt; MAKEDEV tap4&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;...and so on for each new tap device you need.&lt;/p&gt;
&lt;p&gt;I took this tip from &lt;a href=&quot;http://openbsd-archive.7691.n7.nabble.com/vmd-upper-limit-on-number-of-vm-s-td312916.html&quot;&gt;here&lt;/a&gt; when I ran into a simmilar problem.&lt;/p&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;h4 id=&quot;guided-installation-of-openbsd-for-the-host-vm&quot;&gt;Guided Installation of OpenBSD for the host-vm&lt;/h4&gt;
&lt;p&gt;In &lt;em&gt;Table 1&lt;/em&gt; below I show the whole installation process and what I did including some comments.&lt;/p&gt;
&lt;figure&gt;
&lt;figcaption&gt;
&lt;i&gt;Table 1: Guided Installation&lt;/i&gt;
&lt;/figcaption&gt;
&lt;table&gt;
&lt;colgroup&gt;
&lt;col style=&quot;width: 56%&quot; /&gt;
&lt;col style=&quot;width: 21%&quot; /&gt;
&lt;col style=&quot;width: 21%&quot; /&gt;
&lt;/colgroup&gt;
&lt;thead&gt;
&lt;tr class=&quot;header&quot;&gt;
&lt;th&gt;&lt;strong&gt;Terminal Output&lt;/strong&gt;&lt;/th&gt;
&lt;th&gt;&lt;strong&gt;My Input&lt;/strong&gt;&lt;/th&gt;
&lt;th&gt;&lt;strong&gt;Comments&lt;/strong&gt;&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr class=&quot;odd&quot;&gt;
&lt;td&gt;&lt;pre&gt;&lt;code&gt;Welcome to the OpenBSD/amd64 6.1 installation program.
(I)nstall, (U)pgrade, (A)utoinstall or (S)hell?&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td&gt;&lt;p&gt;&lt;code&gt;I&lt;/code&gt;&lt;/p&gt;&lt;/td&gt;
&lt;td&gt;&lt;p&gt;I want to install OpenBSD&lt;/p&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr class=&quot;even&quot;&gt;
&lt;td&gt;&lt;pre&gt;&lt;code&gt;Terminal type? [vt220]&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td&gt;&lt;p&gt;&lt;em&gt;return&lt;/em&gt;&lt;/p&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr class=&quot;odd&quot;&gt;
&lt;td&gt;&lt;pre&gt;&lt;code&gt;System hostname? (short form, e.g. &amp;#39;foo&amp;#39;)&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td&gt;&lt;p&gt;&lt;code&gt;host&lt;/code&gt;&lt;/p&gt;&lt;/td&gt;
&lt;td&gt;&lt;p&gt;Call it host, because it will be the host for the vm net.&lt;/p&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr class=&quot;even&quot;&gt;
&lt;td&gt;&lt;pre&gt;&lt;code&gt;Available network interfaces are: vio0 vlan0
Which network interface do you wish to configure? (or &amp;#39;done&amp;#39;) [vio0]&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td&gt;&lt;p&gt;&lt;em&gt;return&lt;/em&gt;&lt;/p&gt;&lt;/td&gt;
&lt;td&gt;&lt;p&gt;Yes, configure vio0.&lt;/p&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr class=&quot;odd&quot;&gt;
&lt;td&gt;&lt;pre&gt;&lt;code&gt;IPv4 address for vio0? (or &amp;#39;dhcp&amp;#39; or &amp;#39;none&amp;#39;) [dhcp]&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td&gt;&lt;p&gt;&lt;code&gt;192.168.30.2&lt;/code&gt;&lt;/p&gt;&lt;/td&gt;
&lt;td&gt;&lt;p&gt;ip address of my vm in the virtual network&lt;/p&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr class=&quot;even&quot;&gt;
&lt;td&gt;&lt;pre&gt;&lt;code&gt;Netmask for vio0? [255.255.255.0]&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td&gt;&lt;p&gt;&lt;em&gt;return&lt;/em&gt;&lt;/p&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr class=&quot;odd&quot;&gt;
&lt;td&gt;&lt;pre&gt;&lt;code&gt;IPv6 address for vio0? (or &amp;#39;rtsol&amp;#39; or &amp;#39;none&amp;#39;) [none]&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td&gt;&lt;p&gt;&lt;em&gt;return&lt;/em&gt;&lt;/p&gt;&lt;/td&gt;
&lt;td&gt;&lt;p&gt;Don't need an IPv6 address.&lt;/p&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr class=&quot;even&quot;&gt;
&lt;td&gt;&lt;pre&gt;&lt;code&gt;Which network interface do you wish to configure? (or &amp;#39;done&amp;#39;) [done]&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td&gt;&lt;p&gt;&lt;em&gt;return&lt;/em&gt;&lt;/p&gt;&lt;/td&gt;
&lt;td&gt;&lt;p&gt;I'm done.&lt;/p&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr class=&quot;odd&quot;&gt;
&lt;td&gt;&lt;pre&gt;&lt;code&gt;Default IPv4 route? (IPv4 address or none)&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td&gt;&lt;p&gt;&lt;code&gt;192.168.30.1&lt;/code&gt;&lt;/p&gt;&lt;/td&gt;
&lt;td&gt;&lt;p&gt;The address of the router that manages my virtual network. I chose 192.168.30.1 for the subnet 192.168.30.0/24.&lt;/p&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr class=&quot;even&quot;&gt;
&lt;td&gt;&lt;pre&gt;&lt;code&gt;add net default: gateway 192.168.30.1&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr class=&quot;odd&quot;&gt;
&lt;td&gt;&lt;pre&gt;&lt;code&gt;DNS domain name? (e.g. &amp;#39;bar.com&amp;#39;) [my.domain]&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td&gt;&lt;p&gt;&lt;code&gt;hermes-technology.de&lt;/code&gt;&lt;/p&gt;&lt;/td&gt;
&lt;td&gt;&lt;p&gt;The root domain (In the end it will resolve to the hostname &lt;code&gt;host.hermes-technology.de&lt;/code&gt;.&lt;/p&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr class=&quot;even&quot;&gt;
&lt;td&gt;&lt;pre&gt;&lt;code&gt;DNS nameservers? (IP address list or &amp;#39;none&amp;#39;) [none]&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td&gt;&lt;p&gt;&lt;code&gt;192.168.30.1&lt;/code&gt;&lt;/p&gt;&lt;/td&gt;
&lt;td&gt;&lt;p&gt;My DNS nameserver should be serving on the virtual NIC with that IP.&lt;/p&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr class=&quot;odd&quot;&gt;
&lt;td&gt;&lt;pre&gt;&lt;code&gt;Password for root account? (will not echo)
Password for root account? (again)&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td&gt;&lt;p&gt;2x &lt;code&gt;mypasswd&lt;/code&gt;&lt;/p&gt;&lt;/td&gt;
&lt;td&gt;&lt;p&gt;I did choose another password of course.. :D&lt;/p&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr class=&quot;even&quot;&gt;
&lt;td&gt;&lt;pre&gt;&lt;code&gt;Start sshd(8) by default? [yes]&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td&gt;&lt;p&gt;&lt;em&gt;return&lt;/em&gt;&lt;/p&gt;&lt;/td&gt;
&lt;td&gt;&lt;p&gt;Yes I want to connect via ssh later on.&lt;/p&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr class=&quot;odd&quot;&gt;
&lt;td&gt;&lt;pre&gt;&lt;code&gt;Change the default console to com0? [yes]&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td&gt;&lt;p&gt;&lt;em&gt;return&lt;/em&gt;&lt;/p&gt;&lt;/td&gt;
&lt;td&gt;&lt;p&gt;sure...&lt;/p&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr class=&quot;even&quot;&gt;
&lt;td&gt;&lt;pre&gt;&lt;code&gt;Which speed should com0 use? (or &amp;#39;done&amp;#39;) [9600]&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td&gt;&lt;p&gt;&lt;em&gt;return&lt;/em&gt;&lt;/p&gt;&lt;/td&gt;
&lt;td&gt;&lt;p&gt;definitely...&lt;/p&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr class=&quot;odd&quot;&gt;
&lt;td&gt;&lt;pre&gt;&lt;code&gt;Setup a user? (enter a lower-case loginname, or &amp;#39;no&amp;#39;) [no]&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td&gt;&lt;p&gt;&lt;code&gt;host&lt;/code&gt;&lt;/p&gt;&lt;/td&gt;
&lt;td&gt;&lt;p&gt;I want the user called &amp;quot;host&amp;quot;&lt;/p&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr class=&quot;even&quot;&gt;
&lt;td&gt;&lt;pre&gt;&lt;code&gt;Full name for user host? [host]&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td&gt;&lt;p&gt;&lt;em&gt;return&lt;/em&gt;&lt;/p&gt;&lt;/td&gt;
&lt;td&gt;&lt;p&gt;Don't need a full name -.-&lt;/p&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr class=&quot;odd&quot;&gt;
&lt;td&gt;&lt;pre&gt;&lt;code&gt;Password for user host? (will not echo)
Password for user host? (again)&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td&gt;&lt;p&gt;2x &lt;code&gt;mypasswd&lt;/code&gt;&lt;/p&gt;&lt;/td&gt;
&lt;td&gt;&lt;p&gt;Another safe password...&lt;/p&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr class=&quot;even&quot;&gt;
&lt;td&gt;&lt;pre&gt;&lt;code&gt;WARNING: root is targeted by password guessing attacks, pubkeys are safer.
Allow root ssh login? (yes, no, prohibit-password) [no]&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td&gt;&lt;p&gt;&lt;em&gt;return&lt;/em&gt;&lt;/p&gt;&lt;/td&gt;
&lt;td&gt;&lt;p&gt;I don't want to support a direct root login via ssh.&lt;/p&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr class=&quot;odd&quot;&gt;
&lt;td&gt;&lt;pre&gt;&lt;code&gt;Available disks are: sd0 sd1.
Which disk is the root disk? (&amp;#39;?&amp;#39; for details) [sd0]&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td&gt;&lt;p&gt;&lt;code&gt;?&lt;/code&gt;&lt;/p&gt;&lt;/td&gt;
&lt;td&gt;&lt;p&gt;List me the disks!&lt;/p&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr class=&quot;even&quot;&gt;
&lt;td&gt;&lt;pre&gt;&lt;code&gt;sd0: Block Device (8.0G)
sd1: Block Device (0.3G)&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;Ok it seems the sd0 with 8G is the one I want.&lt;/td&gt;
&lt;/tr&gt;
&lt;tr class=&quot;odd&quot;&gt;
&lt;td&gt;&lt;pre&gt;&lt;code&gt;Available disks are: sd0 sd1.
Which disk is the root disk? (&amp;#39;?&amp;#39; for details) [sd0]&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td&gt;&lt;p&gt;&lt;em&gt;return&lt;/em&gt;&lt;/p&gt;&lt;/td&gt;
&lt;td&gt;&lt;p&gt;Yes, take sd0.&lt;/p&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr class=&quot;even&quot;&gt;
&lt;td&gt;&lt;pre&gt;&lt;code&gt;No valid MBR or GPT.
Use (W)hole disk MBR, whole disk (G)PT or (E)dit? [whole]&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td&gt;&lt;p&gt;&lt;em&gt;return&lt;/em&gt;&lt;/p&gt;&lt;/td&gt;
&lt;td&gt;&lt;p&gt;Use the whole disk!&lt;/p&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr class=&quot;odd&quot;&gt;
&lt;td&gt;&lt;pre&gt;&lt;code&gt;Setting OpenBSD MBR partition to whole sd0...done.
The auto-allocated layout for sd0 is:
#                size           offset  fstype [fsize bsize   cpg]
  a:           131.1M               64  4.2BSD   2048 16384     1 # /
  b:           182.1M           268480    swap
  c:          8192.0M                0  unused
  d:           201.7M           641504  4.2BSD   2048 16384     1 # /tmp
  e:           212.8M          1054560  4.2BSD   2048 16384     1 # /var
  f:           951.1M          1490304  4.2BSD   2048 16384     1 # /usr
  g:           542.6M          3438080  4.2BSD   2048 16384     1 # /usr/X11R6
  h:          2150.1M          4549376  4.2BSD   2048 16384     1 # /usr/local
  i:          1044.4M          8952832  4.2BSD   2048 16384     1 # /usr/src
  j:          1340.8M         11091808  4.2BSD   2048 16384     1 # /usr/obj
  k:          1432.5M         13837856  4.2BSD   2048 16384     1 # /home
Use (A)uto layout, (E)dit auto layout, or create (C)ustom layout? [a]&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td&gt;&lt;p&gt;&lt;em&gt;return&lt;/em&gt;&lt;/p&gt;&lt;/td&gt;
&lt;td&gt;&lt;p&gt;Auto layout worked for me..&lt;/p&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr class=&quot;even&quot;&gt;
&lt;td&gt;&lt;pre&gt;&lt;code&gt;Rounding size to bsize (32 sectors): 268416
Rounding offset to bsize (32 sectors): 641504
Rounding size to bsize (32 sectors): 413056
Rounding size to bsize (32 sectors): 435744
Rounding size to bsize (32 sectors): 1947776
Rounding size to bsize (32 sectors): 1111296
Rounding size to bsize (32 sectors): 4403456
Rounding size to bsize (32 sectors): 2138976
Rounding size to bsize (32 sectors): 2746048
Rounding size to bsize (32 sectors): 2933856
/dev/rsd0a: 131.1MB in 268416 sectors of 512 bytes
4 cylinder groups of 32.77MB, 2097 blocks, 4224 inodes each
/dev/rsd0k: 1432.5MB in 2933856 sectors of 512 bytes
8 cylinder groups of 202.47MB, 12958 blocks, 25984 inodes each
/dev/rsd0d: 201.7MB in 413056 sectors of 512 bytes
4 cylinder groups of 50.42MB, 3227 blocks, 6528 inodes each
/dev/rsd0f: 951.1MB in 1947776 sectors of 512 bytes
5 cylinder groups of 202.47MB, 12958 blocks, 25984 inodes each
/dev/rsd0g: 542.6MB in 1111296 sectors of 512 bytes
4 cylinder groups of 135.66MB, 8682 blocks, 17408 inodes each
/dev/rsd0h: 2150.1MB in 4403456 sectors of 512 bytes
11 cylinder groups of 202.47MB, 12958 blocks, 25984 inodes each
/dev/rsd0j: 1340.8MB in 2746048 sectors of 512 bytes
7 cylinder groups of 202.47MB, 12958 blocks, 25984 inodes each
/dev/rsd0i: 1044.4MB in 2138976 sectors of 512 bytes
6 cylinder groups of 202.47MB, 12958 blocks, 25984 inodes each
newfs: reduced number of fragments per cylinder group from 27232 to 27120
to enlarge last cylinder group
/dev/rsd0e: 212.8MB in 435744 sectors of 512 bytes
5 cylinder groups of 52.97MB, 3390 blocks, 6784 inodes each
Available disks are: sd1.
Which disk do you wish to initialize? (or &amp;#39;done&amp;#39;) [done]&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td&gt;&lt;p&gt;&lt;em&gt;return&lt;/em&gt;&lt;/p&gt;&lt;/td&gt;
&lt;td&gt;&lt;p&gt;Don't need another disk.&lt;/p&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr class=&quot;odd&quot;&gt;
&lt;td&gt;&lt;pre&gt;&lt;code&gt;Let&amp;#39;s install the sets!
Location of sets? (disk http or &amp;#39;done&amp;#39;) [http]&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td&gt;&lt;p&gt;&lt;code&gt;disk&lt;/code&gt;&lt;/p&gt;&lt;/td&gt;
&lt;td&gt;&lt;p&gt;Ok the sets are on the disk with &amp;quot;install61.fs&amp;quot; on.&lt;/p&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr class=&quot;even&quot;&gt;
&lt;td&gt;&lt;pre&gt;&lt;code&gt;Is the disk partition already mounted? [no]&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td&gt;&lt;p&gt;&lt;em&gt;return&lt;/em&gt;&lt;/p&gt;&lt;/td&gt;
&lt;td&gt;&lt;p&gt;No the other disk is not mounted yet.&lt;/p&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr class=&quot;odd&quot;&gt;
&lt;td&gt;&lt;pre&gt;&lt;code&gt;Available disks are: sd0 sd1.
Which disk contains the install media? (or &amp;#39;done&amp;#39;) [sd1]&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td&gt;&lt;p&gt;&lt;em&gt;return&lt;/em&gt;&lt;/p&gt;&lt;/td&gt;
&lt;td&gt;&lt;p&gt;Ok sd0 was the 8G so sd1 should be the one I want.&lt;/p&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr class=&quot;even&quot;&gt;
&lt;td&gt;&lt;pre&gt;&lt;code&gt;Which disk contains the install media? (or &amp;#39;done&amp;#39;) [sd1]
  a:           572416             1024  4.2BSD   2048 16384 16142
  i:              960               64   MSDOS
Available sd1 partitions are: a i.
Which sd1 partition has the install sets? (or &amp;#39;done&amp;#39;) [a]&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td&gt;&lt;p&gt;&lt;em&gt;return&lt;/em&gt;&lt;/p&gt;&lt;/td&gt;
&lt;td&gt;&lt;p&gt;mmh, yes seems as if partition &lt;code&gt;a&lt;/code&gt; contains the sets.&lt;/p&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr class=&quot;odd&quot;&gt;
&lt;td&gt;&lt;pre&gt;&lt;code&gt;Pathname to the sets? (or &amp;#39;done&amp;#39;) [6.1/amd64]&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td&gt;&lt;p&gt;&lt;em&gt;return&lt;/em&gt;&lt;/p&gt;&lt;/td&gt;
&lt;td&gt;&lt;p&gt;That pathname sounds good to me&lt;/p&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr class=&quot;even&quot;&gt;
&lt;td&gt;&lt;pre&gt;&lt;code&gt;Select sets by entering a set name, a file name pattern or &amp;#39;all&amp;#39;. De-select
sets by prepending a &amp;#39;-&amp;#39; to the set name, file name pattern or &amp;#39;all&amp;#39;. Selected
sets are labelled &amp;#39;[X]&amp;#39;.
    [X] bsd           [X] base61.tgz    [X] game61.tgz    [X] xfont61.tgz
    [X] bsd.rd        [X] comp61.tgz    [X] xbase61.tgz   [X] xserv61.tgz
    [ ] bsd.mp        [X] man61.tgz     [X] xshare61.tgz
Set name(s)? (or &amp;#39;abort&amp;#39; or &amp;#39;done&amp;#39;) [done]&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td&gt;&lt;p&gt;&lt;code&gt;all&lt;/code&gt;&lt;/p&gt;&lt;/td&gt;
&lt;td&gt;&lt;p&gt;I want them all!!&lt;/p&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr class=&quot;odd&quot;&gt;
&lt;td&gt;&lt;pre&gt;&lt;code&gt;    [X] bsd           [X] base61.tgz    [X] game61.tgz    [X] xfont61.tgz
    [X] bsd.rd        [X] comp61.tgz    [X] xbase61.tgz   [X] xserv61.tgz
    [X] bsd.mp        [X] man61.tgz     [X] xshare61.tgz
Set name(s)? (or &amp;#39;abort&amp;#39; or &amp;#39;done&amp;#39;) [done]&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td&gt;&lt;p&gt;&lt;em&gt;return&lt;/em&gt;&lt;/p&gt;&lt;/td&gt;
&lt;td&gt;&lt;p&gt;Ok, now you can go on.&lt;/p&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr class=&quot;even&quot;&gt;
&lt;td&gt;&lt;pre&gt;&lt;code&gt;Directory does not contain SHA256.sig. Continue without verification? [no]&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td&gt;&lt;p&gt;&lt;code&gt;yes&lt;/code&gt;&lt;/p&gt;&lt;/td&gt;
&lt;td&gt;&lt;p&gt;There is no way around that..&lt;/p&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr class=&quot;odd&quot;&gt;
&lt;td&gt;&lt;pre&gt;&lt;code&gt;Installing bsd          100% |**************************| 10433 KB    00:00
Installing bsd.rd       100% |**************************|  9210 KB    00:00
Installing bsd.mp       100% |**************************| 10499 KB    00:00
Installing base61.tgz   100% |**************************| 52322 KB    00:04
Extracting etc.tgz      100% |**************************|   189 KB    00:00
Installing comp61.tgz   100% |**************************| 46070 KB    00:04
Installing man61.tgz    100% |**************************|  8719 KB    00:00
Installing game61.tgz   100% |**************************|  2707 KB    00:00
Installing xbase61.tgz  100% |**************************| 17497 KB    00:01
Extracting xetc.tgz     100% |**************************|  7006       00:00
Installing xshare61.tgz 100% |**************************|  4406 KB    00:00
Installing xfont61.tgz  100% |**************************| 39342 KB    00:02
Installing xserv61.tgz  100% |**************************| 13001 KB    00:00
Location of sets? (disk http or &amp;#39;done&amp;#39;) [done]&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td&gt;&lt;p&gt;&lt;em&gt;return&lt;/em&gt;&lt;/p&gt;&lt;/td&gt;
&lt;td&gt;&lt;p&gt;That's it with the sets.&lt;/p&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr class=&quot;even&quot;&gt;
&lt;td&gt;&lt;pre&gt;&lt;code&gt;What timezone are you in? (&amp;#39;?&amp;#39; for list) [Canada/Mountain]
Africa/      Chile/       GB-Eire      Israel       Navajo       US/
America/     Cuba         GMT          Jamaica      PRC          UTC
Antarctica/  EET          GMT+0        Japan        PST8PDT      Universal
Arctic/      EST          GMT-0        Kwajalein    Pacific/     W-SU
Asia/        EST5EDT      GMT0         Libya        Poland       WET
Atlantic/    Egypt        Greenwich    MET          Portugal     Zulu
Australia/   Eire         HST          MST          ROC          posix/
Brazil/      Etc/         Hongkong     MST7MDT      ROK          posixrules
CET          Europe/      Iceland      Mexico/      Singapore    right/
CST6CDT      Factory      Indian/      NZ           Turkey
Canada/      GB           Iran         NZ-CHAT      UCT&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td&gt;&lt;p&gt;&lt;code&gt;?&lt;/code&gt;&lt;/p&gt;&lt;/td&gt;
&lt;td&gt;&lt;p&gt;Aha... ok I guess there is a Berlin in Europe...&lt;/p&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr class=&quot;odd&quot;&gt;
&lt;td&gt;&lt;pre&gt;&lt;code&gt;What timezone are you in? (&amp;#39;?&amp;#39; for list) [Canada/Mountain]&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td&gt;&lt;p&gt;&lt;code&gt;Europe/Berlin&lt;/code&gt;&lt;/p&gt;&lt;/td&gt;
&lt;td&gt;&lt;p&gt;...so I take that.&lt;/p&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr class=&quot;even&quot;&gt;
&lt;td&gt;&lt;pre&gt;&lt;code&gt;Saving configuration files...done.
Making all device nodes...done.&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr class=&quot;odd&quot;&gt;
&lt;td&gt;&lt;pre&gt;&lt;code&gt;CONGRATULATIONS! Your OpenBSD install has been successfully completed!
To boot the new system, enter &amp;#39;reboot&amp;#39; at the command prompt.
When you login to your new system the first time, please read your mail
using the &amp;#39;mail&amp;#39; command.&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;Made it!&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;/figure&gt;
&lt;p&gt;Ok now he is telling me to reboot the machine... But I can easily just choose to exit the vm via this key-sequence:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot;&gt;&lt;pre class=&quot;sourceCode bash&quot;&gt;&lt;code class=&quot;sourceCode bash&quot;&gt;&lt;span class=&quot;ex&quot;&gt;~&lt;/span&gt;^&lt;span class=&quot;ex&quot;&gt;D&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;So first enter the &lt;strong&gt;tilde&lt;/strong&gt; symbol and afterwards &lt;strong&gt;Ctrl-D&lt;/strong&gt;.&lt;/p&gt;
&lt;p&gt;&lt;em&gt;The tilde is not supposed to apear in the terminal input.&lt;/em&gt;&lt;/p&gt;
&lt;p&gt;Thereafter I stopped the created virtual machine:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot;&gt;&lt;pre class=&quot;sourceCode bash&quot;&gt;&lt;code class=&quot;sourceCode bash&quot;&gt;&lt;span class=&quot;ex&quot;&gt;doas&lt;/span&gt; vmctl stop &lt;span class=&quot;st&quot;&gt;&amp;quot;host-vm&amp;quot;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;And made a copy of the installation:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot;&gt;&lt;pre class=&quot;sourceCode bash&quot;&gt;&lt;code class=&quot;sourceCode bash&quot;&gt;&lt;span class=&quot;ex&quot;&gt;doas&lt;/span&gt; cp host.drive host.drive.bak&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;I also checked if everything installed fine:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;doas vmctl start &amp;quot;host-vm&amp;quot; -c -i 1 -d host.drive&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;It should boot into the installed system now asking you for login and password in the end.&lt;/p&gt;
&lt;p&gt;I configured &lt;code&gt;doas&lt;/code&gt; and added the &lt;code&gt;/etc/installurl&lt;/code&gt; file as shown in my last &lt;a href=&quot;/openbsd/server/2017/06/06/a-first-server.html#openbsd-server---install-and-set-up&quot;&gt;post&lt;/a&gt;.&lt;/p&gt;
&lt;h3 id=&quot;duplicate-the-host-vm-for-other-vms-i-want&quot;&gt;Duplicate the Host VM for other VMs I want&lt;/h3&gt;
&lt;p&gt;Now I could easily duplicate the created disk file for other needed VMs:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot;&gt;&lt;pre class=&quot;sourceCode bash&quot;&gt;&lt;code class=&quot;sourceCode bash&quot;&gt;&lt;span class=&quot;ex&quot;&gt;doas&lt;/span&gt; cp host.drive foo.drive
&lt;span class=&quot;ex&quot;&gt;doas&lt;/span&gt; cp host.drive bar.drive&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Afterwards I started each VM and did some adjustments (I will only show what I did for the &amp;quot;foo&amp;quot; vm as the &amp;quot;bar&amp;quot; vm will be configured analogously:&lt;/p&gt;
&lt;p&gt;Starting the VM as usual:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot;&gt;&lt;pre class=&quot;sourceCode bash&quot;&gt;&lt;code class=&quot;sourceCode bash&quot;&gt;&lt;span class=&quot;ex&quot;&gt;doas&lt;/span&gt; vmctl start &lt;span class=&quot;st&quot;&gt;&amp;quot;foo-vm&amp;quot;&lt;/span&gt; -c -i 1 -d foo.drive&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Add the foo user:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot;&gt;&lt;pre class=&quot;sourceCode bash&quot;&gt;&lt;code class=&quot;sourceCode bash&quot;&gt;&lt;span class=&quot;ex&quot;&gt;doas&lt;/span&gt; adduser&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;I copied my terminal output:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;Couldn&amp;#39;t find /etc/adduser.conf: creating a new adduser configuration file
Reading /etc/shells
Enter your default shell: csh ksh nologin sh [ksh]: 
Your default shell is: ksh -&amp;gt; /bin/ksh
Default login class: authpf bgpd daemon default pbuild staff unbound 
[default]: 
Enter your default HOME partition: [/home]: 
Copy dotfiles from: /etc/skel no [/etc/skel]: 
Send welcome message?: /path/file default no [no]: 
Do not send message(s)
Prompt for passwords by default (y/n) [y]: 
Default encryption method for passwords: auto blowfish [auto]: 
Use option ``-silent&amp;#39;&amp;#39; if you don&amp;#39;t want to see all warnings and questions.

Reading /etc/shells
Check /etc/master.passwd
Check /etc/group

Ok, let&amp;#39;s go.
Don&amp;#39;t worry about mistakes. There will be a chance later to correct any input.
Enter username []: foo
Enter full name []: 
Enter shell csh ksh nologin sh [ksh]: 
Uid [1001]: 
Login group foo [foo]: 
Login group is ``foo&amp;#39;&amp;#39;. Invite foo into other groups: guest no 
[no]: wheel
Login class authpf bgpd daemon default pbuild staff unbound 
[default]: 
Enter password []: 
Enter password again []: 

Name:        foo
Password:    ******
Fullname:    foo
Uid:         1001
Gid:         1001 (foo)
Groups:      foo wheel
Login Class: default
HOME:        /home/foo
Shell:       /bin/ksh
OK? (y/n) [y]: 
Added user ``foo&amp;#39;&amp;#39;
Copy files from /etc/skel to /home/foo
Add another user? (y/n) [y]: n
Goodbye!&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Deleted the host user:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot;&gt;&lt;pre class=&quot;sourceCode bash&quot;&gt;&lt;code class=&quot;sourceCode bash&quot;&gt;&lt;span class=&quot;ex&quot;&gt;doas&lt;/span&gt; userdel host
&lt;span class=&quot;ex&quot;&gt;doas&lt;/span&gt; rm -rf /home/host&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Configured the new hostname:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot;&gt;&lt;pre class=&quot;sourceCode bash&quot;&gt;&lt;code class=&quot;sourceCode bash&quot;&gt;&lt;span class=&quot;co&quot;&gt;## /etc/hosts&lt;/span&gt;
&lt;span class=&quot;ex&quot;&gt;127.0.0.1&lt;/span&gt;       localhost
::&lt;span class=&quot;ex&quot;&gt;1&lt;/span&gt;             localhost
&lt;span class=&quot;ex&quot;&gt;192.168.30.10&lt;/span&gt;   foo.hermes-technology.de foo&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;div class=&quot;sourceCode&quot;&gt;&lt;pre class=&quot;sourceCode bash&quot;&gt;&lt;code class=&quot;sourceCode bash&quot;&gt;&lt;span class=&quot;co&quot;&gt;## /etc/myname&lt;/span&gt;
&lt;span class=&quot;ex&quot;&gt;foo.hermes-technology.de&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Alter the &lt;code&gt;/etc/hostname.vio0&lt;/code&gt; for the correct ip (it will be 192.168.30.4 for the bar-vm):&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot;&gt;&lt;pre class=&quot;sourceCode bash&quot;&gt;&lt;code class=&quot;sourceCode bash&quot;&gt;&lt;span class=&quot;co&quot;&gt;## /etc/hostname.vio0&lt;/span&gt;
&lt;span class=&quot;ex&quot;&gt;inet&lt;/span&gt; 192.168.30.3 255.255.255.0&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Then I enabled httpd to show a &amp;quot;Hello from foo&amp;quot; html page.&lt;/p&gt;
&lt;p&gt;Refer to my last post to see how to &lt;a href=&quot;/openbsd/server/2017/06/06/a-first-server.html#start-httpd-and-show-your-website&quot;&gt;setup httpd for this task&lt;/a&gt;:&lt;/p&gt;
&lt;p&gt;I exited the VM.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;I did the above for each VM that I added to the virtual network.&lt;/strong&gt;&lt;/p&gt;
&lt;h2 id=&quot;back-on-the-main-server&quot;&gt;Back on the main server&lt;/h2&gt;
&lt;p&gt;Ok now that I had the &lt;code&gt;host-vm&lt;/code&gt;, &lt;code&gt;foo-vm&lt;/code&gt; and &lt;code&gt;bar-vm&lt;/code&gt; successfully set up I had to do some configuration on the main server.&lt;/p&gt;
&lt;p&gt;At first I created a virtual NIC that acts as a Router and DNS server to the virtual-machine-network.&lt;/p&gt;
&lt;p&gt;Then I configured the internal firewall &lt;code&gt;pf&lt;/code&gt; and the DNS service via &lt;code&gt;unbound&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;At the end I configured the virtual machines for &lt;code&gt;vmd&lt;/code&gt; in &lt;code&gt;/etc/vm.conf&lt;/code&gt;.&lt;/p&gt;
&lt;h3 id=&quot;the-virtual-network-interface-card-nic&quot;&gt;The virtual network interface card (NIC)&lt;/h3&gt;
&lt;p&gt;Creating a virtual network device was very easy in OpenBSD.&lt;/p&gt;
&lt;p&gt;I just had to create a file called &lt;code&gt;/etc/hostname.vether0&lt;/code&gt; and insert the desired configuration:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot;&gt;&lt;pre class=&quot;sourceCode bash&quot;&gt;&lt;code class=&quot;sourceCode bash&quot;&gt;&lt;span class=&quot;ex&quot;&gt;doas&lt;/span&gt; -s
&lt;span class=&quot;fu&quot;&gt;touch&lt;/span&gt; /etc/hostname.vether0
&lt;span class=&quot;bu&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;st&quot;&gt;&amp;quot;inet 192.168.30.1 255.255.255.0 NONE&amp;quot;&lt;/span&gt; &lt;span class=&quot;op&quot;&gt;&amp;gt;&lt;/span&gt; /etc/hostname.vether0&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Now on next reboot or after restarting the networking service I had the vether0 device at 192.168.30.1.&lt;/p&gt;
&lt;h3 id=&quot;pf---the-openbsd-firewall&quot;&gt;PF - the OpenBSD firewall&lt;/h3&gt;
&lt;p&gt;There is a configuration file for the firewall at &lt;code&gt;/etc/pf.conf&lt;/code&gt;, I configured it like this:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot;&gt;&lt;pre class=&quot;sourceCode bash&quot;&gt;&lt;code class=&quot;sourceCode bash&quot;&gt;&lt;span class=&quot;co&quot;&gt;#       $OpenBSD: pf.conf,v 1.54 2014/08/23 05:49:42 deraadt Exp $&lt;/span&gt;
&lt;span class=&quot;co&quot;&gt;#&lt;/span&gt;
&lt;span class=&quot;co&quot;&gt;# See pf.conf(5) and /etc/examples/pf.conf&lt;/span&gt;

&lt;span class=&quot;va&quot;&gt;int_if=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&amp;quot;{ vether0 em0 }&amp;quot;&lt;/span&gt;

&lt;span class=&quot;co&quot;&gt;##set skip on lo&lt;/span&gt;

&lt;span class=&quot;co&quot;&gt;##block return  # block stateless traffic&lt;/span&gt;
&lt;span class=&quot;co&quot;&gt;##pass          # establish keep-state&lt;/span&gt;

&lt;span class=&quot;co&quot;&gt;# By default, do not permit remote connections to X11&lt;/span&gt;
&lt;span class=&quot;co&quot;&gt;##block return in on ! lo0 proto tcp to port 6000:6010&lt;/span&gt;

&lt;span class=&quot;kw&quot;&gt;set&lt;/span&gt; &lt;span class=&quot;ex&quot;&gt;block-policy&lt;/span&gt; drop
&lt;span class=&quot;kw&quot;&gt;set&lt;/span&gt; &lt;span class=&quot;ex&quot;&gt;loginterface&lt;/span&gt; egress
&lt;span class=&quot;kw&quot;&gt;set&lt;/span&gt; &lt;span class=&quot;ex&quot;&gt;skip&lt;/span&gt; on lo0

&lt;span class=&quot;co&quot;&gt;## act as a nat&lt;/span&gt;
&lt;span class=&quot;ex&quot;&gt;match&lt;/span&gt; in all scrub (no-df random-id max-mss 1440)
&lt;span class=&quot;ex&quot;&gt;match&lt;/span&gt; out on egress inet from !(egress:network) &lt;span class=&quot;ex&quot;&gt;to&lt;/span&gt; any nat-to (egress:0)

&lt;span class=&quot;co&quot;&gt;## allow all outgoing&lt;/span&gt;
&lt;span class=&quot;ex&quot;&gt;pass&lt;/span&gt; out quick inet
&lt;span class=&quot;ex&quot;&gt;pass&lt;/span&gt; in on &lt;span class=&quot;va&quot;&gt;$int_if&lt;/span&gt; inet

&lt;span class=&quot;co&quot;&gt;## redirect http and https to the host of the vms&lt;/span&gt;
&lt;span class=&quot;ex&quot;&gt;pass&lt;/span&gt; in on egress inet proto tcp from any to (egress) &lt;span class=&quot;ex&quot;&gt;port&lt;/span&gt; { 80 443 } &lt;span class=&quot;ex&quot;&gt;rdr-to&lt;/span&gt; 192.168.30.2&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Now incoming http traffic will be redirected to the host-vm as soon as it is up and running.&lt;/p&gt;
&lt;p&gt;To apply the configuration changes I executed &lt;code&gt;doas pfctl -f /etc/pf.conf&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;And verified those changes via &lt;code&gt;doas pfctl -sr&lt;/code&gt;.&lt;/p&gt;
&lt;h3 id=&quot;unbound---my-dns-name-server&quot;&gt;unbound - my DNS name server&lt;/h3&gt;
&lt;p&gt;I enabled &lt;code&gt;unbound&lt;/code&gt;:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot;&gt;&lt;pre class=&quot;sourceCode bash&quot;&gt;&lt;code class=&quot;sourceCode bash&quot;&gt;&lt;span class=&quot;ex&quot;&gt;doas&lt;/span&gt; rcctl enable unbound&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;And configured it the way I needed it:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot;&gt;&lt;pre class=&quot;sourceCode bash&quot;&gt;&lt;code class=&quot;sourceCode bash&quot;&gt;&lt;span class=&quot;co&quot;&gt;## /var/unbound/etc/unbound.conf                                                                                                                                                                       &lt;/span&gt;
&lt;span class=&quot;co&quot;&gt;# $OpenBSD: unbound.conf,v 1.7 2016/03/30 01:41:25 sthen Exp $&lt;/span&gt;

&lt;span class=&quot;co&quot;&gt;## I definately want the vether0 device act as a DNS name server for the virtual network&lt;/span&gt;
&lt;span class=&quot;ex&quot;&gt;server&lt;/span&gt;:
        &lt;span class=&quot;ex&quot;&gt;interface&lt;/span&gt;: 192.168.30.1
        &lt;span class=&quot;ex&quot;&gt;interface&lt;/span&gt;: 127.0.0.1
        &lt;span class=&quot;ex&quot;&gt;interface&lt;/span&gt;: ::1
        &lt;span class=&quot;co&quot;&gt;#do-ip6: no&lt;/span&gt;

        &lt;span class=&quot;co&quot;&gt;# override the default &amp;quot;any&amp;quot; address to send queries; if multiple&lt;/span&gt;
        &lt;span class=&quot;co&quot;&gt;# addresses are available, they are used randomly to counter spoofing&lt;/span&gt;
        &lt;span class=&quot;co&quot;&gt;#outgoing-interface: 192.0.2.1&lt;/span&gt;
        &lt;span class=&quot;co&quot;&gt;#outgoing-interface: 2001:db8::53&lt;/span&gt;

        &lt;span class=&quot;ex&quot;&gt;access-control&lt;/span&gt;: 0.0.0.0/0 refuse
        &lt;span class=&quot;ex&quot;&gt;access-control&lt;/span&gt;: 127.0.0.0/8 allow
        &lt;span class=&quot;ex&quot;&gt;access-control&lt;/span&gt;: ::0/0 refuse
        &lt;span class=&quot;ex&quot;&gt;access-control&lt;/span&gt;: ::1 allow
        &lt;span class=&quot;ex&quot;&gt;access-control&lt;/span&gt;: 192.168.1.0/24 allow

        &lt;span class=&quot;ex&quot;&gt;access-control&lt;/span&gt;: 192.168.30.0/24 allow &lt;span class=&quot;co&quot;&gt;## I want the virtual network to be allowed for access&lt;/span&gt;
        
        &lt;span class=&quot;ex&quot;&gt;do-not-query-localhost&lt;/span&gt;: no

        &lt;span class=&quot;ex&quot;&gt;hide-identity&lt;/span&gt;: yes
        &lt;span class=&quot;ex&quot;&gt;hide-version&lt;/span&gt;: yes

        &lt;span class=&quot;co&quot;&gt;# Uncomment to enable qname minimisation.&lt;/span&gt;
        &lt;span class=&quot;co&quot;&gt;# https://tools.ietf.org/html/draft-ietf-dnsop-qname-minimisation-08&lt;/span&gt;
        &lt;span class=&quot;co&quot;&gt;#&lt;/span&gt;
        &lt;span class=&quot;co&quot;&gt;# qname-minimisation: yes&lt;/span&gt;

        &lt;span class=&quot;co&quot;&gt;# Uncomment to enable DNSSEC validation.&lt;/span&gt;
        &lt;span class=&quot;co&quot;&gt;#&lt;/span&gt;
        &lt;span class=&quot;co&quot;&gt;#auto-trust-anchor-file: &amp;quot;/var/unbound/db/root.key&amp;quot;&lt;/span&gt;

        &lt;span class=&quot;co&quot;&gt;# Serve zones authoritatively from Unbound to resolver clients.&lt;/span&gt;
        &lt;span class=&quot;co&quot;&gt;# Not for external service.&lt;/span&gt;
        &lt;span class=&quot;co&quot;&gt;#&lt;/span&gt;
        &lt;span class=&quot;co&quot;&gt;#local-zone: &amp;quot;local.&amp;quot; static&lt;/span&gt;
        &lt;span class=&quot;co&quot;&gt;#local-data: &amp;quot;mycomputer.local. IN A 192.0.2.51&amp;quot;&lt;/span&gt;
        &lt;span class=&quot;co&quot;&gt;#local-zone: &amp;quot;2.0.192.in-addr.arpa.&amp;quot; static&lt;/span&gt;
        &lt;span class=&quot;co&quot;&gt;#local-data-ptr: &amp;quot;192.0.2.51 mycomputer.local&amp;quot;&lt;/span&gt;

        &lt;span class=&quot;co&quot;&gt;# UDP EDNS reassembly buffer advertised to peers. Default 4096.&lt;/span&gt;
        &lt;span class=&quot;co&quot;&gt;# May need lowering on broken networks with fragmentation/MTU issues,&lt;/span&gt;
        &lt;span class=&quot;co&quot;&gt;# particularly if validating DNSSEC.&lt;/span&gt;
        &lt;span class=&quot;co&quot;&gt;#&lt;/span&gt;
        &lt;span class=&quot;co&quot;&gt;#edns-buffer-size: 1480&lt;/span&gt;

        &lt;span class=&quot;co&quot;&gt;# Use TCP for &amp;quot;forward-zone&amp;quot; requests. Useful if you are making&lt;/span&gt;
        &lt;span class=&quot;co&quot;&gt;# DNS requests over an SSH port forwarding.&lt;/span&gt;
        &lt;span class=&quot;co&quot;&gt;#&lt;/span&gt;
        &lt;span class=&quot;co&quot;&gt;#tcp-upstream: yes&lt;/span&gt;

        &lt;span class=&quot;co&quot;&gt;# DNS64 options, synthesizes AAAA records for hosts that don&amp;#39;t have&lt;/span&gt;
        &lt;span class=&quot;co&quot;&gt;# them. For use with NAT64 (PF &amp;quot;af-to&amp;quot;).&lt;/span&gt;
        &lt;span class=&quot;co&quot;&gt;#&lt;/span&gt;
        &lt;span class=&quot;co&quot;&gt;#module-config: &amp;quot;dns64 validator iterator&amp;quot;&lt;/span&gt;
        &lt;span class=&quot;co&quot;&gt;#dns64-prefix: 64:ff9b::/96     # well-known prefix (default)&lt;/span&gt;
        &lt;span class=&quot;co&quot;&gt;#dns64-synthall: no&lt;/span&gt;

&lt;span class=&quot;ex&quot;&gt;remote-control&lt;/span&gt;:
        &lt;span class=&quot;ex&quot;&gt;control-enable&lt;/span&gt;: yes
        &lt;span class=&quot;ex&quot;&gt;control-use-cert&lt;/span&gt;: no
        &lt;span class=&quot;ex&quot;&gt;control-interface&lt;/span&gt;: /var/run/unbound.sock

&lt;span class=&quot;ex&quot;&gt;forward-zone&lt;/span&gt;:
        &lt;span class=&quot;ex&quot;&gt;name&lt;/span&gt;: &lt;span class=&quot;st&quot;&gt;&amp;quot;.&amp;quot;&lt;/span&gt;
        &lt;span class=&quot;ex&quot;&gt;forward-addr&lt;/span&gt;: 192.168.1.1 &lt;span class=&quot;co&quot;&gt;## Forward the DNS Requests to my local real router&lt;/span&gt;
        &lt;span class=&quot;ex&quot;&gt;forward-addr&lt;/span&gt;: 74.82.42.42 &lt;span class=&quot;co&quot;&gt;# he.net&lt;/span&gt;
        &lt;span class=&quot;ex&quot;&gt;forward-addr&lt;/span&gt;: 2001:470:20::2 &lt;span class=&quot;co&quot;&gt;# he.net v6&lt;/span&gt;
        &lt;span class=&quot;ex&quot;&gt;forward-addr&lt;/span&gt;: 8.8.8.8 &lt;span class=&quot;co&quot;&gt;# google.com&lt;/span&gt;
        &lt;span class=&quot;ex&quot;&gt;forward-addr&lt;/span&gt;: 2001:4860:4860::8888 &lt;span class=&quot;co&quot;&gt;# google.com v6&lt;/span&gt;
        &lt;span class=&quot;ex&quot;&gt;forward-addr&lt;/span&gt;: 208.67.222.222 &lt;span class=&quot;co&quot;&gt;# opendns.com&lt;/span&gt;
        &lt;span class=&quot;ex&quot;&gt;forward-first&lt;/span&gt;: yes &lt;span class=&quot;co&quot;&gt;# try direct if forwarder fails&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Now DNS requests from the 192.168.30.0/24 subnet will be answered by the DNS server at 192.168.30.1.&lt;/p&gt;
&lt;h3 id=&quot;vmd---what-goes-into-etcvm.conf&quot;&gt;vmd - What goes into /etc/vm.conf&lt;/h3&gt;
&lt;p&gt;Now my next task was to create the correct vm configuration, so that each vm would be connected to a local virtual switch managing the virtual network.&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; startFrom=&quot;1&quot;&gt;&lt;table class=&quot;sourceCode bash numberLines&quot;&gt;&lt;tr class=&quot;sourceCode&quot;&gt;&lt;td class=&quot;lineNumbers&quot;&gt;&lt;pre&gt;1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;sourceCode&quot;&gt;&lt;pre&gt;&lt;code class=&quot;sourceCode bash&quot;&gt;&lt;span class=&quot;co&quot;&gt;## /etc/vm.conf&lt;/span&gt;
&lt;span class=&quot;va&quot;&gt;files=&lt;/span&gt;  &lt;span class=&quot;ex&quot;&gt;/home/user/vm-network/&lt;/span&gt; &lt;span class=&quot;co&quot;&gt;# our disk files are at the previously created location (change &amp;quot;user&amp;quot; to your username)&lt;/span&gt;

&lt;span class=&quot;ex&quot;&gt;vm&lt;/span&gt; host-vm { &lt;span class=&quot;co&quot;&gt;# we want a vm called &amp;quot;host-vm&amp;quot;&lt;/span&gt;
        &lt;span class=&quot;ex&quot;&gt;memory&lt;/span&gt; 2g &lt;span class=&quot;co&quot;&gt;#with 2gigs of memory&lt;/span&gt;
        &lt;span class=&quot;ex&quot;&gt;disk&lt;/span&gt; &lt;span class=&quot;va&quot;&gt;$files&lt;/span&gt; host.drive &lt;span class=&quot;co&quot;&gt;# running the host.drive&lt;/span&gt;
        &lt;span class=&quot;ex&quot;&gt;interface&lt;/span&gt; tap { lladdr 00:00:00:00:00:02 switch localnet } &lt;span class=&quot;co&quot;&gt;# on a network interface with the specified MAC on the localnet switch&lt;/span&gt;
}

&lt;span class=&quot;ex&quot;&gt;vm&lt;/span&gt; foo-vm {
        &lt;span class=&quot;ex&quot;&gt;memory&lt;/span&gt; 2g
        &lt;span class=&quot;ex&quot;&gt;disk&lt;/span&gt; &lt;span class=&quot;va&quot;&gt;$files&lt;/span&gt; foo.drive
        &lt;span class=&quot;ex&quot;&gt;interface&lt;/span&gt; tap { lladdr 00:00:00:00:00:03 switch localnet }
}

&lt;span class=&quot;ex&quot;&gt;vm&lt;/span&gt; bar-vm {
        &lt;span class=&quot;ex&quot;&gt;memory&lt;/span&gt; 2g
        &lt;span class=&quot;ex&quot;&gt;disk&lt;/span&gt; &lt;span class=&quot;va&quot;&gt;$files&lt;/span&gt; bar.drive
        &lt;span class=&quot;ex&quot;&gt;interface&lt;/span&gt; tap { lladdr 00:00:00:00:00:04 switch localnet }
}

&lt;span class=&quot;ex&quot;&gt;switch&lt;/span&gt; localnet { &lt;span class=&quot;co&quot;&gt;# this is the switch called &amp;quot;localnet&amp;quot;&lt;/span&gt;
        &lt;span class=&quot;ex&quot;&gt;add&lt;/span&gt; vether0 &lt;span class=&quot;co&quot;&gt;# where the virtual interface is added to&lt;/span&gt;
}&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;
&lt;p&gt;So on lines 4, 10 and 16 I configured the specific VMs and on line 22 I configured the virtual switch that the VMs network interfaces are attached to.&lt;/p&gt;
&lt;p&gt;Then I enabled &lt;code&gt;vmd&lt;/code&gt;:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot;&gt;&lt;pre class=&quot;sourceCode bash&quot;&gt;&lt;code class=&quot;sourceCode bash&quot;&gt;&lt;span class=&quot;ex&quot;&gt;doas&lt;/span&gt; rcctl enable vmd&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;And restarted the server:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot;&gt;&lt;pre class=&quot;sourceCode bash&quot;&gt;&lt;code class=&quot;sourceCode bash&quot;&gt;&lt;span class=&quot;ex&quot;&gt;doas&lt;/span&gt; reboot&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3 id=&quot;configuring-relayd-on-the-host-vm&quot;&gt;Configuring relayd on the host-vm&lt;/h3&gt;
&lt;p&gt;The last task was the configuration of &lt;code&gt;relayd&lt;/code&gt; on the host-vm.&lt;/p&gt;
&lt;p&gt;For this I logged into the host-vm, which should have been started automatically now at reboot:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot;&gt;&lt;pre class=&quot;sourceCode bash&quot;&gt;&lt;code class=&quot;sourceCode bash&quot;&gt;&lt;span class=&quot;ex&quot;&gt;doas&lt;/span&gt; vmctl console host-vm&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Then I configured relayd to redirect requests to my subdomains:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot;&gt;&lt;pre class=&quot;sourceCode ini&quot;&gt;&lt;code class=&quot;sourceCode ini&quot;&gt;&lt;span class=&quot;co&quot;&gt;# /etc/relayd.conf                                                                                       &lt;/span&gt;

&lt;span class=&quot;co&quot;&gt;## MACROS&lt;/span&gt;

&lt;span class=&quot;dt&quot;&gt;host_vm&lt;/span&gt;&lt;span class=&quot;ot&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;192&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;168&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;fl&quot;&gt;30.2&lt;/span&gt;
&lt;span class=&quot;dt&quot;&gt;foo_vm&lt;/span&gt;&lt;span class=&quot;ot&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;192&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;168&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;fl&quot;&gt;30.3&lt;/span&gt;
&lt;span class=&quot;dt&quot;&gt;bar_vm&lt;/span&gt;&lt;span class=&quot;ot&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;192&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;168&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;fl&quot;&gt;30.4&lt;/span&gt;

&lt;span class=&quot;co&quot;&gt;## TABLES&lt;/span&gt;

&lt;span class=&quot;dt&quot;&gt;table &amp;lt;foo_service&amp;gt; { $foo_vm }&lt;/span&gt;
&lt;span class=&quot;dt&quot;&gt;table &amp;lt;bar_service&amp;gt; { $bar_vm }&lt;/span&gt;

&lt;span class=&quot;co&quot;&gt;## PROTOCOLS&lt;/span&gt;

&lt;span class=&quot;co&quot;&gt;# define a new http protocol called &amp;quot;reverseproxy&amp;quot;&lt;/span&gt;
&lt;span class=&quot;dt&quot;&gt;http protocol &amp;quot;reverseproxy&amp;quot; {&lt;/span&gt;
&lt;span class=&quot;dt&quot;&gt;        &lt;/span&gt;
&lt;span class=&quot;dt&quot;&gt;        &lt;/span&gt;&lt;span class=&quot;co&quot;&gt;# match a request that has a Host value with &amp;quot;foo.hermes-technology.de&amp;quot;&lt;/span&gt;
&lt;span class=&quot;dt&quot;&gt;        &lt;/span&gt;&lt;span class=&quot;co&quot;&gt;# and forward that to the foo_service&lt;/span&gt;
&lt;span class=&quot;dt&quot;&gt;        &lt;/span&gt;&lt;span class=&quot;co&quot;&gt;# &amp;quot;quick&amp;quot; means that it will be handled as the last rule if it matches... no other will be processed&lt;/span&gt;
&lt;span class=&quot;dt&quot;&gt;        match request quick header &amp;quot;Host&amp;quot; value &amp;quot;foo.hermes-technology.de&amp;quot; \&lt;/span&gt;
&lt;span class=&quot;dt&quot;&gt;                forward to &amp;lt;foo_service&amp;gt;&lt;/span&gt;

&lt;span class=&quot;dt&quot;&gt;        match request quick header &amp;quot;Host&amp;quot; value &amp;quot;www.hermes-technology.de&amp;quot; \&lt;/span&gt;
&lt;span class=&quot;dt&quot;&gt;                forward to &amp;lt;foo_service&amp;gt;&lt;/span&gt;
&lt;span class=&quot;dt&quot;&gt;        &lt;/span&gt;
&lt;span class=&quot;dt&quot;&gt;        match request quick header &amp;quot;Host&amp;quot; value &amp;quot;bar.hermes-technology.de&amp;quot; \&lt;/span&gt;
&lt;span class=&quot;dt&quot;&gt;                forward to &amp;lt;bar_service&amp;gt;&lt;/span&gt;
&lt;span class=&quot;dt&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;co&quot;&gt;## RELAYS&lt;/span&gt;

&lt;span class=&quot;co&quot;&gt;# create a new relay called &amp;quot;proxy&amp;quot;&lt;/span&gt;
&lt;span class=&quot;co&quot;&gt;# relays are for layer 7 (e.g. http)&lt;/span&gt;
&lt;span class=&quot;dt&quot;&gt;relay &amp;quot;proxy&amp;quot; {&lt;/span&gt;
&lt;span class=&quot;dt&quot;&gt;        &lt;/span&gt;&lt;span class=&quot;co&quot;&gt;# the relay should listen on the host ip on port 80&lt;/span&gt;
&lt;span class=&quot;dt&quot;&gt;        listen on $host_vm port 80&lt;/span&gt;
&lt;span class=&quot;dt&quot;&gt;        &lt;/span&gt;
&lt;span class=&quot;dt&quot;&gt;        &lt;/span&gt;&lt;span class=&quot;co&quot;&gt;# use the protocol &amp;quot;reverseproxy&amp;quot; we defined above&lt;/span&gt;
&lt;span class=&quot;dt&quot;&gt;        protocol &amp;quot;reverseproxy&amp;quot;&lt;/span&gt;
&lt;span class=&quot;dt&quot;&gt;        &lt;/span&gt;
&lt;span class=&quot;dt&quot;&gt;        &lt;/span&gt;&lt;span class=&quot;co&quot;&gt;# forwarding is enabled for the specified services&lt;/span&gt;
&lt;span class=&quot;dt&quot;&gt;        forward to &amp;lt;foo_service&amp;gt; port 80&lt;/span&gt;
&lt;span class=&quot;dt&quot;&gt;        forward to &amp;lt;bar_service&amp;gt; port 80&lt;/span&gt;
&lt;span class=&quot;dt&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;The last task was to enable and start &lt;code&gt;relayd&lt;/code&gt;:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot;&gt;&lt;pre class=&quot;sourceCode bash&quot;&gt;&lt;code class=&quot;sourceCode bash&quot;&gt;&lt;span class=&quot;ex&quot;&gt;doas&lt;/span&gt; rcctl enable relayd
&lt;span class=&quot;ex&quot;&gt;doas&lt;/span&gt; rcctl start relayd&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h2 id=&quot;this-does-work-now&quot;&gt;This does work now&lt;/h2&gt;
&lt;p&gt;Because I bought the domain hermes-technology.de and registered blog.hermes-technology.de as CNAME entries, the following does work:&lt;/p&gt;
&lt;ol type=&quot;1&quot;&gt;
&lt;li&gt;Enter blog.hermes-technology.de anywhere into a webbrowser.&lt;/li&gt;
&lt;li&gt;The request lands at my main server's ip (hermes-technology.de).&lt;/li&gt;
&lt;li&gt;PF redirects any http requests to the host-vm on 192.168.30.2.&lt;/li&gt;
&lt;li&gt;&lt;code&gt;relayd&lt;/code&gt; on the host-vm redirects the &amp;quot;blog&amp;quot; subdomain request to the ip 192.168.30.3 of the blog-vm.&lt;/li&gt;
&lt;li&gt;The blog-vm and its httpd-service sends the response to its gateway 192.168.30.1&lt;/li&gt;
&lt;li&gt;The response on the vether0 gets a Network Address Translation (NAT) by &lt;code&gt;pf&lt;/code&gt; to the router.&lt;/li&gt;
&lt;li&gt;The router sends the response to the client.&lt;/li&gt;
&lt;/ol&gt;
&lt;h2 id=&quot;outlook&quot;&gt;Outlook&lt;/h2&gt;
&lt;p&gt;In the next post I will explain how I set up a proper ssh connection to my server with a public key. Which is much safer than using a password. Also I will explain how to configure ssh-tunneling so that you login to your virtual servers from the workstation where you're maintaining your server from. At last I will explain how I configured &lt;code&gt;pf&lt;/code&gt; to do an ssh protection like &lt;code&gt;fail2ban&lt;/code&gt; does.&lt;/p&gt;</content><author><name></name></author><summary type="html">I wanted to setup a network of virtual machines on my server. Each VM shall provide its specified service on a dedicated subdomain. I need to create the VMs, establish a virtual connection to my server, handle forwarding of packages with pf and redirecting subdomain requests.</summary></entry><entry><title type="html">A simple first server</title><link href="https://blog.hermes-technology.de/openbsd/server/2017/06/06/a-first-server.html" rel="alternate" type="text/html" title="A simple first server" /><published>2017-06-06T18:11:00+02:00</published><updated>2017-06-06T18:11:00+02:00</updated><id>https://blog.hermes-technology.de/openbsd/server/2017/06/06/a-first-server</id><content type="html" xml:base="https://blog.hermes-technology.de/openbsd/server/2017/06/06/a-first-server.html">&lt;p&gt;Hello, last time I showed a sketch of my server infrastructure without explaining anything really. That's where I'm going to start in this post. As a reminder I will include the picture again:&lt;/p&gt;
&lt;figure&gt;
&lt;figcaption&gt;
&lt;i&gt;Figure 1: Server Infrastructure&lt;/i&gt;
&lt;/figcaption&gt;
&lt;img src=&quot;https://blog.hermes-technology.de/assets/server-sketch.svg.png&quot; title=&quot;Figure 1: Server Infrastructure&quot; alt=&quot;Server Infrastructure&quot; /&gt;
&lt;/figure&gt;
&lt;p&gt;At first I would like to give a quick overview of what I wanted to achieve with this infrastructure: I wanted to encapsulate as much as possible in virtual machines, that will care about the specific tasks my server should provide in the end. Right now I have a dedicated VM for this blog I'm writing, a cloud, a gitlab server and the host VM which cares about redirecting the different subdomain requests.&lt;/p&gt;
&lt;p&gt;But for an easy explanation I will try to start much simpler - actually I will start the same way that I did a few weeks ago. I will just have my OpenBSD server that shows a simple &amp;quot;Hello world!&amp;quot; html page. Starting with this simple setup I will develope the above infrastructure in small steps during the next posts.&lt;/p&gt;
&lt;p&gt;For better understanding and visualization I will always backup the explanations with some figures. Throughout those figures I will try to use the format as shown in &lt;em&gt;Figure 2&lt;/em&gt; when necessary.&lt;/p&gt;
&lt;figure&gt;
&lt;figcaption&gt;
&lt;i&gt;Figure 2: Component Box&lt;/i&gt;
&lt;/figcaption&gt;
&lt;img src=&quot;https://blog.hermes-technology.de/assets/component-box.svg.png&quot; title=&quot;Figure 2: Component Box&quot; alt=&quot;Component Box&quot; /&gt;{:width=&amp;quot;340px&amp;quot; height=&amp;quot;150px&amp;quot;}
&lt;/figure&gt;
&lt;h2 id=&quot;the-task-for-today&quot;&gt;The task for today&lt;/h2&gt;
&lt;p&gt;As I already mentioned, today I will only create a simple http server on OpenBSD which is actually a very straight forward task. &lt;em&gt;Figure 3&lt;/em&gt; shows the different components that are needed to achieve the desired functionality:&lt;/p&gt;
&lt;p&gt;At first I need to install OpenBSD somewhere and connect its NIC (Network Interface Card) to my router. For this first step I could also have installed it in a VM with virtualbox for example.&lt;/p&gt;
&lt;p&gt;Thereafter I need to enable port-forwarding and assign a static ip to the server in the router's interface (I had to open the browser and go to 192.168.1.1 for the router's webinterface).&lt;/p&gt;
&lt;p&gt;To always be sure to get the same static ip address from my router I will also configure the interface to use a static ip instead of dhcp.&lt;/p&gt;
&lt;p&gt;After enabling and configuring the httpd server I will be able to reach the webserver from anywhere in the www, provided that I know my public ip. So the last step would be to make the public ip reachable through a domain name.&lt;/p&gt;
&lt;figure&gt;
&lt;figcaption&gt;
&lt;i&gt;Figure 3: First steps - Simple server&lt;/i&gt;
&lt;/figcaption&gt;
&lt;img src=&quot;https://blog.hermes-technology.de/assets/step1-sketch.svg.png&quot; title=&quot;Figure 3: First steps - Simple server&quot; alt=&quot;The first step&quot; /&gt;
&lt;/figure&gt;
&lt;h2 id=&quot;openbsd-server---install-and-set-up&quot;&gt;OpenBSD server - Install and set up&lt;/h2&gt;
&lt;p&gt;As you heard I want to build the whole server-setup using OpenBSD. This was my OS of choice, because it has a strong focus on security. So coming from the Linux world I had to learn a little bit about the workings of a BSD system, and just to anticipate it: I was positively surprised about the celarliness and easyness I had to deal with.&lt;/p&gt;
&lt;p&gt;Installing OpenBSD is easy and fast. I just had to follow the instructions at &lt;a href=&quot;https://www.openbsd.org/faq/faq4.html&quot;&gt;their homepage&lt;/a&gt; and everything was set up well. After installing make sure that your system is connected to your LAN.&lt;/p&gt;
&lt;div class=&quot;fromTheFuture&quot;&gt;
&lt;table&gt;
&lt;colgroup&gt;
&lt;col style=&quot;width: 100%&quot; /&gt;
&lt;/colgroup&gt;
&lt;thead&gt;
&lt;tr class=&quot;header&quot;&gt;
&lt;th&gt;&lt;strong&gt;Doc, about the future...&lt;/strong&gt;&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr class=&quot;odd&quot;&gt;
&lt;td&gt;I also have an &lt;a href=&quot;/openbsd/server/virtualmachine/network/2017/06/12/vmd-for-a-virtual-server-network.html#guided-installation-of-openbsd-for-the-host-vm&quot;&gt;installation guide&lt;/a&gt; now that you can read and see how I did react to each of the installation questions for the installation of a virtual machine on OpenBSD.&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;p&gt;After installing I also setup the &lt;code&gt;sudo&lt;/code&gt; equivalent of OpenBSD called &lt;code&gt;doas&lt;/code&gt;. For it to work just create a file called &lt;code&gt;/etc/doas.conf&lt;/code&gt; and insert these lines:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot;&gt;&lt;pre class=&quot;sourceCode bash&quot;&gt;&lt;code class=&quot;sourceCode bash&quot;&gt;&lt;span class=&quot;ex&quot;&gt;permit&lt;/span&gt; persist :wheel &lt;span class=&quot;co&quot;&gt;## permit all users from group wheel to gran root access via doas and let it pe persistent during the terminal session&lt;/span&gt;
&lt;span class=&quot;ex&quot;&gt;permit&lt;/span&gt; nopass keepenv root&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;If you have problems setting up a working package mirror for OpenBSD, I found the easiest and always working method of creating a specific file in the &lt;code&gt;/etc/&lt;/code&gt; directory, and filling it with my chosen mirror:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot;&gt;&lt;pre class=&quot;sourceCode bash&quot;&gt;&lt;code class=&quot;sourceCode bash&quot;&gt;&lt;span class=&quot;ex&quot;&gt;doas&lt;/span&gt; touch /etc/installurl
&lt;span class=&quot;ex&quot;&gt;doas&lt;/span&gt; echo &lt;span class=&quot;st&quot;&gt;&amp;quot;https://ftp.eu.openbsd.org/pub/OpenBSD/&amp;quot;&lt;/span&gt; &lt;span class=&quot;op&quot;&gt;&amp;gt;&lt;/span&gt; /etc/installurl&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Naturally you can choose any OpenBSD mirror you like. There is a list of possible mirrors located &lt;a href=&quot;https://www.openbsd.org/ftp.html&quot;&gt;here&lt;/a&gt;.&lt;/p&gt;
&lt;h3 id=&quot;some-nice-configurations&quot;&gt;Some nice configurations&lt;/h3&gt;
&lt;p&gt;I also added some nice configuration for better working with the system:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot;&gt;&lt;pre class=&quot;sourceCode bash&quot;&gt;&lt;code class=&quot;sourceCode bash&quot;&gt;&lt;span class=&quot;co&quot;&gt;## /etc/doas.conf&lt;/span&gt;
&lt;span class=&quot;ex&quot;&gt;permit&lt;/span&gt; persist setenv { -ENV PS1=&lt;span class=&quot;va&quot;&gt;$DOAS_PS1&lt;/span&gt; SSH_AUTH_SOCK } :&lt;span class=&quot;ex&quot;&gt;wheel&lt;/span&gt;
&lt;span class=&quot;ex&quot;&gt;permit&lt;/span&gt; nopass keepenv root&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Adding these lines to your user's and your root's &lt;code&gt;.profile&lt;/code&gt; file:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot;&gt;&lt;pre class=&quot;sourceCode bash&quot;&gt;&lt;code class=&quot;sourceCode bash&quot;&gt;&lt;span class=&quot;co&quot;&gt;## /root/.profile&lt;/span&gt;
&lt;span class=&quot;va&quot;&gt;PS1=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&amp;quot;[\t - \d]\n\u@\H:\w[\s]# &amp;quot;&lt;/span&gt;
&lt;span class=&quot;bu&quot;&gt;export&lt;/span&gt; &lt;span class=&quot;va&quot;&gt;PS1&lt;/span&gt;
&lt;span class=&quot;bu&quot;&gt;export&lt;/span&gt; &lt;span class=&quot;va&quot;&gt;HISTFILE=&lt;/span&gt;~/.sh_history&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;div class=&quot;sourceCode&quot;&gt;&lt;pre class=&quot;sourceCode bash&quot;&gt;&lt;code class=&quot;sourceCode bash&quot;&gt;&lt;span class=&quot;co&quot;&gt;## /home/user/.profile&lt;/span&gt;
&lt;span class=&quot;va&quot;&gt;PS1=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&amp;quot;[\t - \d]\n\u@\H:\w[\s]\n$ &amp;quot;&lt;/span&gt;
&lt;span class=&quot;bu&quot;&gt;export&lt;/span&gt; &lt;span class=&quot;va&quot;&gt;PS1&lt;/span&gt;
&lt;span class=&quot;va&quot;&gt;DOAS_PS1=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&amp;quot;[\t - \d]\n\u@\H:\w[\s]\n# &amp;quot;&lt;/span&gt;
&lt;span class=&quot;bu&quot;&gt;export&lt;/span&gt; &lt;span class=&quot;va&quot;&gt;DOAS_PS1&lt;/span&gt;
&lt;span class=&quot;bu&quot;&gt;export&lt;/span&gt; &lt;span class=&quot;va&quot;&gt;HISTFILE=&lt;/span&gt;~/.sh_history&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;export HISTFILE...&lt;/code&gt;: makes the history persistent so its not lost after each session.&lt;/li&gt;
&lt;li&gt;PS1: the terminal prompt&lt;/li&gt;
&lt;li&gt;DOAS_PS1: the terminal prompt when executing doas&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&quot;configuring-the-nic-static-ip&quot;&gt;Configuring the NIC (static ip)&lt;/h3&gt;
&lt;p&gt;For proper functionality its easier to configure the OpenBSD server to obtain a static ip instead of relying on the router's dhcp service. To achieve this, I had to change two files: &lt;code&gt;/etc/hostname.em0&lt;/code&gt; and &lt;code&gt;/etc/mygate&lt;/code&gt;. The name of your interface could be different which would also result in another filename &lt;code&gt;/etc/hostname.your-interface-name&lt;/code&gt;. In a OpenBSD VM the interfaces are called vio0 for example. Resulting in the filename to be &lt;code&gt;hostname.vio0&lt;/code&gt;.&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot;&gt;&lt;pre class=&quot;sourceCode bash&quot;&gt;&lt;code class=&quot;sourceCode bash&quot;&gt;&lt;span class=&quot;co&quot;&gt;## /etc/hostname.em0 ##&lt;/span&gt;
&lt;span class=&quot;ex&quot;&gt;inet&lt;/span&gt; static 192.168.1.250 255.255.255.0 &lt;span class=&quot;co&quot;&gt;# this will enable the static ip address 192.168.1.250 with a 255.255.255.0 netmask&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;After configuring the static ip I had to make sure that there is a file called &lt;code&gt;/etc/mygate&lt;/code&gt; which wasn't present because I installed my OpenBSD Box with dhcp enabled on my NIC. I created the file as root and wrote my routers ip as the single line in the file.&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot;&gt;&lt;pre class=&quot;sourceCode bash&quot;&gt;&lt;code class=&quot;sourceCode bash&quot;&gt;&lt;span class=&quot;co&quot;&gt;## /etc/mygate ## &lt;/span&gt;
&lt;span class=&quot;ex&quot;&gt;192.168.1.1&lt;/span&gt; &lt;span class=&quot;co&quot;&gt;# one line that specifies the gateway (in my case 192.168.1.1)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h2 id=&quot;router-configuration&quot;&gt;Router configuration&lt;/h2&gt;
&lt;p&gt;As every router and brand has its own way of configuration, I cannot tell you much about how you will be able to achieve this task. So I will roughly tell you how I did it (I am ommiting the router name and brand, as it would expose potential vulnerabilities that it could have that I don't know of). For all configurations I had to open the web interface of my router at 192.168.1.1 and enter my password.&lt;/p&gt;
&lt;h3 id=&quot;static-ip&quot;&gt;Static IP&lt;/h3&gt;
&lt;p&gt;For the static ip I had to browse to a category called &lt;em&gt;LAN&lt;/em&gt; where I could assign static IP addresses to specific link layer adresses (MACs). So supposed that your NIC has the MAC 12:34:56:78:9A:BC you would tell your router to assign the desired static ip to that MAC. In my case I assigned the ip 192.168.1.250.&lt;/p&gt;
&lt;h3 id=&quot;port-forwarding&quot;&gt;Port-forwarding&lt;/h3&gt;
&lt;p&gt;Port-forwarding at my routers interface could be found at Homenet -&amp;gt; Port Forwarding. At this section I could create Port-forwarding rules for IPv4 and IPv6. I only created a rule for IPv4. I had to choose a service name: HTTP, the computer to forward the port to: 192.168.1.250, the transport protokoll: TCP and the Port range: 80-80.&lt;/p&gt;
&lt;p&gt;&lt;em&gt;Attention&lt;/em&gt;: When I created the rule I also had to enable a checkbox to activate that rule. Apart from the rules checkbox I also had to enable Port-forwarding as a whole in another dedicated checkbox on that site. This did cost me a little headache in the beginning because I didn't see the specific rules checkbox when creating the port-forwarding rule and I wondered why the port-forwarding didn't work.&lt;/p&gt;
&lt;h2 id=&quot;domainname-and-ddns&quot;&gt;Domainname and DDNS&lt;/h2&gt;
&lt;p&gt;In this section I will explain how I bought a domain name and enabled a DDNS client to update my ip changes to that domain name.&lt;/p&gt;
&lt;h3 id=&quot;getting-a-domain&quot;&gt;Getting a domain&lt;/h3&gt;
&lt;p&gt;There are a lot of domain registration services that you could use. But not all of them have a dynamic dns service included. I chose &lt;a href=&quot;https://www.strato.de&quot;&gt;Strato&lt;/a&gt; which is a german hosting service. I bought the domain-name hermes-technology.de.&lt;/p&gt;
&lt;p&gt;You could also first try things out with a free service like &lt;a href=&quot;https://www.noip.com/&quot;&gt;noip&lt;/a&gt;.&lt;/p&gt;
&lt;h3 id=&quot;integrating-the-domain-in-the-server&quot;&gt;Integrating the domain in the server&lt;/h3&gt;
&lt;p&gt;For proper configuration of the server and name resolving I configured my OpenBSD system to use the new domain name as the hostname.&lt;/p&gt;
&lt;p&gt;For this to work properly, I had to edit the following files (the explanation for the configuration is commented inline):&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot;&gt;&lt;pre class=&quot;sourceCode bash&quot;&gt;&lt;code class=&quot;sourceCode bash&quot;&gt;&lt;span class=&quot;co&quot;&gt;## /etc/myname ##&lt;/span&gt;
&lt;span class=&quot;ex&quot;&gt;hermes-technology.de&lt;/span&gt; &lt;span class=&quot;co&quot;&gt;# one line that specifies the symbolic name of the host machine &lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;div class=&quot;sourceCode&quot;&gt;&lt;pre class=&quot;sourceCode bash&quot;&gt;&lt;code class=&quot;sourceCode bash&quot;&gt;&lt;span class=&quot;co&quot;&gt;## /etc/resolv.conf ##&lt;/span&gt;
&lt;span class=&quot;ex&quot;&gt;nameserver&lt;/span&gt; 192.168.1.1 &lt;span class=&quot;co&quot;&gt;# the nameserver the resolver should query&lt;/span&gt;
&lt;span class=&quot;ex&quot;&gt;lookup&lt;/span&gt; file bind &lt;span class=&quot;co&quot;&gt;# gethostbyname and gehostbyaddr should lookup in /etc/hosts first (file) and then ask the provided nameserver (bind)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;div class=&quot;sourceCode&quot;&gt;&lt;pre class=&quot;sourceCode bash&quot;&gt;&lt;code class=&quot;sourceCode bash&quot;&gt;&lt;span class=&quot;co&quot;&gt;## /etc/hosts ##&lt;/span&gt;
&lt;span class=&quot;co&quot;&gt;# The first two lines are the defaults, the last line again specifies my domain name with my static ip address&lt;/span&gt;
&lt;span class=&quot;co&quot;&gt;# These names will be used by the resolver that is configured to lookup in this file via /etc/resolv.conf&lt;/span&gt;
&lt;span class=&quot;ex&quot;&gt;127.0.0.1&lt;/span&gt;   localhost
::&lt;span class=&quot;ex&quot;&gt;1&lt;/span&gt;     localhost
&lt;span class=&quot;ex&quot;&gt;192.168.1.250&lt;/span&gt;  hermes-technology.de&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h4 id=&quot;making-the-public-ip-reachable-from-the-internet-ddns&quot;&gt;Making the public ip reachable from the internet (DDNS)&lt;/h4&gt;
&lt;p&gt;My IPS, like most of the private Internet connections, frequently changes my public ip so I cannot assing a static ip to my domain name. A service to circumvent this problem is a so called dynamic DNS client, or short DDNS client on the server side. There are &lt;strong&gt;two possibilites&lt;/strong&gt; for this to work: Either my &lt;strong&gt;router itself has a DDNS client&lt;/strong&gt; that can resolve the host that I have bought my domainname from, or I will &lt;strong&gt;install a dedicated DDNS client&lt;/strong&gt; on my OpenBSD server.&lt;/p&gt;
&lt;p&gt;As mentioned before, I bought my domain at the german service called Strato (www.strato.de). At this time my router had a few DDNS hosts that it could make a ddns update for, but Strato was not one of them. So I was left with the second choice: Installing a DDNS client on the OpenBSD server and configuring it to forward ip changes to the strato service.&lt;/p&gt;
&lt;p&gt;I decided to install the ddns client called ddclient which is already available in the official ports of OpenBSD. So it was as easy as calling &lt;code&gt;pkg_add ddclient&lt;/code&gt; for installing it. Thereafter I was left with the configuration file in /etc/ddclient/ddclient.conf. I appended some lines at the bottom of the &lt;code&gt;ddclient.conf&lt;/code&gt; file, so that it would look like this:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot;&gt;&lt;pre class=&quot;sourceCode bash&quot;&gt;&lt;code class=&quot;sourceCode bash&quot;&gt;&lt;span class=&quot;co&quot;&gt;## /etc/ddclient/ddclient.conf&lt;/span&gt;

&lt;span class=&quot;co&quot;&gt;## These lines were enabled by default&lt;/span&gt;
&lt;span class=&quot;va&quot;&gt;daemon=&lt;/span&gt;600              # &lt;span class=&quot;ex&quot;&gt;check&lt;/span&gt; every 300 seconds
&lt;span class=&quot;va&quot;&gt;syslog=&lt;/span&gt;yes              # &lt;span class=&quot;ex&quot;&gt;log&lt;/span&gt; update msgs to syslog
&lt;span class=&quot;va&quot;&gt;mail=&lt;/span&gt;root               # &lt;span class=&quot;ex&quot;&gt;mail&lt;/span&gt; all msgs to root
&lt;span class=&quot;ex&quot;&gt;mail-failure&lt;/span&gt;=root           # mail failed update msgs to root
&lt;span class=&quot;va&quot;&gt;pid=&lt;/span&gt;/var/run/ddclient/ddclient.pid  # &lt;span class=&quot;ex&quot;&gt;record&lt;/span&gt; PID in file.
&lt;span class=&quot;va&quot;&gt;ssl=&lt;/span&gt;yes                 # &lt;span class=&quot;ex&quot;&gt;use&lt;/span&gt; ssl-support.  Works with
                    &lt;span class=&quot;co&quot;&gt;# ssl-library&lt;/span&gt;

&lt;span class=&quot;co&quot;&gt;## ... There were some commented lines in between&lt;/span&gt;

&lt;span class=&quot;co&quot;&gt;# This is the chunk I appended:&lt;/span&gt;
&lt;span class=&quot;va&quot;&gt;use=&lt;/span&gt;web
&lt;span class=&quot;va&quot;&gt;protocol=&lt;/span&gt;dyndns2
&lt;span class=&quot;va&quot;&gt;server=&lt;/span&gt;dyndns.strato.com
&lt;span class=&quot;va&quot;&gt;login=&lt;/span&gt;hermes-technology.de
&lt;span class=&quot;va&quot;&gt;password=&lt;/span&gt;somepassword
&lt;span class=&quot;ex&quot;&gt;hermes-technology.de&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;The configuration above has a few components: - The first &lt;code&gt;use=web&lt;/code&gt; means, that the ddns server is reached through the internet. - &lt;code&gt;protocol=dyndns2&lt;/code&gt; specifies the ddns protocol that the destination server uses. - &lt;code&gt;login=hermes-technology.de&lt;/code&gt; is my login name for he server as provided by strato - &lt;code&gt;password=somepassword&lt;/code&gt; is the specific password for the ddns service - the last lines of the configuration specifies the domain names that should receive the DDNS updates I only update my main domain for DDNS as I have simple CNAME entries for all other subdomains that are thus reached through the same ip address as the main domain.&lt;/p&gt;
&lt;p&gt;I also enabled the ddclient Daemon in the service manager:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot;&gt;&lt;pre class=&quot;sourceCode bash&quot;&gt;&lt;code class=&quot;sourceCode bash&quot;&gt;&lt;span class=&quot;ex&quot;&gt;doas&lt;/span&gt; rcctl enable ddclient&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;and started it:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot;&gt;&lt;pre class=&quot;sourceCode bash&quot;&gt;&lt;code class=&quot;sourceCode bash&quot;&gt;&lt;span class=&quot;ex&quot;&gt;doas&lt;/span&gt; rcctl start ddclient&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h2 id=&quot;start-httpd-and-show-your-website&quot;&gt;Start httpd and show your website&lt;/h2&gt;
&lt;p&gt;At last I wanted to show a simple static html &amp;quot;Hello World!&amp;quot; page on my domain. For this to work I had to configure the &lt;code&gt;httpd&lt;/code&gt; daemon, which is a simple http server from OpenBSD based on Apache.&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot;&gt;&lt;pre class=&quot;sourceCode bash&quot;&gt;&lt;code class=&quot;sourceCode bash&quot;&gt;&lt;span class=&quot;co&quot;&gt;## /etc/httpd.conf&lt;/span&gt;
&lt;span class=&quot;va&quot;&gt;ext_if=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&amp;quot;*&amp;quot;&lt;/span&gt; &lt;span class=&quot;co&quot;&gt;## any interface is the external interface.. including my em0&lt;/span&gt;

&lt;span class=&quot;ex&quot;&gt;server&lt;/span&gt; &lt;span class=&quot;st&quot;&gt;&amp;quot;hermes-technology.de&amp;quot;&lt;/span&gt; {
        
        &lt;span class=&quot;ex&quot;&gt;listen&lt;/span&gt; on &lt;span class=&quot;va&quot;&gt;$ext_if&lt;/span&gt; port 80 &lt;span class=&quot;co&quot;&gt;## listen on all interfaces on port 80&lt;/span&gt;
        
        &lt;span class=&quot;ex&quot;&gt;root&lt;/span&gt; &lt;span class=&quot;st&quot;&gt;&amp;quot;/htdocs/hermes-technology.de&amp;quot;&lt;/span&gt; &lt;span class=&quot;co&quot;&gt;## make /var/www/htdocs/hermes-technology.de my root website directory&lt;/span&gt;
}

&lt;span class=&quot;ex&quot;&gt;types&lt;/span&gt; {
        &lt;span class=&quot;ex&quot;&gt;include&lt;/span&gt; &lt;span class=&quot;st&quot;&gt;&amp;quot;/usr/share/misc/mime.types&amp;quot;&lt;/span&gt;
}&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;After configurin the daemon I had to insert a &lt;code&gt;index.html&lt;/code&gt; in my website's directory:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot;&gt;&lt;pre class=&quot;sourceCode bash&quot;&gt;&lt;code class=&quot;sourceCode bash&quot;&gt;&lt;span class=&quot;bu&quot;&gt;cd&lt;/span&gt; /var/www/htdocs/hermes-technology.de/&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;div class=&quot;sourceCode&quot;&gt;&lt;pre class=&quot;sourceCode bash&quot;&gt;&lt;code class=&quot;sourceCode bash&quot;&gt;&lt;span class=&quot;fu&quot;&gt;touch&lt;/span&gt; index.html&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;div class=&quot;sourceCode&quot;&gt;&lt;pre class=&quot;sourceCode bash&quot;&gt;&lt;code class=&quot;sourceCode bash&quot;&gt;&lt;span class=&quot;bu&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;st&quot;&gt;&amp;quot;Hello World!&amp;quot;&lt;/span&gt; &lt;span class=&quot;op&quot;&gt;&amp;gt;&lt;/span&gt; index.html&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;div class=&quot;sourceCode&quot;&gt;&lt;pre class=&quot;sourceCode bash&quot;&gt;&lt;code class=&quot;sourceCode bash&quot;&gt;&lt;span class=&quot;ex&quot;&gt;doas&lt;/span&gt; rcctl enable httpd
&lt;span class=&quot;ex&quot;&gt;doas&lt;/span&gt; rcctl start httpd&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Now my &amp;quot;Hello World!&amp;quot; page will be shown at hermes-technology.de.&lt;/p&gt;
&lt;h2 id=&quot;outlook&quot;&gt;Outlook&lt;/h2&gt;
&lt;p&gt;In the next post I will setup an OpenBSD virtual machine on the main server that receives the http requests. This includes configuring our own DNS server &lt;code&gt;unbound&lt;/code&gt; and setting up the firewall &lt;code&gt;pf&lt;/code&gt; (see Figure 1).&lt;/p&gt;</content><author><name></name></author><summary type="html">I'm setting up a simple server in OpenBSD. This includes installing OpenBSD and configuring the network. Also I needed to enable port-forwarding on my home router and establish a dyndns service for updating my domain to point on the frequenctly changing IP.</summary></entry><entry><title type="html">My first blog post!</title><link href="https://blog.hermes-technology.de/openbsd/server/2017/05/31/my-first-post.html" rel="alternate" type="text/html" title="My first blog post!" /><published>2017-05-31T00:30:00+02:00</published><updated>2017-05-31T00:30:00+02:00</updated><id>https://blog.hermes-technology.de/openbsd/server/2017/05/31/my-first-post</id><content type="html" xml:base="https://blog.hermes-technology.de/openbsd/server/2017/05/31/my-first-post.html">&lt;p&gt;Hello, I'm Jan - welcome to my blog and the first post. Today I managed to finish the rough infrastructure of my OpenBSD Server. I'm not sure how secure it is to expose the whole setup to the world (for intruders its naturally a good start if they exactly know how the server is built and where it might be possible to attack).&lt;/p&gt;
&lt;p&gt;But anyway I decided to view this more as a learning experience. If there is somebody who can easily attack the infrastructure after exposing its internal setup then I obviously did not learn enough on the way.&lt;/p&gt;
&lt;p&gt;Here is a quick sketch of the server infrastructure I came up with right now:&lt;/p&gt;
&lt;figure&gt;
&lt;img src=&quot;https://blog.hermes-technology.de/assets/server-sketch.svg.png&quot; alt=&quot;Server Infrastructure&quot; /&gt;&lt;figcaption&gt;Server Infrastructure&lt;/figcaption&gt;
&lt;/figure&gt;</content><author><name></name></author><summary type="html">An introduction to my OpenBSD server setup.</summary></entry></feed>