<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>A virtualized network with OpenBSD&#39;s vmm</title>
  <meta name="description" content="I wanted to setup a network of virtual machines on my server. Each VM shall provide its specified service on a dedicated subdomain. I need to create the VMs,...">

  <link rel="stylesheet" href="/assets/main.css">
  <link rel="canonical" href="http://localhost:4000/openbsd/server/virtualmachine/network/2017/06/12/vmd-for-a-virtual-server-network.html">
  <link rel="alternate" type="application/rss+xml" title="Hermes Technology Blog" href="/feed.xml">
  
  

	<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
	<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
	<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
	<link rel="manifest" href="/manifest.json">
	<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
	<meta name="theme-color" content="#ffffff">

  
  
</head>


  <body>

    
<script data-isso="//blog.hermes-technology.de/isso/" src="//blog.hermes-technology.de/isso/js/embed.min.js"></script>



<header class="site-header" role="banner">

  <div class="wrapper">
    
    
    <a class="site-title" href="/">Hermes Technology Blog</a>
  
    
      <nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
              <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
              <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger">
          
            
            
            <a class="page-link" href="/projects/">Projects</a>
            
          
            
            
            <a class="page-link" href="/about/">About</a>
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
          
        </div>
      </nav>
    
  </div>
</header>


    <main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">

	  

	  <div class="project-nav">
	  
	  </div>

	  <div class="project-banner">
		  <img class="project-img" src="http://localhost:4000/assets/my-openbsd-server-project-banner.svg.png" alt="My OpenBSD server"/>
		  <!--h1 class="project-title" itemprop="project banner">My OpenBSD server</h1-->

	  <!--
	  <h1 class="project-qualifier">3</h1>
	  -->
	  </div> 

	  <h1 class="project-part">Part 3 of 4:</h1>

	  	  <h1 class="post-title" itemprop="name headline">
	  

		
		

	    
	  

		
		

	    
		  <a class="arrow arrow-left" role="button" href="/openbsd/server/2017/06/06/a-first-server.html"></a>
		
	  

		
		

	    
	  

		
		

	    
	  

		
		

	    
	  

		
		

	    
	  
	  
	  A virtualized network with OpenBSD&#39;s vmm
	  
	  

		
		

		
	  

		
		

		
	  

		
		

		
	  

		
		

		
		  <a class="arrow arrow-right" role="button" href="/2017/06/21/my-openbsd-server-3-making-ssh-more-secure.html"></a>
		
	  

		
		

		
	  

		
		

		
	  
	  </h1>
	  
    <p class="post-meta">
      <time datetime="2017-06-12T01:00:00+02:00" itemprop="datePublished">
        
        Jun 12, 2017
      </time>
      </p>
	
	
      
      <p class="author"><a href="/openbsd/server/virtualmachine/network/2017/06/12/vmd-for-a-virtual-server-network.html#isso-thread">Comments</a></p>
      
	
  
  </header>



  <div class="post-content" itemprop="articleBody">
    <p><strong>UPDATE:</strong>
As I already suggested in the outlook of my last post, I wanted to exchange <code class="language-plaintext highlighter-rouge">nginx</code> with <code class="language-plaintext highlighter-rouge">relayd</code> for redirection. I did this now, thanks to <a href="https://serverfault.com/questions/856807/openbsd-how-to-use-relayd-and-httpd-for-redirecting-subdomain-requests/858849#858849">an answered question on stackoverflow</a>. See the new section: <a href="/openbsd/server/virtualmachine/network/2017/06/12/vmd-for-a-virtual-server-network.html#configuring-relayd-on-the-host-vm">Configuring relayd on the host-vm</a>.</p>

<p>Hello dear reader,</p>

<p>in my last post I described the setup of a http server which is reachable through a public domain on OpenBSD. This time I would like to go a little bit further and extend the server with a network of virtual machines, where each machine can be reached by the name of the subdomain it should represent.</p>

<h2 id="intro">Intro</h2>

<p>For this setup to work, I needed to download two files from the OpenBSD site:</p>

<ul>
  <li>The installation file of the most recent OpenBSD system (at the time it was 6.1)</li>
  <li>The boot file (bsd.rd)</li>
</ul>

<p>Afterwards I had to install the VM, configure it, duplicate it for the virtual network.</p>

<p>Then I had to configure the main server and everything worked like a charm in the end.</p>

<p>For better explenation I will include a similar figure as show in my last two posts.</p>

<figure>
  <figcaption>
<i>Figure 1: Virtual Network on my server</i>
</figcaption>
  <p><img src="http://localhost:4000/assets/server-sketch-foo-bar.svg.png" alt="Server Infrastructure" title="Figure 1: Virtual Network on my server" /></p>
</figure>

<p>You can see that there are serveral components to be configured for the virtual network to work as desired in the end:</p>

<p>I need to…:</p>

<ul>
  <li>…configure <code class="language-plaintext highlighter-rouge">pf</code> for redirection and NAT</li>
  <li>…configure <code class="language-plaintext highlighter-rouge">unbound</code> for acting as a DNS server</li>
  <li>…create three different VMs (host-vm, foo-vm, bar-vm)</li>
  <li>…connect the VMs to a virtual switch called “localnet”</li>
  <li>…configure <code class="language-plaintext highlighter-rouge">relayd</code> on the host-vm for redirection of subdomain requests</li>
</ul>

<h3 id="outline">Outline</h3>

<p>Here a short outline to jump back and forth (turn off <code class="language-plaintext highlighter-rouge">noscript</code> for a second to see it :-) ):</p>

<div id="toc"></div>

<h2 id="create-the-vms">Create the VMs</h2>

<p>This section will deal about creating a raw disk image and installing OpenBSD on it via the OpenBSD included <code class="language-plaintext highlighter-rouge">vmd</code> framework.
This includes downloading some necessary resources and creating and installing a VM with the application called <code class="language-plaintext highlighter-rouge">vmctl</code>.</p>

<p>Afterwards the created installation will be duplicated and set up for the different VMs.</p>

<h3 id="create-the-host-vm">Create the Host VM</h3>

<h4 id="choose-my-mirror-to-download-from">Choose my mirror to download from</h4>

<p>There are many mirrors that I could choose from: listed <a href="https://www.openbsd.org/ftp.html">here</a> on the OpenBSD website.</p>

<h4 id="download-the-files">Download the files</h4>

<p>At first I located the necessary files in a webbrowser on my system. I chose the mirror in Frankfurt, so the main url was <a href="https://ftp.hostserver.de/pub/OpenBSD/">https://ftp.hostserver.de/pub/OpenBSD/</a>.</p>

<p>There I chose the most recent OpenBSD version 6.1 and navigated to the directory for amd64 ending here: <a href="https://ftp.hostserver.de/pub/OpenBSD/6.1/amd64/">https://ftp.hostserver.de/pub/OpenBSD/6.1/amd64/</a>.</p>

<p>The necessary files are:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">install61.fs</code> the OpenBSD installation image, that I already downloaded when I created a bootable USB Stick for my OpenBSD Installation.</li>
  <li><code class="language-plaintext highlighter-rouge">bsd.rd</code> the boot image of OpenBSD.</li>
</ul>

<p>I opened an ssh-session to the server and downloaded those files via <code class="language-plaintext highlighter-rouge">ftp</code> (I’m using <code class="language-plaintext highlighter-rouge">ftp</code> now and not <code class="language-plaintext highlighter-rouge">wget</code>, as it is in base, thank you for the comment Raf):</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cd</span> ~
<span class="nb">mkdir </span>vm-network
<span class="nb">cd </span>vm-network
ftp https://ftp.hostserver.de/pub/OpenBSD/6.1/amd64/install61.fs
ftp https://ftp.hostserver.de/pub/OpenBSD/6.1/amd64/bsd.rd
</code></pre></div></div>

<p>As PengouinBSD correctly suggested in the comments, I should also check the downloaded files:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cd vm-network
ftp https://ftp.hostserver.de/pub/OpenBSD/6.1/amd64/SHA256.sig
signify -Cp /etc/signify/openbsd-61-base.pub -x SHA256.sig install61.fs bsd.rd
</code></pre></div></div>

<p>From now on I assume you also have a folder called <code class="language-plaintext highlighter-rouge">vm-network</code> in your user’s home directory.</p>

<h4 id="create-a-raw-disk-file-and-start-the-installation">Create a raw disk file and start the installation</h4>

<p>I’m located in my dedicated folder <code class="language-plaintext highlighter-rouge">vm-network</code>, where the previously downloaded files <code class="language-plaintext highlighter-rouge">install61.fs</code> and <code class="language-plaintext highlighter-rouge">bsd.rd</code> are located.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cd</span> ~/vm-network
</code></pre></div></div>

<p>Within this folder I created a raw disk image called <code class="language-plaintext highlighter-rouge">host.drive</code> with 8GB:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>doas vmctl create host.drive <span class="nt">-s</span> 8G
</code></pre></div></div>

<p>And started installing on this disk interactively with a console:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>doas vmctl start <span class="s2">"host-vm"</span> <span class="nt">-c</span> <span class="nt">-b</span> bsd.rd <span class="nt">-m</span> 2G <span class="nt">-i</span> 1 <span class="nt">-d</span> host.drive <span class="nt">-d</span> install61.fs
</code></pre></div></div>
<p>The options that are provided to <code class="language-plaintext highlighter-rouge">vmctl</code> mean the following:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">start "host-vm"</code>: start the virtual machine, naming it “host-vm”</li>
  <li><code class="language-plaintext highlighter-rouge">-c</code>: immediately connect the console of the vm into the current shell</li>
  <li><code class="language-plaintext highlighter-rouge">-b bsd.rd</code>: choose the specified image as boot kernel</li>
  <li><code class="language-plaintext highlighter-rouge">-m 2G</code>: start the virtual machine with two gigabytes of memory</li>
  <li><code class="language-plaintext highlighter-rouge">-i 1</code>: create a virtual network interface connected to that virtual machine</li>
  <li><code class="language-plaintext highlighter-rouge">-d host.drive</code>: attach the raw disk file where to install OpenBSD on</li>
  <li><code class="language-plaintext highlighter-rouge">-d install61.fs</code>: attach the image with the OpenBSD 6.1 installation files</li>
</ul>

<p>&lt;div class=tip&gt;</p>

<p>+———————————————————————————————————————————+
|<strong>A TIP TO PREVENT FUTURE HEADACHES</strong>                                                                                            |
+=================================================================================================================================+
|If you ever run into the problem of this annoying Error when running the command <code class="language-plaintext highlighter-rouge">vmctl start ...</code>:                              |
|                                                                                                                                 |
|<code class="language-plaintext highlighter-rouge">bash                                                                                                                          |
|doas vmctl start "myvm" -i 1 -d xyz.drive                                                                                        |
|vmctl: start vm command failed: No such file or directory                                                                        |
|</code>                                                                                                                              |
|                                                                                                                                 |
|then you’re probably missing the device file for the taps in <code class="language-plaintext highlighter-rouge">/dev</code>. The installer creates 4 by default, so you’ll have to run…|
|                                                                                                                                 |
|<code class="language-plaintext highlighter-rouge">bash                                                                                                                          |
|cd /dev; sh MAKEDEV tap4                                                                                                         |
|</code>                                                                                                                              |
|                                                                                                                                 |
|…and so on for each new tap device you need.                                                                                   |
|                                                                                                                                 |
|I took this tip from <a href="http://openbsd-archive.7691.n7.nabble.com/vmd-upper-limit-on-number-of-vm-s-td312916.html">here</a>           |
|when I ran into a simmilar problem.                                                                                              |
+———————————————————————————————————————————+</p>

<p>&lt;/div&gt;</p>

<h4 id="guided-installation-of-openbsd-for-the-host-vm">Guided Installation of OpenBSD for the host-vm</h4>

<p>In <em>Table 1</em> below I show the whole installation process and what I did including some comments.</p>

<figure>
  <figcaption>
<i>Table 1: Guided Installation</i>
</figcaption>
  <p>+——————————————————————————-+——————————+——————————+
| <strong>Terminal Output</strong>                                                           |            <strong>My Input</strong>      | <strong>Comments</strong>                 |
+===============================================================================+==============================+==============================+
|<code class="language-plaintext highlighter-rouge">   													                    |                              |                              |
|Welcome to the OpenBSD/amd64 6.1 installation program.                         |                              | I want to install OpenBSD    |
|(I)nstall, (U)pgrade, (A)utoinstall or (S)hell?                                |`I`                           |                              |
|</code>                                                                            |                              |                              |
+——————————————————————————-+——————————+——————————+
|<code class="language-plaintext highlighter-rouge">   													                    |                              |                              |
|Terminal type? [vt220]                                                         |*return*                      |                              |
|</code>                                                                            |                              |                              |
+——————————————————————————-+——————————+——————————+
|<code class="language-plaintext highlighter-rouge">                                                                           |                              |Call it host, because it will |
|System hostname? (short form, e.g. 'foo')                                      |`host`                        |be the host for the vm net.   |
|</code>                                                                            |                              |                              |
+——————————————————————————-+——————————+——————————+
|<code class="language-plaintext highlighter-rouge">                                                                           |                              |                              |
|Available network interfaces are: vio0 vlan0                                   |*return*                      |Yes, configure vio0.          |
|Which network interface do you wish to configure? (or 'done') [vio0]           |                              |                              |
|</code>                                                                            |                              |                              |
+——————————————————————————-+——————————+——————————+
|<code class="language-plaintext highlighter-rouge">                                                                           |                              |                              |
|IPv4 address for vio0? (or 'dhcp' or 'none') [dhcp]                            |`192.168.30.2`                |ip address of my vm           |
|</code>                                                                            |                              |in the virtual network        |
+——————————————————————————-+——————————+——————————+
|<code class="language-plaintext highlighter-rouge">                                                                           |                              |                              |
|Netmask for vio0? [255.255.255.0]                                              |*return*                      |                              |
|</code>                                                                            |                              |                              |
+——————————————————————————-+——————————+——————————+
|<code class="language-plaintext highlighter-rouge">                                                                           |                              |                              |
|IPv6 address for vio0? (or 'rtsol' or 'none') [none]                           |*return*                      |Don't need an IPv6 address.   |
|</code>                                                                            |                              |                              |
+——————————————————————————-+——————————+——————————+
|<code class="language-plaintext highlighter-rouge">                                                                           |                              |                              |
|Which network interface do you wish to configure? (or 'done') [done]           |*return*                      |I'm done.                     |
|</code>                                                                            |                              |                              |
+——————————————————————————-+——————————+——————————+
|<code class="language-plaintext highlighter-rouge">                                                                           |                              |The address of the router that|
|Default IPv4 route? (IPv4 address or none)                                     |                              |manages my virtual network.   |
|</code>                                                                            |<code class="language-plaintext highlighter-rouge">192.168.30.1</code>                |I chose 192.168.30.1 for the  |
|                                                                               |                              |subnet 192.168.30.0/24.       |
+——————————————————————————-+——————————+——————————+
|<code class="language-plaintext highlighter-rouge">                                                                           |                              |                              |
|add net default: gateway 192.168.30.1                                          |                              |                              | 
|</code>                                                                            |                              |                              |
+——————————————————————————-+——————————+——————————+
|<code class="language-plaintext highlighter-rouge">                                                                           |                              |The root domain (In the end it|
|DNS domain name? (e.g. 'bar.com') [my.domain]                                  |`hermes-technology.de`        |will resolve to the hostname  |
|</code>                                                                            |                              |<code class="language-plaintext highlighter-rouge">host.hermes-technology.de</code>.  |
+——————————————————————————-+——————————+——————————+
|<code class="language-plaintext highlighter-rouge">                                                                           |                              |My DNS nameserver should be   |
|DNS nameservers? (IP address list or 'none') [none]                            |`192.168.30.1`                |serving on the virtual NIC    |
|</code>                                                                            |                              |with that IP.                 |
+——————————————————————————-+——————————+——————————+
|<code class="language-plaintext highlighter-rouge">                                                                           |                              |                              |
|Password for root account? (will not echo)                                     |2x `mypasswd`                 |I did choose another password |
|Password for root account? (again)                                             |                              |of course.. :D                |
|</code>                                                                            |                              |                              |
+——————————————————————————-+——————————+——————————+
|<code class="language-plaintext highlighter-rouge">                                                                           |                              |                              |
|Start sshd(8) by default? [yes]                                                |*return*                      |Yes I want to connect via ssh |
|</code>                                                                            |                              |later on.                     |
+——————————————————————————-+——————————+——————————+
|<code class="language-plaintext highlighter-rouge">                                                                           |                              |                              |
|Change the default console to com0? [yes]                                      |*return*                      |sure...                       |
|</code>                                                                            |                              |                              |
+——————————————————————————-+——————————+——————————+
|<code class="language-plaintext highlighter-rouge">                                                                           |                              |                              |
|Which speed should com0 use? (or 'done') [9600]                                |*return*                      |definitely...                 |
|</code>                                                                            |                              |                              |
+——————————————————————————-+——————————+——————————+
|<code class="language-plaintext highlighter-rouge">                                                                           |                              |                              |
|Setup a user? (enter a lower-case loginname, or 'no') [no]                     |`host`                        |I want the user called "host" |
|</code>                                                                            |                              |                              |
+——————————————————————————-+——————————+——————————+
|<code class="language-plaintext highlighter-rouge">                                                                           |                              |                              |
|Full name for user host? [host]                                                |*return*                      |Don't need a full name -.-    |
|</code>                                                                            |                              |                              |
+——————————————————————————-+——————————+——————————+
|<code class="language-plaintext highlighter-rouge">                                                                           |                              |                              |
|Password for user host? (will not echo)                                        |2x `mypasswd`                 |Another safe password...      |
|Password for user host? (again)                                                |                              |                              |
|</code>                                                                            |                              |                              |
+——————————————————————————-+——————————+——————————+
|<code class="language-plaintext highlighter-rouge">                                                                           |                              |                              |
|WARNING: root is targeted by password guessing attacks, pubkeys are safer.     |*return*                      |I don't want to support a     |
|Allow root ssh login? (yes, no, prohibit-password) [no]                        |                              |direct root login via ssh.    |
|</code>                                                                            |                              |                              |
+——————————————————————————-+——————————+——————————+
|<code class="language-plaintext highlighter-rouge">                                                                           |                              |List me the disks!            |
|Available disks are: sd0 sd1.                                                  |`?`                           |                              |
|Which disk is the root disk? ('?' for details) [sd0]                           |                              |                              |
|</code>																		    |							   |							  |
+——————————————————————————-+——————————+——————————+
|<code class="language-plaintext highlighter-rouge">                                                                           |                              |Ok it seems the sd0 with 8G   |
|sd0: Block Device (8.0G)                                                       |                              |is the one I want.            |
|sd1: Block Device (0.3G)                                                       |                              |                              |
|</code>                                                                            |                              |                              |
+——————————————————————————-+——————————+——————————+
|<code class="language-plaintext highlighter-rouge">   																		|							   |							  | 
|Available disks are: sd0 sd1.                                                  |*return*                      |Yes, take sd0.                |
|Which disk is the root disk? ('?' for details) [sd0]                           |                              |                              |
|</code>                                                                            |                              |                              |
+——————————————————————————-+——————————+——————————+
|<code class="language-plaintext highlighter-rouge">                                                                           |                              |                              |
|No valid MBR or GPT.                                                           |*return*                      |Use the whole disk!           |
|Use (W)hole disk MBR, whole disk (G)PT or (E)dit? [whole]                      |                              |                              |
|</code>                                                                            |                              |                              |
+——————————————————————————-+——————————+——————————+
|<code class="language-plaintext highlighter-rouge">                                                                           |                              |                              |
|Setting OpenBSD MBR partition to whole sd0...done.                             |                              |                              |
|The auto-allocated layout for sd0 is:                                          |                              |                              |
|#                size           offset  fstype [fsize bsize   cpg]             |                              |                              |
|  a:           131.1M               64  4.2BSD   2048 16384     1 # /          |                              |                              |
|  b:           182.1M           268480    swap                                 |                              |                              |
|  c:          8192.0M                0  unused                                 |                              |                              |
|  d:           201.7M           641504  4.2BSD   2048 16384     1 # /tmp       |                              |                              |
|  e:           212.8M          1054560  4.2BSD   2048 16384     1 # /var       |*return*                      |Auto layout worked for me..   |
|  f:           951.1M          1490304  4.2BSD   2048 16384     1 # /usr       |                              |                              |
|  g:           542.6M          3438080  4.2BSD   2048 16384     1 # /usr/X11R6 |                              |                              |
|  h:          2150.1M          4549376  4.2BSD   2048 16384     1 # /usr/local |                              |                              |
|  i:          1044.4M          8952832  4.2BSD   2048 16384     1 # /usr/src   |                              |                              |
|  j:          1340.8M         11091808  4.2BSD   2048 16384     1 # /usr/obj   |                              |                              |
|  k:          1432.5M         13837856  4.2BSD   2048 16384     1 # /home      |                              |                              |
|Use (A)uto layout, (E)dit auto layout, or create (C)ustom layout? [a]          |                              |                              |
|</code>                                                                            |                              |                              |
+——————————————————————————-+——————————+——————————+
|<code class="language-plaintext highlighter-rouge">                                                                           |                              |                              |
|Rounding size to bsize (32 sectors): 268416                                    |                              |                              |
|Rounding offset to bsize (32 sectors): 641504                                  |                              |                              |
|Rounding size to bsize (32 sectors): 413056                                    |                              |                              |
|Rounding size to bsize (32 sectors): 435744                                    |                              |                              |
|Rounding size to bsize (32 sectors): 1947776                                   |                              |                              |
|Rounding size to bsize (32 sectors): 1111296                                   |                              |                              |
|Rounding size to bsize (32 sectors): 4403456                                   |                              |                              |
|Rounding size to bsize (32 sectors): 2138976                                   |                              |                              |
|Rounding size to bsize (32 sectors): 2746048                                   |                              |                              |
|Rounding size to bsize (32 sectors): 2933856                                   |                              |                              |
|/dev/rsd0a: 131.1MB in 268416 sectors of 512 bytes                             |                              |                              |
|4 cylinder groups of 32.77MB, 2097 blocks, 4224 inodes each                    |                              |                              |
|/dev/rsd0k: 1432.5MB in 2933856 sectors of 512 bytes                           |                              |                              |
|8 cylinder groups of 202.47MB, 12958 blocks, 25984 inodes each                 |                              |                              |
|/dev/rsd0d: 201.7MB in 413056 sectors of 512 bytes                             |                              |                              |
|4 cylinder groups of 50.42MB, 3227 blocks, 6528 inodes each                    |*return*                      |Don't need another disk.      |
|/dev/rsd0f: 951.1MB in 1947776 sectors of 512 bytes                            |                              |                              |
|5 cylinder groups of 202.47MB, 12958 blocks, 25984 inodes each                 |                              |                              |
|/dev/rsd0g: 542.6MB in 1111296 sectors of 512 bytes                            |                              |                              |
|4 cylinder groups of 135.66MB, 8682 blocks, 17408 inodes each                  |                              |                              |
|/dev/rsd0h: 2150.1MB in 4403456 sectors of 512 bytes                           |                              |                              |
|11 cylinder groups of 202.47MB, 12958 blocks, 25984 inodes each                |                              |                              |
|/dev/rsd0j: 1340.8MB in 2746048 sectors of 512 bytes                           |                              |                              |
|7 cylinder groups of 202.47MB, 12958 blocks, 25984 inodes each                 |                              |                              |
|/dev/rsd0i: 1044.4MB in 2138976 sectors of 512 bytes                           |                              |                              |
|6 cylinder groups of 202.47MB, 12958 blocks, 25984 inodes each                 |                              |                              |
|newfs: reduced number of fragments per cylinder group from 27232 to 27120      |                              |                              |
|to enlarge last cylinder group                                                 |                              |                              |
|/dev/rsd0e: 212.8MB in 435744 sectors of 512 bytes                             |                              |                              |
|5 cylinder groups of 52.97MB, 3390 blocks, 6784 inodes each                    |                              |                              |
|Available disks are: sd1.                                                      |                              |                              |
|Which disk do you wish to initialize? (or 'done') [done]                       |                              |                              |
|</code>                                                                            |                              |                              |
+——————————————————————————-+——————————+——————————+
|<code class="language-plaintext highlighter-rouge">                                                                           |                              |                              |
|Let's install the sets!                                                        |`disk`                        |Ok the sets are on the disk   |
|Location of sets? (disk http or 'done') [http]                                 |                              |with "install61.fs" on.       |
|</code>                                                                            |                              |                              |
+——————————————————————————-+——————————+——————————+
|<code class="language-plaintext highlighter-rouge">                                                                           |                              |                              |
|Is the disk partition already mounted? [no]                                    |*return*                      |No the other disk is not      |
|</code>                                                                            |                              |mounted yet.                  |
+——————————————————————————-+——————————+——————————+
|<code class="language-plaintext highlighter-rouge">                                                                           |                              |                              |
|Available disks are: sd0 sd1.                                                  |*return*                      |Ok sd0 was the 8G so sd1      |
|Which disk contains the install media? (or 'done') [sd1]                       |                              |should be the one I want.     |
|</code>                                                                            |                              |                              |
+——————————————————————————-+——————————+——————————+
|<code class="language-plaintext highlighter-rouge">                                                                           |                              |                              |
|Which disk contains the install media? (or 'done') [sd1]                       |                              |                              |
|  a:           572416             1024  4.2BSD   2048 16384 16142              |                              |mmh, yes seems as if partition|
|  i:              960               64   MSDOS                                 |*return*                      |`a` contains the sets.        |
|Available sd1 partitions are: a i.                                             |                              |                              |
|Which sd1 partition has the install sets? (or 'done') [a]                      |                              |                              |
|</code>                                                                            |                              |                              |
+——————————————————————————-+——————————+——————————+
|<code class="language-plaintext highlighter-rouge">                                                                           |                              |                              |
|Pathname to the sets? (or 'done') [6.1/amd64]                                  |*return*                      |That pathname sounds good to  |
|</code>                                                                            |                              |me                            |
+——————————————————————————-+——————————+——————————+
|<code class="language-plaintext highlighter-rouge">                                                                           |                              |                              |
|Select sets by entering a set name, a file name pattern or 'all'. De-select    |                              |                              |
|sets by prepending a '-' to the set name, file name pattern or 'all'. Selected |                              |I want them all!!             |
|sets are labelled '[X]'.                                                       |                              |                              |
|    [X] bsd           [X] base61.tgz    [X] game61.tgz    [X] xfont61.tgz      |`all`                         |                              |
|    [X] bsd.rd        [X] comp61.tgz    [X] xbase61.tgz   [X] xserv61.tgz      |                              |                              |
|    [ ] bsd.mp        [X] man61.tgz     [X] xshare61.tgz                       |                              |                              |
|Set name(s)? (or 'abort' or 'done') [done]                                     |                              |                              |
|</code>                                                                            |                              |                              |
+——————————————————————————-+——————————+——————————+
|<code class="language-plaintext highlighter-rouge">                                                                           |                              |                              |
|    [X] bsd           [X] base61.tgz    [X] game61.tgz    [X] xfont61.tgz      |                              |                              |
|    [X] bsd.rd        [X] comp61.tgz    [X] xbase61.tgz   [X] xserv61.tgz      |*return*                      |Ok, now you can go on.        |
|    [X] bsd.mp        [X] man61.tgz     [X] xshare61.tgz                       |                              |                              |
|Set name(s)? (or 'abort' or 'done') [done]                                     |                              |                              |
|</code>                                                                            |                              |                              |
+——————————————————————————-+——————————+——————————+
|<code class="language-plaintext highlighter-rouge">                                                                           |                              |There is no way around that.. |
|Directory does not contain SHA256.sig. Continue without verification? [no]     |`yes`                         |                              |
|</code>                                                                            |                              |                              |
+——————————————————————————-+——————————+——————————+
|<code class="language-plaintext highlighter-rouge">                                                                           |                              |                              |
|Installing bsd          100% |**************************| 10433 KB    00:00    |                              |                              |
|Installing bsd.rd       100% |**************************|  9210 KB    00:00    |                              |                              |
|Installing bsd.mp       100% |**************************| 10499 KB    00:00    |                              |                              |
|Installing base61.tgz   100% |**************************| 52322 KB    00:04    |                              |                              |
|Extracting etc.tgz      100% |**************************|   189 KB    00:00    |                              |                              |
|Installing comp61.tgz   100% |**************************| 46070 KB    00:04    |                              |                              |
|Installing man61.tgz    100% |**************************|  8719 KB    00:00    |*return*                      |                              |
|Installing game61.tgz   100% |**************************|  2707 KB    00:00    |                              |That's it with the sets.      |
|Installing xbase61.tgz  100% |**************************| 17497 KB    00:01    |                              |                              |
|Extracting xetc.tgz     100% |**************************|  7006       00:00    |                              |                              |
|Installing xshare61.tgz 100% |**************************|  4406 KB    00:00    |                              |                              |
|Installing xfont61.tgz  100% |**************************| 39342 KB    00:02    |                              |                              |
|Installing xserv61.tgz  100% |**************************| 13001 KB    00:00    |                              |                              |
|Location of sets? (disk http or 'done') [done]                                 |                              |                              |
|</code>                                                                            |                              |                              |
+——————————————————————————-+——————————+——————————+
|<code class="language-plaintext highlighter-rouge">                                                                           |                              |                              |
|What timezone are you in? ('?' for list) [Canada/Mountain]                     |                              |                              |
|Africa/      Chile/       GB-Eire      Israel       Navajo       US/           |                              |                              |
|America/     Cuba         GMT          Jamaica      PRC          UTC           |                              |                              |
|Antarctica/  EET          GMT+0        Japan        PST8PDT      Universal     |                              |                              |
|Arctic/      EST          GMT-0        Kwajalein    Pacific/     W-SU          |                              |                              |
|Asia/        EST5EDT      GMT0         Libya        Poland       WET           |`?`                           |Aha... ok I guess there is    |
|Atlantic/    Egypt        Greenwich    MET          Portugal     Zulu          |                              |a Berlin in Europe...         |
|Australia/   Eire         HST          MST          ROC          posix/        |                              |                              |
|Brazil/      Etc/         Hongkong     MST7MDT      ROK          posixrules    |                              |                              |
|CET          Europe/      Iceland      Mexico/      Singapore    right/        |                              |                              |
|CST6CDT      Factory      Indian/      NZ           Turkey                     |                              |                              |
|Canada/      GB           Iran         NZ-CHAT      UCT                        |                              |                              |
|</code>                                                                            |                              |                              |
+——————————————————————————-+——————————+——————————+
|<code class="language-plaintext highlighter-rouge">                                                                           |                              |                              |
|What timezone are you in? ('?' for list) [Canada/Mountain]                     |`Europe/Berlin`               |...so I take that.            |
|</code>                                                                            |                              |                              |
+——————————————————————————-+——————————+——————————+
|<code class="language-plaintext highlighter-rouge">                                                                           |                              |                              |
|Saving configuration files...done.                                             |                              |                              |
|Making all device nodes...done.                                                |                              |                              |
|</code>                                                                            |                              |                              |
+——————————————————————————-+——————————+——————————+
|<code class="language-plaintext highlighter-rouge">                                                                           |                              |                              |
|CONGRATULATIONS! Your OpenBSD install has been successfully completed!         |                              |                              |
|To boot the new system, enter 'reboot' at the command prompt.                  |                              |Made it!                      |
|When you login to your new system the first time, please read your mail        |                              |                              |
|using the 'mail' command.                                                      |                              |                              |
|</code>                                                                            |                              |                              |
+——————————————————————————-+——————————+——————————+</p>

</figure>

<p>Ok now he is telling me to reboot the machine… But I can easily just choose to exit the vm via this key-sequence:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>~^D
</code></pre></div></div>

<p>So first enter the <strong>tilde</strong> symbol and afterwards <strong>Ctrl-D</strong>.</p>

<p><em>The tilde is not supposed to apear in the terminal input.</em></p>

<p>Thereafter I stopped the created virtual machine:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>doas vmctl stop <span class="s2">"host-vm"</span>
</code></pre></div></div>

<p>And made a copy of the installation:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>doas <span class="nb">cp </span>host.drive host.drive.bak
</code></pre></div></div>

<p>I also checked if everything installed fine:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>doas vmctl start "host-vm" -c -i 1 -d host.drive
</code></pre></div></div>

<p>It should boot into the installed system now asking you for login and password in the end.</p>

<p>I configured <code class="language-plaintext highlighter-rouge">doas</code> and added the <code class="language-plaintext highlighter-rouge">/etc/installurl</code> file as shown in my last <a href="/openbsd/server/2017/06/06/a-first-server.html#openbsd-server---install-and-set-up">post</a>.</p>

<h3 id="duplicate-the-host-vm-for-other-vms-i-want">Duplicate the Host VM for other VMs I want</h3>

<p>Now I could easily duplicate the created disk file for other needed VMs:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>doas <span class="nb">cp </span>host.drive foo.drive
doas <span class="nb">cp </span>host.drive bar.drive
</code></pre></div></div>

<p>Afterwards I started each VM and did some adjustments (I will only show what I did for the “foo” vm as the “bar” vm will be configured analogously:</p>

<p>Starting the VM as usual:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>doas vmctl start <span class="s2">"foo-vm"</span> <span class="nt">-c</span> <span class="nt">-i</span> 1 <span class="nt">-d</span> foo.drive
</code></pre></div></div>

<p>Add the foo user:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>doas adduser
</code></pre></div></div>

<p>I copied my terminal output:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Couldn't find /etc/adduser.conf: creating a new adduser configuration file
Reading /etc/shells
Enter your default shell: csh ksh nologin sh [ksh]: 
Your default shell is: ksh -&gt; /bin/ksh
Default login class: authpf bgpd daemon default pbuild staff unbound 
[default]: 
Enter your default HOME partition: [/home]: 
Copy dotfiles from: /etc/skel no [/etc/skel]: 
Send welcome message?: /path/file default no [no]: 
Do not send message(s)
Prompt for passwords by default (y/n) [y]: 
Default encryption method for passwords: auto blowfish [auto]: 
Use option ``-silent'' if you don't want to see all warnings and questions.

Reading /etc/shells
Check /etc/master.passwd
Check /etc/group

Ok, let's go.
Don't worry about mistakes. There will be a chance later to correct any input.
Enter username []: foo
Enter full name []: 
Enter shell csh ksh nologin sh [ksh]: 
Uid [1001]: 
Login group foo [foo]: 
Login group is ``foo''. Invite foo into other groups: guest no 
[no]: wheel
Login class authpf bgpd daemon default pbuild staff unbound 
[default]: 
Enter password []: 
Enter password again []: 

Name:        foo
Password:    ******
Fullname:    foo
Uid:         1001
Gid:         1001 (foo)
Groups:      foo wheel
Login Class: default
HOME:        /home/foo
Shell:       /bin/ksh
OK? (y/n) [y]: 
Added user ``foo''
Copy files from /etc/skel to /home/foo
Add another user? (y/n) [y]: n
Goodbye!
</code></pre></div></div>

<p>Deleted the host user:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>doas userdel host
doas <span class="nb">rm</span> <span class="nt">-rf</span> /home/host
</code></pre></div></div>

<p>Configured the new hostname:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">## /etc/hosts</span>
127.0.0.1       localhost
::1             localhost
192.168.30.10   foo.hermes-technology.de foo
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">## /etc/myname</span>
foo.hermes-technology.de
</code></pre></div></div>

<p>Alter the <code class="language-plaintext highlighter-rouge">/etc/hostname.vio0</code> for the correct ip (it will be 192.168.30.4 for the bar-vm):</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">## /etc/hostname.vio0</span>
inet 192.168.30.3 255.255.255.0
</code></pre></div></div>

<p>Then I enabled httpd to show a “Hello from foo” html page.</p>

<p>Refer to my last post to see how to <a href="/openbsd/server/2017/06/06/a-first-server.html#start-httpd-and-show-your-website">setup httpd for this task</a>:</p>

<p>I exited the VM.</p>

<p><strong>I did the above for each VM that I added to the virtual network.</strong></p>

<h2 id="back-on-the-main-server">Back on the main server</h2>

<p>Ok now that I had the <code class="language-plaintext highlighter-rouge">host-vm</code>, <code class="language-plaintext highlighter-rouge">foo-vm</code> and <code class="language-plaintext highlighter-rouge">bar-vm</code> successfully set up I had to do some configuration on the main server.</p>

<p>At first I created a virtual NIC that acts as a Router and DNS server to the virtual-machine-network.</p>

<p>Then I configured the internal firewall <code class="language-plaintext highlighter-rouge">pf</code> and the DNS service via <code class="language-plaintext highlighter-rouge">unbound</code>.</p>

<p>At the end I configured the virtual machines for <code class="language-plaintext highlighter-rouge">vmd</code> in <code class="language-plaintext highlighter-rouge">/etc/vm.conf</code>.</p>

<h3 id="the-virtual-network-interface-card-nic">The virtual network interface card (NIC)</h3>

<p>Creating a virtual network device was very easy in OpenBSD.</p>

<p>I just had to create a file called <code class="language-plaintext highlighter-rouge">/etc/hostname.vether0</code> and insert the desired configuration:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>doas <span class="nt">-s</span>
<span class="nb">touch</span> /etc/hostname.vether0
<span class="nb">echo</span> <span class="s2">"inet 192.168.30.1 255.255.255.0 NONE"</span> <span class="o">&gt;</span> /etc/hostname.vether0
</code></pre></div></div>

<p>Now on next reboot or after restarting the networking service I had the vether0 device at 192.168.30.1.</p>

<h3 id="pf---the-openbsd-firewall">PF - the OpenBSD firewall</h3>

<p>There is a configuration file for the firewall at <code class="language-plaintext highlighter-rouge">/etc/pf.conf</code>, I configured it like this:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#       $OpenBSD: pf.conf,v 1.54 2014/08/23 05:49:42 deraadt Exp $</span>
<span class="c">#</span>
<span class="c"># See pf.conf(5) and /etc/examples/pf.conf</span>

<span class="nv">int_if</span><span class="o">=</span><span class="s2">"{ vether0 em0 }"</span>

<span class="c">##set skip on lo</span>

<span class="c">##block return  # block stateless traffic</span>
<span class="c">##pass          # establish keep-state</span>

<span class="c"># By default, do not permit remote connections to X11</span>
<span class="c">##block return in on ! lo0 proto tcp to port 6000:6010</span>

<span class="nb">set </span>block-policy drop
<span class="nb">set </span>loginterface egress
<span class="nb">set </span>skip on lo0

<span class="c">## act as a nat</span>
match <span class="k">in </span>all scrub <span class="o">(</span>no-df random-id max-mss 1440<span class="o">)</span>
match out on egress inet from <span class="o">!(</span>egress:network<span class="o">)</span> to any nat-to <span class="o">(</span>egress:0<span class="o">)</span>

<span class="c">## allow all outgoing</span>
pass out quick inet
pass <span class="k">in </span>on <span class="nv">$int_if</span> inet

<span class="c">## redirect http and https to the host of the vms</span>
pass <span class="k">in </span>on egress inet proto tcp from any to <span class="o">(</span>egress<span class="o">)</span> port <span class="o">{</span> 80 443 <span class="o">}</span> rdr-to 192.168.30.2
</code></pre></div></div>

<p>Now incoming http traffic will be redirected to the host-vm as soon as it is up and running.</p>

<p>To apply the configuration changes I executed <code class="language-plaintext highlighter-rouge">doas pfctl -f /etc/pf.conf</code>.</p>

<p>And verified those changes via <code class="language-plaintext highlighter-rouge">doas pfctl -sr</code>.</p>

<h3 id="unbound---my-dns-name-server">unbound - my DNS name server</h3>

<p>I enabled <code class="language-plaintext highlighter-rouge">unbound</code>:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>doas rcctl <span class="nb">enable </span>unbound
</code></pre></div></div>

<p>And configured it the way I needed it:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">## /var/unbound/etc/unbound.conf                                                                                                                                                                       </span>
<span class="c"># $OpenBSD: unbound.conf,v 1.7 2016/03/30 01:41:25 sthen Exp $</span>

<span class="c">## I definately want the vether0 device act as a DNS name server for the virtual network</span>
server:
        interface: 192.168.30.1
        interface: 127.0.0.1
        interface: ::1
        <span class="c">#do-ip6: no</span>

        <span class="c"># override the default "any" address to send queries; if multiple</span>
        <span class="c"># addresses are available, they are used randomly to counter spoofing</span>
        <span class="c">#outgoing-interface: 192.0.2.1</span>
        <span class="c">#outgoing-interface: 2001:db8::53</span>

        access-control: 0.0.0.0/0 refuse
        access-control: 127.0.0.0/8 allow
        access-control: ::0/0 refuse
        access-control: ::1 allow
        access-control: 192.168.1.0/24 allow

        access-control: 192.168.30.0/24 allow <span class="c">## I want the virtual network to be allowed for access</span>
        
        <span class="k">do</span><span class="nt">-not-query-localhost</span>: no

        hide-identity: <span class="nb">yes
        </span>hide-version: <span class="nb">yes</span>

        <span class="c"># Uncomment to enable qname minimisation.</span>
        <span class="c"># https://tools.ietf.org/html/draft-ietf-dnsop-qname-minimisation-08</span>
        <span class="c">#</span>
        <span class="c"># qname-minimisation: yes</span>

        <span class="c"># Uncomment to enable DNSSEC validation.</span>
        <span class="c">#</span>
        <span class="c">#auto-trust-anchor-file: "/var/unbound/db/root.key"</span>

        <span class="c"># Serve zones authoritatively from Unbound to resolver clients.</span>
        <span class="c"># Not for external service.</span>
        <span class="c">#</span>
        <span class="c">#local-zone: "local." static</span>
        <span class="c">#local-data: "mycomputer.local. IN A 192.0.2.51"</span>
        <span class="c">#local-zone: "2.0.192.in-addr.arpa." static</span>
        <span class="c">#local-data-ptr: "192.0.2.51 mycomputer.local"</span>

        <span class="c"># UDP EDNS reassembly buffer advertised to peers. Default 4096.</span>
        <span class="c"># May need lowering on broken networks with fragmentation/MTU issues,</span>
        <span class="c"># particularly if validating DNSSEC.</span>
        <span class="c">#</span>
        <span class="c">#edns-buffer-size: 1480</span>

        <span class="c"># Use TCP for "forward-zone" requests. Useful if you are making</span>
        <span class="c"># DNS requests over an SSH port forwarding.</span>
        <span class="c">#</span>
        <span class="c">#tcp-upstream: yes</span>

        <span class="c"># DNS64 options, synthesizes AAAA records for hosts that don't have</span>
        <span class="c"># them. For use with NAT64 (PF "af-to").</span>
        <span class="c">#</span>
        <span class="c">#module-config: "dns64 validator iterator"</span>
        <span class="c">#dns64-prefix: 64:ff9b::/96     # well-known prefix (default)</span>
        <span class="c">#dns64-synthall: no</span>

remote-control:
        control-enable: <span class="nb">yes
        </span>control-use-cert: no
        control-interface: /var/run/unbound.sock

forward-zone:
        name: <span class="s2">"."</span>
        forward-addr: 192.168.1.1 <span class="c">## Forward the DNS Requests to my local real router</span>
        forward-addr: 74.82.42.42 <span class="c"># he.net</span>
        forward-addr: 2001:470:20::2 <span class="c"># he.net v6</span>
        forward-addr: 8.8.8.8 <span class="c"># google.com</span>
        forward-addr: 2001:4860:4860::8888 <span class="c"># google.com v6</span>
        forward-addr: 208.67.222.222 <span class="c"># opendns.com</span>
        forward-first: <span class="nb">yes</span> <span class="c"># try direct if forwarder fails</span>
</code></pre></div></div>

<p>Now DNS requests from the 192.168.30.0/24 subnet will be answered by the DNS server at 192.168.30.1.</p>

<h3 id="vmd---what-goes-into-etcvmconf">vmd - What goes into /etc/vm.conf</h3>

<p>Now my next task was to create the correct vm configuration, so that each vm would be connected to a local virtual switch managing the virtual network.</p>

<p>~~~~ {.bash .numberLines startFrom=”1”}</p>
<h2 id="etcvmconf">/etc/vm.conf</h2>
<p>files=  /home/user/vm-network/ # our disk files are at the previously created location (change “user” to your username)</p>

<p>vm host-vm { # we want a vm called “host-vm”
        memory 2g #with 2gigs of memory
        disk $files host.drive # running the host.drive
        interface tap { lladdr 00:00:00:00:00:02 switch localnet } # on a network interface with the specified MAC on the localnet switch
}</p>

<p>vm foo-vm {
        memory 2g
        disk $files foo.drive
        interface tap { lladdr 00:00:00:00:00:03 switch localnet }
}</p>

<p>vm bar-vm {
        memory 2g
        disk $files bar.drive
        interface tap { lladdr 00:00:00:00:00:04 switch localnet }
}</p>

<p>switch localnet { # this is the switch called “localnet”
        add vether0 # where the virtual interface is added to
}</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>

So on lines 4, 10 and 16 I configured the specific VMs and on line 22 I configured the virtual switch that the VMs network interfaces are attached to.

Then I enabled `vmd`:

```bash
doas rcctl enable vmd
```

And restarted the server:

```bash
doas reboot
```

### Configuring relayd on the host-vm ###

The last task was the configuration of `relayd` on the host-vm.

For this I logged into the host-vm, which should have been started automatically now at reboot:

```bash
doas vmctl console host-vm
```

Then I configured relayd to redirect requests to my subdomains:

~~~~ {.ini}
# /etc/relayd.conf                                                                                       

## MACROS

host_vm=192.168.30.2
foo_vm=192.168.30.3
bar_vm=192.168.30.4

## TABLES

table &lt;foo_service&gt; { $foo_vm }
table &lt;bar_service&gt; { $bar_vm }

## PROTOCOLS

# define a new http protocol called "reverseproxy"
http protocol "reverseproxy" {
        
		# match a request that has a Host value with "foo.hermes-technology.de"
		# and forward that to the foo_service
		# "quick" means that it will be handled as the last rule if it matches... no other will be processed
        match request quick header "Host" value "foo.hermes-technology.de" \
                forward to &lt;foo_service&gt;

		match request quick header "Host" value "www.hermes-technology.de" \
				forward to &lt;foo_service&gt;
        
        match request quick header "Host" value "bar.hermes-technology.de" \
                forward to &lt;bar_service&gt;
}

## RELAYS

# create a new relay called "proxy"
# relays are for layer 7 (e.g. http)
relay "proxy" {
		# the relay should listen on the host ip on port 80
        listen on $host_vm port 80
        
		# use the protocol "reverseproxy" we defined above
        protocol "reverseproxy"
        
		# forwarding is enabled for the specified services
        forward to &lt;foo_service&gt; port 80
        forward to &lt;bar_service&gt; port 80
}
</code></pre></div></div>

<p>The last task was to enable and start <code class="language-plaintext highlighter-rouge">relayd</code>:</p>

<pre><code class="language-{.bash}">doas rcctl enable relayd
doas rcctl start relayd
</code></pre>

<h2 id="this-does-work-now">This does work now</h2>

<p>Because I bought the domain hermes-technology.de and registered blog.hermes-technology.de as CNAME entries, the following does work:</p>

<ol>
  <li>Enter blog.hermes-technology.de anywhere into a webbrowser.</li>
  <li>The request lands at my main server’s ip (hermes-technology.de).</li>
  <li>PF redirects any http requests to the host-vm on 192.168.30.2.</li>
  <li><code class="language-plaintext highlighter-rouge">relayd</code> on the host-vm redirects the “blog” subdomain request to the ip 192.168.30.3 of the blog-vm.</li>
  <li>The blog-vm and its httpd-service sends the response to its gateway 192.168.30.1</li>
  <li>The response on the vether0 gets a Network Address Translation (NAT) by <code class="language-plaintext highlighter-rouge">pf</code> to the router.</li>
  <li>The router sends the response to the client.</li>
</ol>

<h2 id="outlook">Outlook</h2>

<p>In the next post I will explain how I set up a proper ssh connection to my server with a public key. Which is much safer than using a password. Also I will explain how to configure ssh-tunneling so that you login to your virtual servers from the workstation where you’re maintaining your server from. At last I will explain how I configured <code class="language-plaintext highlighter-rouge">pf</code> to do an ssh protection like <code class="language-plaintext highlighter-rouge">fail2ban</code> does.</p>

  </div>

   
      
      <section id="isso-thread"></section>
      
  

  

</article>

      </div>
    </main>

    <footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">Hermes Technology Blog</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">Hermes Technology Blog</li><li><a class="u-email" href="mailto:mail@hermes-technology.de">mail@hermes-technology.de</a></li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"><li><a href="https://github.com/JanSurft"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">JanSurft</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>This is a blog about technology. I will write about the experiences I encounter, when working on my server infrastructure, building roboter(s), or developing any kind of software on the way.
</p>
      </div>
    </div>

  </div>

</footer>


<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
<script src="/js/toc.js" type="text/javascript" charset="utf-8"></script>
<script type="text/javascript">
   $(document).ready(function() {
      $('#toc').toc({
     listType: 'ul',
   });
    });
</script>
  </body>

</html>
